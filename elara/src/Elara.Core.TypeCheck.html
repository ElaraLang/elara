<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ImpredicativeTypes #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="annot"><span class="hs-comment">{- | Type *checking* for the Core language.
This functions as a sanity check to make sure that any optimisations haven't broken the structure
of the program to form an invalid program

It doesn't do any inference! As Core is already typed, it just checks that the types are consistent
-}</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html"><span class="hs-identifier">Elara.Core.TypeCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.TypeCheck.html#typeCheckCoreModule"><span class="hs-identifier">typeCheckCoreModule</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#TypeCheckError"><span class="hs-identifier">TypeCheckError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Effectful</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Effectful.Error.Static</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Effectful.State.Extra.html"><span class="hs-identifier">Effectful.State.Extra</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Effectful.State.Extra.html#locally"><span class="hs-identifier">locally</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Effectful.State.Extra.html#scoped"><span class="hs-identifier">scoped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Effectful.State.Static.Local</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">State</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">evalState</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">get</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">modify</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.AST.VarRef.html"><span class="hs-identifier">Elara.AST.VarRef</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Core.html"><span class="hs-identifier">Elara.Core</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#CoreExpr"><span class="hs-identifier">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Elara.Core.html#Var"><span class="hs-identifier">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Core.html"><span class="hs-identifier">Elara.Core</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Core</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Core.ANF.html"><span class="hs-identifier">Elara.Core.ANF</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ANF</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Core.Analysis.html"><span class="hs-identifier">Elara.Core.Analysis</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.Analysis.html#freeTypeVars"><span class="hs-identifier">freeTypeVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Core.Generic.html"><span class="hs-identifier">Elara.Core.Generic</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Core.Module.html"><span class="hs-identifier">Elara.Core.Module</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Core.ToANF.html"><span class="hs-identifier">Elara.Core.ToANF</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.ToANF.html#fromANF"><span class="hs-identifier">fromANF</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Elara.Core.ToANF.html#fromANFAtom"><span class="hs-identifier">fromANFAtom</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Elara.Core.ToANF.html#fromANFCExpr"><span class="hs-identifier">fromANFCExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Data.Pretty.html"><span class="hs-identifier">Elara.Data.Pretty</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Error.html"><span class="hs-identifier">Elara.Error</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Error.Codes.html"><span class="hs-identifier">Elara.Error.Codes</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Codes</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Logging.html"><span class="hs-identifier">Elara.Logging</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Logging.html#StructuredDebug"><span class="hs-identifier">StructuredDebug</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Prim.Core.html"><span class="hs-identifier">Elara.Prim.Core</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="TODO.html"><span class="hs-identifier">TODO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="TODO.html#todo"><span class="hs-identifier">todo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-keyword">data</span><span> </span><span id="TypeCheckError"><span class="annot"><a href="Elara.Core.TypeCheck.html#TypeCheckError"><span class="hs-identifier hs-var">TypeCheckError</span></a></span></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="UnknownVariable"><span class="annot"><a href="Elara.Core.TypeCheck.html#UnknownVariable"><span class="hs-identifier hs-var">UnknownVariable</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unknownVariable"><span class="annot"><span class="annottext">TypeCheckError -&gt; Var
</span><a href="Elara.Core.TypeCheck.html#unknownVariable"><span class="hs-identifier hs-var hs-var">unknownVariable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">,</span><span> </span><span id="unknownVariableScope"><span class="annot"><span class="annottext">TypeCheckError -&gt; Set (UnlocatedVarRef Text)
</span><a href="Elara.Core.TypeCheck.html#unknownVariableScope"><span class="hs-identifier hs-var hs-var">unknownVariableScope</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.AST.VarRef.html#UnlocatedVarRef"><span class="hs-identifier hs-type">UnlocatedVarRef</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="CoreTypeMismatch"><span class="annot"><a href="Elara.Core.TypeCheck.html#CoreTypeMismatch"><span class="hs-identifier hs-var">CoreTypeMismatch</span></a></span></span><span>
</span><span id="line-34"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="expected"><span class="annot"><span class="annottext">TypeCheckError -&gt; Type
</span><a href="Elara.Core.TypeCheck.html#expected"><span class="hs-identifier hs-var hs-var">expected</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span><span>
</span><span id="line-35"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="actual"><span class="annot"><span class="annottext">TypeCheckError -&gt; Type
</span><a href="Elara.Core.TypeCheck.html#actual"><span class="hs-identifier hs-var hs-var">actual</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span><span>
</span><span id="line-36"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="source"><span class="annot"><span class="annottext">TypeCheckError -&gt; (CoreExpr, CoreExpr)
</span><a href="Elara.Core.TypeCheck.html#source"><span class="hs-identifier hs-var hs-var">source</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Elara.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="errorCallStack"><span class="annot"><span class="annottext">TypeCheckError -&gt; CallStack
</span><a href="Elara.Core.TypeCheck.html#errorCallStack"><span class="hs-identifier hs-var hs-var">errorCallStack</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CallStack</span></span><span>
</span><span id="line-38"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="CoreTypeMismatchIncompleteExpected"><span class="annot"><a href="Elara.Core.TypeCheck.html#CoreTypeMismatchIncompleteExpected"><span class="hs-identifier hs-var">CoreTypeMismatchIncompleteExpected</span></a></span></span><span>
</span><span id="line-40"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="incompleteExpected"><span class="annot"><span class="annottext">TypeCheckError -&gt; Text
</span><a href="Elara.Core.TypeCheck.html#incompleteExpected"><span class="hs-identifier hs-var hs-var">incompleteExpected</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-41"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="actual"><span class="annot"><a href="Elara.Core.TypeCheck.html#actual"><span class="hs-identifier hs-var">actual</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span><span>
</span><span id="line-42"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="source"><span class="annot"><a href="Elara.Core.TypeCheck.html#source"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Elara.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="UnificationError"><span class="annot"><a href="Elara.Core.TypeCheck.html#UnificationError"><span class="hs-identifier hs-var">UnificationError</span></a></span></span><span> </span><span class="annot"><a href="Elara.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="annot"><a href="Elara.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InfiniteType"><span class="annot"><a href="Elara.Core.TypeCheck.html#InfiniteType"><span class="hs-identifier hs-var">InfiniteType</span></a></span></span><span> </span><span class="annot"><a href="Elara.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><a href="Elara.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="OccursCheck"><span class="annot"><a href="Elara.Core.TypeCheck.html#OccursCheck"><span class="hs-identifier hs-var">OccursCheck</span></a></span></span><span> </span><span class="annot"><a href="Elara.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><a href="Elara.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="PatternMatchMissingBinders"><span class="annot"><a href="Elara.Core.TypeCheck.html#PatternMatchMissingBinders"><span class="hs-identifier hs-var">PatternMatchMissingBinders</span></a></span></span><span> </span><span class="hs-special">{</span><span id="alt"><span class="annot"><span class="annottext">TypeCheckError -&gt; AltCon
</span><a href="Elara.Core.TypeCheck.html#alt"><span class="hs-identifier hs-var hs-var">alt</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Core.html#AltCon"><span class="hs-identifier hs-type">Core.AltCon</span></a></span><span class="hs-special">,</span><span> </span><span id="altType"><span class="annot"><span class="annottext">TypeCheckError -&gt; Type
</span><a href="Elara.Core.TypeCheck.html#altType"><span class="hs-identifier hs-var hs-var">altType</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span><span class="hs-special">,</span><span> </span><span id="providedBinders"><span class="annot"><span class="annottext">TypeCheckError -&gt; [Var]
</span><a href="Elara.Core.TypeCheck.html#providedBinders"><span class="hs-identifier hs-var hs-var">providedBinders</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Elara.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span id="expr"><span class="annot"><span class="annottext">TypeCheckError -&gt; CoreExpr
</span><a href="Elara.Core.TypeCheck.html#expr"><span class="hs-identifier hs-var hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680154174"><span id="local-6989586621680154240"><span id="local-6989586621680154244"><span class="annot"><span class="annottext">Int -&gt; TypeCheckError -&gt; ShowS
[TypeCheckError] -&gt; ShowS
TypeCheckError -&gt; String
(Int -&gt; TypeCheckError -&gt; ShowS)
-&gt; (TypeCheckError -&gt; String)
-&gt; ([TypeCheckError] -&gt; ShowS)
-&gt; Show TypeCheckError
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; TypeCheckError -&gt; ShowS
showsPrec :: Int -&gt; TypeCheckError -&gt; ShowS
$cshow :: TypeCheckError -&gt; String
show :: TypeCheckError -&gt; String
$cshowList :: [TypeCheckError] -&gt; ShowS
showList :: [TypeCheckError] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680154258"><span id="local-6989586621680154260"><span class="annot"><span class="annottext">(forall x. TypeCheckError -&gt; Rep TypeCheckError x)
-&gt; (forall x. Rep TypeCheckError x -&gt; TypeCheckError)
-&gt; Generic TypeCheckError
forall x. Rep TypeCheckError x -&gt; TypeCheckError
forall x. TypeCheckError -&gt; Rep TypeCheckError x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cfrom :: forall x. TypeCheckError -&gt; Rep TypeCheckError x
from :: forall x. TypeCheckError -&gt; Rep TypeCheckError x
$cto :: forall x. Rep TypeCheckError x -&gt; TypeCheckError
to :: forall x. Rep TypeCheckError x -&gt; TypeCheckError
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680154266"><span class="annot"><a href="Elara.Data.Pretty.html#Pretty"><span class="hs-identifier hs-type">Pretty</span></a></span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#TypeCheckError"><span class="hs-identifier hs-type">TypeCheckError</span></a></span></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680154434"><span id="local-6989586621680154438"><span class="annot"><a href="Elara.Error.html#ReportableError"><span class="hs-identifier hs-type">ReportableError</span></a></span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#TypeCheckError"><span class="hs-identifier hs-type">TypeCheckError</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-53"></span><span>    </span><span id="local-6989586621680154444"><span class="annot"><span class="annottext">errorCode :: TypeCheckError -&gt; Maybe ErrorCode
</span><a href="#local-6989586621680154444"><span class="hs-identifier hs-var hs-var hs-var">errorCode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-54"></span><span>        </span><span class="annot"><a href="Elara.Core.TypeCheck.html#UnknownVariable"><span class="hs-identifier hs-type">UnknownVariable</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; Maybe ErrorCode
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Doc ann
ErrorCode
</span><a href="Elara.Error.Codes.html#unknownVariableTC"><span class="hs-identifier hs-var">Codes.unknownVariableTC</span></a></span><span>
</span><span id="line-55"></span><span>        </span><span class="annot"><a href="Elara.Core.TypeCheck.html#CoreTypeMismatch"><span class="hs-identifier hs-type">CoreTypeMismatch</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; Maybe ErrorCode
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Doc ann
ErrorCode
</span><a href="Elara.Error.Codes.html#coreTypeMismatch"><span class="hs-identifier hs-var">Codes.coreTypeMismatch</span></a></span><span>
</span><span id="line-56"></span><span>        </span><span class="annot"><span class="annottext">TypeCheckError
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Elara.Error.Codes.html#ErrorCode"><span class="hs-identifier hs-type">Codes.ErrorCode</span></a></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-keyword">newtype</span><span> </span><span id="TcState"><span class="annot"><a href="Elara.Core.TypeCheck.html#TcState"><span class="hs-identifier hs-var">TcState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TcState"><span class="annot"><a href="Elara.Core.TypeCheck.html#TcState"><span class="hs-identifier hs-var">TcState</span></a></span></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="scope"><span class="annot"><span class="annottext">TcState -&gt; Set (UnlocatedVarRef Text)
</span><a href="Elara.Core.TypeCheck.html#scope"><span class="hs-identifier hs-var hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.AST.VarRef.html#UnlocatedVarRef"><span class="hs-identifier hs-type">UnlocatedVarRef</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><span class="hs-comment">{- ^ The 'Var' already holds the variable's type so we don't need to track that.
    However we do need to track scoping, as an optimisation could pull a variable out of scope
    -}</span></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#addToScope"><span class="hs-identifier hs-type">addToScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#TcState"><span class="hs-identifier hs-type">TcState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#TcState"><span class="hs-identifier hs-type">TcState</span></a></span><span>
</span><span id="line-66"></span><span id="addToScope"><span class="annot"><span class="annottext">addToScope :: Var -&gt; TcState -&gt; TcState
</span><a href="Elara.Core.TypeCheck.html#addToScope"><span class="hs-identifier hs-var hs-var">addToScope</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span id="local-6989586621680154462"><span class="annot"><span class="annottext">UnlocatedVarRef Text
</span><a href="#local-6989586621680154462"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe DataCon
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680154463"><span class="annot"><span class="annottext">TcState
</span><a href="#local-6989586621680154463"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcState
</span><a href="#local-6989586621680154463"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">{</span><span class="annot"><a href="Elara.Core.TypeCheck.html#scope"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set.insert</span></span><span> </span><span class="annot"><a href="#local-6989586621680154462"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.TypeCheck.html#scope"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154463"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><span id="line-67"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#addToScope"><span class="hs-identifier hs-var">addToScope</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680154465"><span class="annot"><span class="annottext">TcState
</span><a href="#local-6989586621680154465"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcState
</span><a href="#local-6989586621680154465"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#isInScope"><span class="hs-identifier hs-type">isInScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#TcState"><span class="hs-identifier hs-type">TcState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-70"></span><span id="isInScope"><span class="annot"><span class="annottext">isInScope :: Var -&gt; TcState -&gt; Bool
</span><a href="Elara.Core.TypeCheck.html#isInScope"><span class="hs-identifier hs-var hs-var">isInScope</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span id="local-6989586621680154473"><span class="annot"><span class="annottext">name :: UnlocatedVarRef Text
</span><a href="#local-6989586621680154473"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Elara.AST.VarRef.html#Local"><span class="hs-identifier hs-type">Local</span></a></span><span> </span><span class="annot"><span class="annottext">VarRefImpl UnlocatedVarRefKind (Unique Text)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe DataCon
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680154475"><span class="annot"><span class="annottext">TcState
</span><a href="#local-6989586621680154475"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnlocatedVarRef Text -&gt; Set (UnlocatedVarRef Text) -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">UnlocatedVarRef Text
</span><a href="#local-6989586621680154473"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcState -&gt; Set (UnlocatedVarRef Text)
</span><a href="Elara.Core.TypeCheck.html#scope"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">TcState
</span><a href="#local-6989586621680154475"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#isInScope"><span class="hs-identifier hs-var">isInScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.AST.VarRef.html#Global"><span class="hs-identifier hs-type">Global</span></a></span><span> </span><span class="annot"><span class="annottext">VarRefImpl UnlocatedVarRefKind (Qualified Text)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe DataCon
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- Global vars are always in scope</span><span>
</span><span id="line-72"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#isInScope"><span class="hs-identifier hs-var">isInScope</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TcState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span id="local-6989586621680154058"><span class="annot"><a href="Elara.Core.TypeCheck.html#typeCheckCoreModule"><span class="hs-identifier hs-type">typeCheckCoreModule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Error</span></span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#TypeCheckError"><span class="hs-identifier hs-type">TypeCheckError</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680154058"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Elara.Logging.html#StructuredDebug"><span class="hs-identifier hs-type">StructuredDebug</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680154058"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Elara.Core.Module.html#CoreModule"><span class="hs-identifier hs-type">CoreModule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.Generic.html#Bind"><span class="hs-identifier hs-type">Bind</span></a></span><span> </span><span class="annot"><a href="Elara.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><a href="Elara.Core.ANF.html#Expr"><span class="hs-identifier hs-type">ANF.Expr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680154058"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-75"></span><span id="typeCheckCoreModule"><span class="annot"><span class="annottext">typeCheckCoreModule :: forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, HasCallStack, StructuredDebug :&gt; r) =&gt;
CoreModule (Bind Var Expr) -&gt; Eff r ()
</span><a href="Elara.Core.TypeCheck.html#typeCheckCoreModule"><span class="hs-identifier hs-var hs-var">typeCheckCoreModule</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.Module.html#CoreModule"><span class="hs-identifier hs-type">CoreModule</span></a></span><span> </span><span id="local-6989586621680154520"><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621680154520"><span class="hs-identifier hs-var">_moduleName</span></a></span></span><span> </span><span id="local-6989586621680154521"><span class="annot"><span class="annottext">[CoreDeclaration (Bind Var Expr)]
</span><a href="#local-6989586621680154521"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680154530"><span class="annot"><span class="annottext">initialState :: TcState
</span><a href="#local-6989586621680154530"><span class="hs-identifier hs-var hs-var hs-var">initialState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#TcState"><span class="hs-identifier hs-type">TcState</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">scope :: Set (UnlocatedVarRef Text)
</span><a href="Elara.Core.TypeCheck.html#scope"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set (UnlocatedVarRef Text)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">}</span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span>    </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcState -&gt; Eff (State TcState : r) () -&gt; Eff r ()
forall s (es :: [Effect]) a.
HasCallStack =&gt;
s -&gt; Eff (State s : es) a -&gt; Eff es a
</span><span class="hs-identifier hs-var">evalState</span></span><span> </span><span class="annot"><span class="annottext">TcState
</span><a href="#local-6989586621680154530"><span class="hs-identifier hs-var">initialState</span></a></span><span> </span><span class="annot"><span class="annottext">(Eff (State TcState : r) () -&gt; Eff r ())
-&gt; Eff (State TcState : r) () -&gt; Eff r ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[CoreDeclaration (Bind Var Expr)]
-&gt; (CoreDeclaration (Bind Var Expr) -&gt; Eff (State TcState : r) ())
-&gt; Eff (State TcState : r) ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">[CoreDeclaration (Bind Var Expr)]
</span><a href="#local-6989586621680154521"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">((CoreDeclaration (Bind Var Expr) -&gt; Eff (State TcState : r) ())
 -&gt; Eff (State TcState : r) ())
-&gt; (CoreDeclaration (Bind Var Expr) -&gt; Eff (State TcState : r) ())
-&gt; Eff (State TcState : r) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-79"></span><span>        </span><span class="annot"><a href="Elara.Core.Module.html#CoreValue"><span class="hs-identifier hs-type">CoreValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.Generic.html#NonRecursive"><span class="hs-identifier hs-type">NonRecursive</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680154534"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154534"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680154535"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621680154535"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Eff (State TcState : r) () -&gt; Eff (State TcState : r) ()
forall s (r :: [Effect]) a. (State s :&gt; r) =&gt; Eff r a -&gt; Eff r a
</span><a href="Effectful.State.Extra.html#scoped"><span class="hs-identifier hs-var">scoped</span></a></span><span> </span><span class="annot"><span class="annottext">(Eff (State TcState : r) () -&gt; Eff (State TcState : r) ())
-&gt; Eff (State TcState : r) () -&gt; Eff (State TcState : r) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-80"></span><span>            </span><span class="annot"><span class="annottext">(TcState -&gt; TcState) -&gt; Eff (State TcState : r) ()
forall s (es :: [Effect]).
(HasCallStack, State s :&gt; es) =&gt;
(s -&gt; s) -&gt; Eff es ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; TcState -&gt; TcState
</span><a href="Elara.Core.TypeCheck.html#addToScope"><span class="hs-identifier hs-var">addToScope</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154534"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>            </span><span class="annot"><span class="annottext">Expr Var -&gt; Eff (State TcState : r) Type
forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
Expr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621680154535"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-82"></span><span>            </span><span class="annot"><span class="annottext">Eff (State TcState : r) ()
forall (f :: * -&gt; *). Applicative f =&gt; f ()
</span><span class="hs-identifier hs-var">pass</span></span><span>
</span><span id="line-83"></span><span>        </span><span class="annot"><a href="Elara.Core.Module.html#CoreValue"><span class="hs-identifier hs-type">CoreValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.Generic.html#Recursive"><span class="hs-identifier hs-type">Recursive</span></a></span><span> </span><span id="local-6989586621680154539"><span class="annot"><span class="annottext">[(Var, Expr Var)]
</span><a href="#local-6989586621680154539"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Eff (State TcState : r) () -&gt; Eff (State TcState : r) ()
forall s (r :: [Effect]) a. (State s :&gt; r) =&gt; Eff r a -&gt; Eff r a
</span><a href="Effectful.State.Extra.html#scoped"><span class="hs-identifier hs-var">scoped</span></a></span><span> </span><span class="annot"><span class="annottext">(Eff (State TcState : r) () -&gt; Eff (State TcState : r) ())
-&gt; Eff (State TcState : r) () -&gt; Eff (State TcState : r) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-84"></span><span>            </span><span class="annot"><span class="annottext">[(Var, Expr Var)]
-&gt; ((Var, Expr Var) -&gt; Eff (State TcState : r) ())
-&gt; Eff (State TcState : r) ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">[(Var, Expr Var)]
</span><a href="#local-6989586621680154539"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">(((Var, Expr Var) -&gt; Eff (State TcState : r) ())
 -&gt; Eff (State TcState : r) ())
-&gt; ((Var, Expr Var) -&gt; Eff (State TcState : r) ())
-&gt; Eff (State TcState : r) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680154540"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154540"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680154541"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621680154541"><span class="hs-identifier hs-var">_e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-85"></span><span>                </span><span class="annot"><span class="annottext">(TcState -&gt; TcState) -&gt; Eff (State TcState : r) ()
forall s (es :: [Effect]).
(HasCallStack, State s :&gt; es) =&gt;
(s -&gt; s) -&gt; Eff es ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; TcState -&gt; TcState
</span><a href="Elara.Core.TypeCheck.html#addToScope"><span class="hs-identifier hs-var">addToScope</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154540"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span>            </span><span class="annot"><span class="annottext">[(Var, Expr Var)]
-&gt; ((Var, Expr Var) -&gt; Eff (State TcState : r) Type)
-&gt; Eff (State TcState : r) ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">[(Var, Expr Var)]
</span><a href="#local-6989586621680154539"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">(((Var, Expr Var) -&gt; Eff (State TcState : r) Type)
 -&gt; Eff (State TcState : r) ())
-&gt; ((Var, Expr Var) -&gt; Eff (State TcState : r) Type)
-&gt; Eff (State TcState : r) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680154542"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154542"><span class="hs-identifier hs-var">_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680154543"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621680154543"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Expr Var -&gt; Eff (State TcState : r) Type
forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
Expr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621680154543"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-88"></span><span>        </span><span class="annot"><a href="Elara.Core.Module.html#CoreType"><span class="hs-identifier hs-type">CoreType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTypeDecl
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Eff (State TcState : r) ()
forall (f :: * -&gt; *). Applicative f =&gt; f ()
</span><span class="hs-identifier hs-var">pass</span></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pass</span></span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#varType"><span class="hs-identifier hs-type">varType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span><span>
</span><span id="line-93"></span><span id="varType"><span class="annot"><span class="annottext">varType :: Var -&gt; Type
</span><a href="Elara.Core.TypeCheck.html#varType"><span class="hs-identifier hs-var hs-var">varType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TypeVariable
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Type
forall a t. (HasCallStack, IsText t) =&gt; t -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;TyVar&quot;</span></span><span>
</span><span id="line-94"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="annot"><span class="annottext">UnlocatedVarRef Text
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680154556"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154556"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe DataCon
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154556"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span id="local-6989586621680154093"><span class="annot"><a href="Elara.Core.TypeCheck.html#typeCheck"><span class="hs-identifier hs-type">typeCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Error</span></span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#TypeCheckError"><span class="hs-identifier hs-type">TypeCheckError</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680154093"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#TcState"><span class="hs-identifier hs-type">TcState</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680154093"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Elara.Logging.html#StructuredDebug"><span class="hs-identifier hs-type">StructuredDebug</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680154093"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Elara.Core.ANF.html#Expr"><span class="hs-identifier hs-type">ANF.Expr</span></a></span><span> </span><span class="annot"><a href="Elara.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680154093"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span></span><span>
</span><span id="line-97"></span><span id="typeCheck"><span class="annot"><span class="annottext">typeCheck :: forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
Expr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheck"><span class="hs-identifier hs-var hs-var">typeCheck</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.ANF.html#Let"><span class="hs-identifier hs-type">ANF.Let</span></a></span><span> </span><span id="local-6989586621680154605"><span class="annot"><span class="annottext">Bind Var
</span><a href="#local-6989586621680154605"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621680154606"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621680154606"><span class="hs-identifier hs-var">in'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Bind Var
</span><a href="#local-6989586621680154605"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><a href="Elara.Core.Generic.html#NonRecursive"><span class="hs-identifier hs-type">NonRecursive</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680154607"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154607"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680154608"><span class="annot"><span class="annottext">CExpr Var
</span><a href="#local-6989586621680154608"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-99"></span><span>        </span><span class="annot"><span class="annottext">CExpr Var -&gt; Eff r Type
forall (r :: [Effect]).
(HasCallStack, Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
CExpr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheckC"><span class="hs-identifier hs-var">typeCheckC</span></a></span><span> </span><span class="annot"><span class="annottext">CExpr Var
</span><a href="#local-6989586621680154608"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><span class="annottext">(TcState -&gt; TcState) -&gt; Eff r Type -&gt; Eff r Type
forall s (r :: [Effect]) a.
(State s :&gt; r) =&gt;
(s -&gt; s) -&gt; Eff r a -&gt; Eff r a
</span><a href="Effectful.State.Extra.html#locally"><span class="hs-identifier hs-var">locally</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; TcState -&gt; TcState
</span><a href="Elara.Core.TypeCheck.html#addToScope"><span class="hs-identifier hs-var">addToScope</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154607"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Eff r Type -&gt; Eff r Type) -&gt; Eff r Type -&gt; Eff r Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-101"></span><span>            </span><span class="annot"><span class="annottext">Expr Var -&gt; Eff r Type
forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
Expr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621680154606"><span class="hs-identifier hs-var">in'</span></a></span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><a href="Elara.Core.Generic.html#Recursive"><span class="hs-identifier hs-type">Recursive</span></a></span><span> </span><span id="local-6989586621680154610"><span class="annot"><span class="annottext">[(Var, CExpr Var)]
</span><a href="#local-6989586621680154610"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Eff r Type -&gt; Eff r Type
forall s (r :: [Effect]) a. (State s :&gt; r) =&gt; Eff r a -&gt; Eff r a
</span><a href="Effectful.State.Extra.html#scoped"><span class="hs-identifier hs-var">scoped</span></a></span><span> </span><span class="annot"><span class="annottext">(Eff r Type -&gt; Eff r Type) -&gt; Eff r Type -&gt; Eff r Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-103"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680154611"><span class="annot"><span class="annottext">vars :: [Var]
</span><a href="#local-6989586621680154611"><span class="hs-identifier hs-var hs-var hs-var">vars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Var, CExpr Var) -&gt; Var) -&gt; [(Var, CExpr Var)] -&gt; [Var]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Var, CExpr Var) -&gt; Var
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Var, CExpr Var)]
</span><a href="#local-6989586621680154610"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-104"></span><span>        </span><span class="annot"><span class="annottext">[Var] -&gt; (Var -&gt; Eff r ()) -&gt; Eff r ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621680154611"><span class="hs-identifier hs-var">vars</span></a></span><span> </span><span class="annot"><span class="annottext">((Var -&gt; Eff r ()) -&gt; Eff r ()) -&gt; (Var -&gt; Eff r ()) -&gt; Eff r ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680154613"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154613"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TcState -&gt; TcState) -&gt; Eff r ()
forall s (es :: [Effect]).
(HasCallStack, State s :&gt; es) =&gt;
(s -&gt; s) -&gt; Eff es ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; TcState -&gt; TcState
</span><a href="Elara.Core.TypeCheck.html#addToScope"><span class="hs-identifier hs-var">addToScope</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154613"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>        </span><span class="annot"><span class="annottext">[(Var, CExpr Var)] -&gt; ((Var, CExpr Var) -&gt; Eff r Type) -&gt; Eff r ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">[(Var, CExpr Var)]
</span><a href="#local-6989586621680154610"><span class="hs-identifier hs-var">binds</span></a></span><span> </span><span class="annot"><span class="annottext">(((Var, CExpr Var) -&gt; Eff r Type) -&gt; Eff r ())
-&gt; ((Var, CExpr Var) -&gt; Eff r Type) -&gt; Eff r ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680154614"><span class="annot"><span class="annottext">CExpr Var
</span><a href="#local-6989586621680154614"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CExpr Var -&gt; Eff r Type
forall (r :: [Effect]).
(HasCallStack, Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
CExpr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheckC"><span class="hs-identifier hs-var">typeCheckC</span></a></span><span> </span><span class="annot"><span class="annottext">CExpr Var
</span><a href="#local-6989586621680154614"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-106"></span><span>        </span><span class="annot"><span class="annottext">Expr Var -&gt; Eff r Type
forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
Expr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621680154606"><span class="hs-identifier hs-var">in'</span></a></span><span>
</span><span id="line-107"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.ANF.html#CExpr"><span class="hs-identifier hs-type">ANF.CExpr</span></a></span><span> </span><span id="local-6989586621680154616"><span class="annot"><span class="annottext">CExpr Var
</span><a href="#local-6989586621680154616"><span class="hs-identifier hs-var">cExp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CExpr Var -&gt; Eff r Type
forall (r :: [Effect]).
(HasCallStack, Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
CExpr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheckC"><span class="hs-identifier hs-var">typeCheckC</span></a></span><span> </span><span class="annot"><span class="annottext">CExpr Var
</span><a href="#local-6989586621680154616"><span class="hs-identifier hs-var">cExp</span></a></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span id="local-6989586621680154105"><span class="annot"><a href="Elara.Core.TypeCheck.html#typeCheckC"><span class="hs-identifier hs-type">typeCheckC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Error</span></span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#TypeCheckError"><span class="hs-identifier hs-type">TypeCheckError</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680154105"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#TcState"><span class="hs-identifier hs-type">TcState</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680154105"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Elara.Logging.html#StructuredDebug"><span class="hs-identifier hs-type">StructuredDebug</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680154105"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Elara.Core.ANF.html#CExpr"><span class="hs-identifier hs-type">ANF.CExpr</span></a></span><span> </span><span class="annot"><a href="Elara.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680154105"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span></span><span>
</span><span id="line-110"></span><span id="typeCheckC"><span class="annot"><span class="annottext">typeCheckC :: forall (r :: [Effect]).
(HasCallStack, Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
CExpr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheckC"><span class="hs-identifier hs-var hs-var">typeCheckC</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.ANF.html#App"><span class="hs-identifier hs-type">ANF.App</span></a></span><span> </span><span id="local-6989586621680154732"><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154732"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621680154733"><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154733"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-111"></span><span>    </span><span id="local-6989586621680154734"><span class="annot"><a href="#local-6989586621680154734"><span class="hs-identifier hs-var">fType</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AExpr Var -&gt; Eff r Type
forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
AExpr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheckA"><span class="hs-identifier hs-var">typeCheckA</span></a></span><span> </span><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154732"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-comment">-- debug $ &quot;fType: &quot; &lt;&gt; pretty fType</span><span>
</span><span id="line-113"></span><span>    </span><span id="local-6989586621680154736"><span class="annot"><a href="#local-6989586621680154736"><span class="hs-identifier hs-var">xType</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#typeCheckA"><span class="hs-identifier hs-type">typeCheckA</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154733"><span class="hs-identifier hs-type">x</span></a></span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-comment">-- debug $ &quot;xType: &quot; &lt;&gt; pretty xType</span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680154734"><span class="hs-identifier hs-type">fType</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-116"></span><span>        </span><span class="annot"><a href="Elara.Core.html#FuncTy"><span class="hs-identifier hs-type">Core.FuncTy</span></a></span><span> </span><span id="local-6989586621680154738"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154738"><span class="hs-identifier hs-var">argType</span></a></span></span><span> </span><span id="local-6989586621680154739"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154739"><span class="hs-identifier hs-var">retType</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-117"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Elara.Core.TypeCheck.html#generalize"><span class="hs-identifier hs-var">generalize</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154738"><span class="hs-identifier hs-var">argType</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="Elara.Core.TypeCheck.html#equalUnderSubst"><span class="hs-operator hs-var">`equalUnderSubst`</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Elara.Core.TypeCheck.html#generalize"><span class="hs-identifier hs-var">generalize</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154736"><span class="hs-identifier hs-var">xType</span></a></span><span>
</span><span id="line-118"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Eff r Type
forall a. a -&gt; Eff r a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154739"><span class="hs-identifier hs-var">retType</span></a></span><span>
</span><span id="line-119"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TypeCheckError -&gt; Eff r Type
forall e (es :: [Effect]) a.
(HasCallStack, Error e :&gt; es, Show e) =&gt;
e -&gt; Eff es a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(TypeCheckError -&gt; Eff r Type) -&gt; TypeCheckError -&gt; Eff r Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; (CoreExpr, CoreExpr) -&gt; CallStack -&gt; TypeCheckError
</span><a href="Elara.Core.TypeCheck.html#CoreTypeMismatch"><span class="hs-identifier hs-var">CoreTypeMismatch</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154738"><span class="hs-identifier hs-var">argType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154736"><span class="hs-identifier hs-var">xType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AExpr Var -&gt; CoreExpr
</span><a href="Elara.Core.ToANF.html#fromANFAtom"><span class="hs-identifier hs-var">fromANFAtom</span></a></span><span> </span><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154732"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AExpr Var -&gt; CoreExpr
</span><a href="Elara.Core.ToANF.html#fromANFAtom"><span class="hs-identifier hs-var">fromANFAtom</span></a></span><span> </span><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154733"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CallStack
HasCallStack =&gt; CallStack
</span><span class="hs-identifier hs-var">callStack</span></span><span>
</span><span id="line-120"></span><span>        </span><span id="local-6989586621680154744"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154744"><span class="hs-identifier hs-var">other</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypeCheckError -&gt; Eff r Type
forall e (es :: [Effect]) a.
(HasCallStack, Error e :&gt; es, Show e) =&gt;
e -&gt; Eff es a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(TypeCheckError -&gt; Eff r Type) -&gt; TypeCheckError -&gt; Eff r Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Type -&gt; (CoreExpr, CoreExpr) -&gt; TypeCheckError
</span><a href="Elara.Core.TypeCheck.html#CoreTypeMismatchIncompleteExpected"><span class="hs-identifier hs-var">CoreTypeMismatchIncompleteExpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Doc AnsiStyle -&gt; Text
forall a. Pretty a =&gt; a -&gt; Text
</span><a href="Elara.Data.Pretty.html#prettyToText"><span class="hs-identifier hs-var">prettyToText</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc AnsiStyle -&gt; Text) -&gt; Doc AnsiStyle -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Doc AnsiStyle
forall a. Pretty a =&gt; a -&gt; Doc AnsiStyle
</span><a href="Elara.Data.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154736"><span class="hs-identifier hs-var">xType</span></a></span><span> </span><span class="annot"><span class="annottext">Doc AnsiStyle -&gt; Doc AnsiStyle -&gt; Doc AnsiStyle
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc AnsiStyle
</span><span class="hs-string">&quot;-&gt; something&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154744"><span class="hs-identifier hs-var">other</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AExpr Var -&gt; CoreExpr
</span><a href="Elara.Core.ToANF.html#fromANFAtom"><span class="hs-identifier hs-var">fromANFAtom</span></a></span><span> </span><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154732"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AExpr Var -&gt; CoreExpr
</span><a href="Elara.Core.ToANF.html#fromANFAtom"><span class="hs-identifier hs-var">fromANFAtom</span></a></span><span> </span><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154733"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#typeCheckC"><span class="hs-identifier hs-var">typeCheckC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.ANF.html#AExpr"><span class="hs-identifier hs-type">ANF.AExpr</span></a></span><span> </span><span id="local-6989586621680154749"><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154749"><span class="hs-identifier hs-var">aExp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AExpr Var -&gt; Eff r Type
forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
AExpr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheckA"><span class="hs-identifier hs-var">typeCheckA</span></a></span><span> </span><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154749"><span class="hs-identifier hs-var">aExp</span></a></span><span>
</span><span id="line-122"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#typeCheckC"><span class="hs-identifier hs-var">typeCheckC</span></a></span><span> </span><span id="local-6989586621680154750"><span class="annot"><span class="annottext">match :: CExpr Var
</span><a href="#local-6989586621680154750"><span class="hs-identifier hs-var">match</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.ANF.html#Match"><span class="hs-identifier hs-type">ANF.Match</span></a></span><span> </span><span id="local-6989586621680154752"><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154752"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621680154753"><span class="annot"><span class="annottext">Maybe Var
</span><a href="#local-6989586621680154753"><span class="hs-identifier hs-var">of'</span></a></span></span><span> </span><span id="local-6989586621680154754"><span class="annot"><span class="annottext">[Alt Var]
</span><a href="#local-6989586621680154754"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Eff r Type -&gt; Eff r Type
forall s (r :: [Effect]) a. (State s :&gt; r) =&gt; Eff r a -&gt; Eff r a
</span><a href="Effectful.State.Extra.html#scoped"><span class="hs-identifier hs-var">scoped</span></a></span><span> </span><span class="annot"><span class="annottext">(Eff r Type -&gt; Eff r Type) -&gt; Eff r Type -&gt; Eff r Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-123"></span><span>    </span><span id="local-6989586621680154755"><span class="annot"><a href="#local-6989586621680154755"><span class="hs-identifier hs-var">eType</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AExpr Var -&gt; Eff r Type
forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
AExpr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheckA"><span class="hs-identifier hs-var">typeCheckA</span></a></span><span> </span><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154752"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">whenJust</span></span><span> </span><span class="annot"><a href="#local-6989586621680154753"><span class="hs-identifier hs-type">of'</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680154757"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154757"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TcState -&gt; TcState) -&gt; Eff r ()
forall s (es :: [Effect]).
(HasCallStack, State s :&gt; es) =&gt;
(s -&gt; s) -&gt; Eff es ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; TcState -&gt; TcState
</span><a href="Elara.Core.TypeCheck.html#addToScope"><span class="hs-identifier hs-var">addToScope</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154757"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>    </span><span id="local-6989586621680154758"><span class="annot"><a href="#local-6989586621680154758"><span class="hs-identifier hs-var">altTypes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">for</span></span><span> </span><span class="annot"><a href="#local-6989586621680154754"><span class="hs-identifier hs-type">alts</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680154760"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621680154760"><span class="hs-identifier hs-var">con</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680154761"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621680154761"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680154762"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621680154762"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-126"></span><span>        </span><span class="annot"><span class="annottext">[Var] -&gt; (Var -&gt; Eff r ()) -&gt; Eff r ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621680154761"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">((Var -&gt; Eff r ()) -&gt; Eff r ()) -&gt; (Var -&gt; Eff r ()) -&gt; Eff r ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680154763"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154763"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TcState -&gt; TcState) -&gt; Eff r ()
forall s (es :: [Effect]).
(HasCallStack, State s :&gt; es) =&gt;
(s -&gt; s) -&gt; Eff es ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; TcState -&gt; TcState
</span><a href="Elara.Core.TypeCheck.html#addToScope"><span class="hs-identifier hs-var">addToScope</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154763"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621680154760"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-128"></span><span>            </span><span class="annot"><span class="annottext">AltCon
</span><a href="Elara.Core.html#DEFAULT"><span class="hs-identifier hs-var">Core.DEFAULT</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-129"></span><span>                </span><span class="annot"><span class="annottext">Expr Var -&gt; Eff r Type
forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
Expr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621680154762"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-130"></span><span>            </span><span class="annot"><a href="Elara.Core.html#LitAlt"><span class="hs-identifier hs-type">Core.LitAlt</span></a></span><span> </span><span id="local-6989586621680154766"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621680154766"><span class="hs-identifier hs-var">lit</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-131"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680154767"><span class="annot"><span class="annottext">litType :: Type
</span><a href="#local-6989586621680154767"><span class="hs-identifier hs-var hs-var hs-var">litType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Type
</span><a href="Elara.Core.TypeCheck.html#typeCheckLit"><span class="hs-identifier hs-var">typeCheckLit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621680154766"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-132"></span><span>                </span><span id="local-6989586621680154769"><span class="annot"><a href="#local-6989586621680154769"><span class="hs-identifier hs-var">eType'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Var -&gt; Eff r Type
forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
Expr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621680154762"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-133"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621680154767"><span class="hs-identifier hs-type">litType</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><a href="#local-6989586621680154755"><span class="hs-identifier hs-type">eType</span></a></span><span>
</span><span id="line-134"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621680154769"><span class="hs-identifier hs-type">eType'</span></a></span><span>
</span><span id="line-135"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">throwError</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#CoreTypeMismatch"><span class="hs-identifier hs-type">CoreTypeMismatch</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154767"><span class="hs-identifier hs-type">litType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154755"><span class="hs-identifier hs-type">eType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.ToANF.html#fromANFCExpr"><span class="hs-identifier hs-type">fromANFCExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154750"><span class="hs-identifier hs-type">match</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Elara.Core.ToANF.html#fromANF"><span class="hs-identifier hs-type">fromANF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154762"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">callStack</span></span><span>
</span><span id="line-136"></span><span>            </span><span class="annot"><a href="Elara.Core.html#DataAlt"><span class="hs-identifier hs-type">Core.DataAlt</span></a></span><span> </span><span id="local-6989586621680154771"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621680154771"><span class="hs-identifier hs-var">con'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-137"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680154772"><span class="annot"><span class="annottext">conType :: Type
</span><a href="#local-6989586621680154772"><span class="hs-identifier hs-var hs-var hs-var">conType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Elara.Core.html#functionTypeResult"><span class="hs-identifier hs-var">Core.functionTypeResult</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621680154771"><span class="hs-identifier hs-var">con'</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">dataConType</span><span>
</span><span id="line-138"></span><span>                </span><span class="hs-comment">-- debug $ &quot;conType: &quot; &lt;&gt; pretty conType &lt;+&gt; parens (pretty $ generalize con'.dataConType)</span><span>
</span><span id="line-139"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; Eff r () -&gt; Eff r ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Var] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621680154761"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [Type]
</span><a href="Elara.Core.html#functionTypeArgs"><span class="hs-identifier hs-var">Core.functionTypeArgs</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621680154771"><span class="hs-identifier hs-var">con'</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">dataConType</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Eff r () -&gt; Eff r ()) -&gt; Eff r () -&gt; Eff r ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-140"></span><span>                    </span><span class="hs-comment">-- debug $ &quot;bs: &quot; &lt;&gt; pretty bs</span><span>
</span><span id="line-141"></span><span>                    </span><span class="hs-comment">-- debug $ &quot;functionTypeArgs: &quot; &lt;&gt; pretty (Core.functionTypeArgs con'.dataConType)</span><span>
</span><span id="line-142"></span><span>                    </span><span class="annot"><span class="annottext">TypeCheckError -&gt; Eff r ()
forall e (es :: [Effect]) a.
(HasCallStack, Error e :&gt; es, Show e) =&gt;
e -&gt; Eff es a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(TypeCheckError -&gt; Eff r ()) -&gt; TypeCheckError -&gt; Eff r ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-143"></span><span>                        </span><span class="annot"><span class="annottext">AltCon -&gt; Type -&gt; [Var] -&gt; CoreExpr -&gt; TypeCheckError
</span><a href="Elara.Core.TypeCheck.html#PatternMatchMissingBinders"><span class="hs-identifier hs-var">PatternMatchMissingBinders</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621680154760"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621680154771"><span class="hs-identifier hs-var">con'</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">dataConType</span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621680154761"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CExpr Var -&gt; CoreExpr
</span><a href="Elara.Core.ToANF.html#fromANFCExpr"><span class="hs-identifier hs-var">fromANFCExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CExpr Var
</span><a href="#local-6989586621680154750"><span class="hs-identifier hs-var">match</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>                </span><span id="local-6989586621680154778"><span class="annot"><a href="#local-6989586621680154778"><span class="hs-identifier hs-var">eType'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Var -&gt; Eff r Type
forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
Expr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621680154762"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-145"></span><span>                </span><span class="hs-comment">-- TODO more robust type checking here with the binders and stuff</span><span>
</span><span id="line-146"></span><span>                </span><span class="hs-comment">-- debug $ &quot;eType': &quot; &lt;&gt; pretty eType'</span><span>
</span><span id="line-147"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680154779"><span class="annot"><a href="#local-6989586621680154779"><span class="hs-identifier hs-var hs-var">generalizedEType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Elara.Core.TypeCheck.html#generalize"><span class="hs-identifier hs-var">generalize</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154755"><span class="hs-identifier hs-var">eType</span></a></span><span>
</span><span id="line-148"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680154780"><span class="annot"><a href="#local-6989586621680154780"><span class="hs-identifier hs-var hs-var">generalizedConType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Elara.Core.TypeCheck.html#generalize"><span class="hs-identifier hs-var">generalize</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154772"><span class="hs-identifier hs-var">conType</span></a></span><span>
</span><span id="line-149"></span><span>                </span><span class="hs-comment">-- debug $ &quot;generalized:&quot; &lt;+&gt; pretty generalizedEType &lt;+&gt; &quot;and&quot; &lt;+&gt; pretty generalizedConType</span><span>
</span><span id="line-150"></span><span>                </span><span class="hs-comment">-- debug $ &quot;equal?&quot; &lt;+&gt; pretty (generalizedEType `equalUnderSubst` generalizedConType)</span><span>
</span><span id="line-151"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621680154779"><span class="hs-identifier hs-type">generalizedEType</span></a></span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#equalUnderSubst"><span class="hs-operator hs-type">`equalUnderSubst`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154780"><span class="hs-identifier hs-type">generalizedConType</span></a></span><span>
</span><span id="line-152"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621680154778"><span class="hs-identifier hs-type">eType'</span></a></span><span>
</span><span id="line-153"></span><span>                    </span><span class="hs-keyword">else</span><span>
</span><span id="line-154"></span><span>                        </span><span class="annot"><span class="hs-identifier hs-type">throwError</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-155"></span><span>                            </span><span class="annot"><a href="Elara.Core.TypeCheck.html#CoreTypeMismatch"><span class="hs-identifier hs-type">CoreTypeMismatch</span></a></span><span>
</span><span id="line-156"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.TypeCheck.html#generalize"><span class="hs-identifier hs-type">generalize</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154772"><span class="hs-identifier hs-type">conType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.TypeCheck.html#generalize"><span class="hs-identifier hs-type">generalize</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154755"><span class="hs-identifier hs-type">eType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.ToANF.html#fromANF"><span class="hs-identifier hs-type">fromANF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154762"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Elara.Core.ToANF.html#fromANF"><span class="hs-identifier hs-type">fromANF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154762"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>                                </span><span class="annot"><span class="hs-identifier hs-type">callStack</span></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680154758"><span class="hs-identifier hs-type">altTypes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-162"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Eff r Type
forall a t. (HasCallStack, IsText t) =&gt; t -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;empty match? how do we handle this&quot;</span></span><span>
</span><span id="line-163"></span><span>        </span><span id="local-6989586621680154781"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154781"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Eff r Type
forall a. a -&gt; Eff r a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154781"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#typeCheckLit"><span class="hs-identifier hs-type">typeCheckLit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Core.html#Literal"><span class="hs-identifier hs-type">Core.Literal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span><span>
</span><span id="line-166"></span><span id="typeCheckLit"><span class="annot"><span class="annottext">typeCheckLit :: Literal -&gt; Type
</span><a href="Elara.Core.TypeCheck.html#typeCheckLit"><span class="hs-identifier hs-var hs-var">typeCheckLit</span></a></span></span><span> </span><span id="local-6989586621680154782"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621680154782"><span class="hs-identifier hs-var">lit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621680154782"><span class="hs-identifier hs-var">lit</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-167"></span><span>    </span><span class="annot"><a href="Elara.Core.html#Int"><span class="hs-identifier hs-type">Core.Int</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Type
</span><a href="Elara.Core.html#ConTy"><span class="hs-identifier hs-var">Core.ConTy</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="Elara.Prim.Core.html#intCon"><span class="hs-identifier hs-var">intCon</span></a></span><span>
</span><span id="line-168"></span><span>    </span><span class="annot"><a href="Elara.Core.html#String"><span class="hs-identifier hs-type">Core.String</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Type
</span><a href="Elara.Core.html#ConTy"><span class="hs-identifier hs-var">Core.ConTy</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="Elara.Prim.Core.html#stringCon"><span class="hs-identifier hs-var">stringCon</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><a href="Elara.Core.html#Char"><span class="hs-identifier hs-type">Core.Char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Type
</span><a href="Elara.Core.html#ConTy"><span class="hs-identifier hs-var">Core.ConTy</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="Elara.Prim.Core.html#charCon"><span class="hs-identifier hs-var">charCon</span></a></span><span>
</span><span id="line-170"></span><span>    </span><span class="annot"><a href="Elara.Core.html#Double"><span class="hs-identifier hs-type">Core.Double</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Type
</span><a href="Elara.Core.html#ConTy"><span class="hs-identifier hs-var">Core.ConTy</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="Elara.Prim.Core.html#doubleCon"><span class="hs-identifier hs-var">doubleCon</span></a></span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><span class="annottext">Literal
</span><a href="Elara.Core.html#Unit"><span class="hs-identifier hs-var">Core.Unit</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Type
</span><a href="Elara.Core.html#ConTy"><span class="hs-identifier hs-var">Core.ConTy</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="Elara.Prim.Core.html#unitCon"><span class="hs-identifier hs-var">unitCon</span></a></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span id="local-6989586621680154116"><span class="annot"><a href="Elara.Core.TypeCheck.html#typeCheckA"><span class="hs-identifier hs-type">typeCheckA</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Error</span></span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#TypeCheckError"><span class="hs-identifier hs-type">TypeCheckError</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680154116"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#TcState"><span class="hs-identifier hs-type">TcState</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680154116"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Elara.Logging.html#StructuredDebug"><span class="hs-identifier hs-type">StructuredDebug</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680154116"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><a href="Elara.Core.ANF.html#AExpr"><span class="hs-identifier hs-type">ANF.AExpr</span></a></span><span> </span><span class="annot"><a href="Elara.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680154116"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span></span><span>
</span><span id="line-176"></span><span id="typeCheckA"><span class="annot"><span class="annottext">typeCheckA :: forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
AExpr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheckA"><span class="hs-identifier hs-var hs-var">typeCheckA</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.ANF.html#Lit"><span class="hs-identifier hs-type">ANF.Lit</span></a></span><span> </span><span id="local-6989586621680154832"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621680154832"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Eff r Type
forall a. a -&gt; Eff r a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Eff r Type) -&gt; Type -&gt; Eff r Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Type
</span><a href="Elara.Core.TypeCheck.html#typeCheckLit"><span class="hs-identifier hs-var">typeCheckLit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621680154832"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-177"></span><span class="hs-comment">-- Globally qualified vars are always in scope</span><span>
</span><span id="line-178"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#typeCheckA"><span class="hs-identifier hs-var">typeCheckA</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.ANF.html#Var"><span class="hs-identifier hs-type">ANF.Var</span></a></span><span> </span><span id="local-6989586621680154834"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154834"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-179"></span><span>    </span><span id="local-6989586621680154835"><span class="annot"><a href="#local-6989586621680154835"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff r TcState
forall s (es :: [Effect]).
(HasCallStack, State s :&gt; es) =&gt;
Eff es s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#isInScope"><span class="hs-identifier hs-type">isInScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154834"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154835"><span class="hs-identifier hs-type">env</span></a></span><span>
</span><span id="line-181"></span><span>            </span><span class="hs-keyword">then</span><span>
</span><span id="line-182"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.TypeCheck.html#varType"><span class="hs-identifier hs-type">varType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154834"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>            </span><span class="hs-keyword">else</span><span>
</span><span id="line-184"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">throwError</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Elara.Core.TypeCheck.html#UnknownVariable"><span class="hs-identifier hs-type">UnknownVariable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154834"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><span class="hs-identifier">env</span></span><span class="hs-operator">.</span><span class="hs-identifier">scope</span><span>
</span><span id="line-185"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#typeCheckA"><span class="hs-identifier hs-var">typeCheckA</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.ANF.html#Lam"><span class="hs-identifier hs-type">ANF.Lam</span></a></span><span> </span><span id="local-6989586621680154837"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154837"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621680154838"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621680154838"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680154839"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621680154839"><span class="hs-identifier hs-var hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Type
</span><a href="Elara.Core.TypeCheck.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154837"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span>    </span><span id="local-6989586621680154840"><span class="annot"><a href="#local-6989586621680154840"><span class="hs-identifier hs-var">eType</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcState -&gt; TcState) -&gt; Eff r Type -&gt; Eff r Type
forall s (r :: [Effect]) a.
(State s :&gt; r) =&gt;
(s -&gt; s) -&gt; Eff r a -&gt; Eff r a
</span><a href="Effectful.State.Extra.html#locally"><span class="hs-identifier hs-var">locally</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; TcState -&gt; TcState
</span><a href="Elara.Core.TypeCheck.html#addToScope"><span class="hs-identifier hs-var">addToScope</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621680154837"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Eff r Type -&gt; Eff r Type) -&gt; Eff r Type -&gt; Eff r Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Var -&gt; Eff r Type
forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
Expr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621680154838"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-190"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Elara.Core.html#FuncTy"><span class="hs-identifier hs-type">Core.FuncTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154839"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680154840"><span class="hs-identifier hs-type">eType</span></a></span><span>
</span><span id="line-191"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#typeCheckA"><span class="hs-identifier hs-var">typeCheckA</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.ANF.html#TyApp"><span class="hs-identifier hs-type">ANF.TyApp</span></a></span><span> </span><span id="local-6989586621680154842"><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154842"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621680154843"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154843"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>    </span><span id="local-6989586621680154844"><span class="annot"><a href="#local-6989586621680154844"><span class="hs-identifier hs-var">eType</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AExpr Var -&gt; Eff r Type
forall (r :: [Effect]).
(Error TypeCheckError :&gt; r, State TcState :&gt; r,
 StructuredDebug :&gt; r, HasCallStack) =&gt;
AExpr Var -&gt; Eff r Type
</span><a href="Elara.Core.TypeCheck.html#typeCheckA"><span class="hs-identifier hs-var">typeCheckA</span></a></span><span> </span><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154842"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680154844"><span class="hs-identifier hs-type">eType</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-194"></span><span>        </span><span class="annot"><a href="Elara.Core.html#ForAllTy"><span class="hs-identifier hs-type">Core.ForAllTy</span></a></span><span> </span><span id="local-6989586621680154846"><span class="annot"><span class="annottext">TypeVariable
</span><a href="#local-6989586621680154846"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621680154847"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154847"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Eff r Type
forall a. a -&gt; Eff r a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Eff r Type) -&gt; Type -&gt; Eff r Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeVariable -&gt; Type -&gt; Type -&gt; Type
</span><a href="Elara.Core.html#substTypeVar"><span class="hs-identifier hs-var">Core.substTypeVar</span></a></span><span> </span><span class="annot"><span class="annottext">TypeVariable
</span><a href="#local-6989586621680154846"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154843"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154847"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-195"></span><span>        </span><span id="local-6989586621680154849"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154849"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-196"></span><span>            </span><span class="annot"><span class="annottext">TypeCheckError -&gt; Eff r Type
forall e (es :: [Effect]) a.
(HasCallStack, Error e :&gt; es, Show e) =&gt;
e -&gt; Eff es a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(TypeCheckError -&gt; Eff r Type) -&gt; TypeCheckError -&gt; Eff r Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-197"></span><span>                </span><span class="annot"><a href="Elara.Core.TypeCheck.html#CoreTypeMismatchIncompleteExpected"><span class="hs-identifier hs-type">CoreTypeMismatchIncompleteExpected</span></a></span><span>
</span><span id="line-198"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">incompleteExpected :: Text
</span><a href="Elara.Core.TypeCheck.html#incompleteExpected"><span class="hs-identifier hs-var">incompleteExpected</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;A polymorphic type&quot;</span></span><span>
</span><span id="line-199"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">actual :: Type
</span><a href="Elara.Core.TypeCheck.html#actual"><span class="hs-identifier hs-var">actual</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154849"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-200"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">source :: (CoreExpr, CoreExpr)
</span><a href="Elara.Core.TypeCheck.html#source"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AExpr Var -&gt; CoreExpr
</span><a href="Elara.Core.ToANF.html#fromANFAtom"><span class="hs-identifier hs-var">fromANFAtom</span></a></span><span> </span><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154842"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AExpr Var -&gt; CoreExpr
</span><a href="Elara.Core.ToANF.html#fromANFAtom"><span class="hs-identifier hs-var">fromANFAtom</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AExpr Var -&gt; Type -&gt; AExpr Var
forall b. AExpr b -&gt; Type -&gt; AExpr b
</span><a href="Elara.Core.ANF.html#TyApp"><span class="hs-identifier hs-var">ANF.TyApp</span></a></span><span> </span><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154842"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154843"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-202"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#typeCheckA"><span class="hs-identifier hs-var">typeCheckA</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.ANF.html#TyLam"><span class="hs-identifier hs-type">ANF.TyLam</span></a></span><span> </span><span id="local-6989586621680154851"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154851"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621680154852"><span class="annot"><span class="annottext">AExpr Var
</span><a href="#local-6989586621680154852"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Eff r Type
forall a. HasCallStack =&gt; a
</span><a href="TODO.html#todo"><span class="hs-identifier hs-var">todo</span></a></span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span class="annot"><span class="hs-comment">{- | Relation that defines 2 types as equal iff they are equal under a substitution of type variables
For example @forall a. a@ and @forall b. b@ are equal in this relation,
but @forall a b. a -&gt; b@ and @forall a b. b -&gt; a@ are not equal
-}</span></span><span>
</span><span id="line-208"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#equalUnderSubst"><span class="hs-identifier hs-type">equalUnderSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-209"></span><span id="equalUnderSubst"><span class="annot"><span class="annottext">equalUnderSubst :: Type -&gt; Type -&gt; Bool
</span><a href="Elara.Core.TypeCheck.html#equalUnderSubst"><span class="hs-identifier hs-var hs-var">equalUnderSubst</span></a></span></span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621680154853"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154853"><span class="hs-identifier hs-var">x</span></a></span></span><span>
</span><span id="line-211"></span><span>    </span><span id="local-6989586621680154854"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154854"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="Elara.Core.TypeCheck.html#equalUnderSubst%27"><span class="hs-identifier hs-var">equalUnderSubst'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154853"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154854"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="Elara.Core.TypeCheck.html#equalUnderSubst%27"><span class="hs-identifier hs-var">equalUnderSubst'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154854"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154853"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-comment">-- reflexive</span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#equalUnderSubst%27"><span class="hs-identifier hs-type">equalUnderSubst'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-214"></span><span id="equalUnderSubst%27"><span class="annot"><span class="annottext">equalUnderSubst' :: Type -&gt; Type -&gt; Bool
</span><a href="Elara.Core.TypeCheck.html#equalUnderSubst%27"><span class="hs-identifier hs-var hs-var">equalUnderSubst'</span></a></span></span><span> </span><span id="local-6989586621680154860"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154860"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621680154861"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154861"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154860"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154861"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-215"></span><span class="hs-comment">-- forall a. T and forall b. U are equal if T/[a=b] == U</span><span>
</span><span id="line-216"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#equalUnderSubst%27"><span class="hs-identifier hs-var">equalUnderSubst'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#ForAllTy"><span class="hs-identifier hs-type">Core.ForAllTy</span></a></span><span> </span><span id="local-6989586621680154862"><span class="annot"><span class="annottext">TypeVariable
</span><a href="#local-6989586621680154862"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span id="local-6989586621680154863"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154863"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#ForAllTy"><span class="hs-identifier hs-type">Core.ForAllTy</span></a></span><span> </span><span id="local-6989586621680154864"><span class="annot"><span class="annottext">TypeVariable
</span><a href="#local-6989586621680154864"><span class="hs-identifier hs-var">tv2</span></a></span></span><span> </span><span id="local-6989586621680154865"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154865"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-217"></span><span>    </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="Elara.Core.TypeCheck.html#equalUnderSubst"><span class="hs-identifier hs-var">equalUnderSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154863"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeVariable -&gt; Type -&gt; Type -&gt; Type
</span><a href="Elara.Core.html#substTypeVar"><span class="hs-identifier hs-var">Core.substTypeVar</span></a></span><span> </span><span class="annot"><span class="annottext">TypeVariable
</span><a href="#local-6989586621680154864"><span class="hs-identifier hs-var">tv2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeVariable -&gt; Type
</span><a href="Elara.Core.html#TyVarTy"><span class="hs-identifier hs-var">Core.TyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TypeVariable
</span><a href="#local-6989586621680154862"><span class="hs-identifier hs-var">tv1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154865"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span class="hs-comment">-- eg forall a. List a and List Int should be equal</span><span>
</span><span id="line-219"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#equalUnderSubst%27"><span class="hs-identifier hs-var">equalUnderSubst'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#ForAllTy"><span class="hs-identifier hs-type">Core.ForAllTy</span></a></span><span> </span><span id="local-6989586621680154867"><span class="annot"><span class="annottext">TypeVariable
</span><a href="#local-6989586621680154867"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span id="local-6989586621680154868"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154868"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680154869"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154869"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-220"></span><span>    </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="Elara.Core.TypeCheck.html#equalUnderSubst"><span class="hs-identifier hs-var">equalUnderSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeVariable -&gt; Type -&gt; Type -&gt; Type
</span><a href="Elara.Core.html#substTypeVar"><span class="hs-identifier hs-var">Core.substTypeVar</span></a></span><span> </span><span class="annot"><span class="annottext">TypeVariable
</span><a href="#local-6989586621680154867"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeVariable -&gt; Type
</span><a href="Elara.Core.html#TyVarTy"><span class="hs-identifier hs-var">Core.TyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TypeVariable
</span><a href="#local-6989586621680154867"><span class="hs-identifier hs-var">tv1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154868"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154869"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-221"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#equalUnderSubst%27"><span class="hs-identifier hs-var">equalUnderSubst'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#FuncTy"><span class="hs-identifier hs-type">Core.FuncTy</span></a></span><span> </span><span id="local-6989586621680154870"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154870"><span class="hs-identifier hs-var">a1</span></a></span></span><span> </span><span id="local-6989586621680154871"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154871"><span class="hs-identifier hs-var">b1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#FuncTy"><span class="hs-identifier hs-type">Core.FuncTy</span></a></span><span> </span><span id="local-6989586621680154872"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154872"><span class="hs-identifier hs-var">a2</span></a></span></span><span> </span><span id="local-6989586621680154873"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154873"><span class="hs-identifier hs-var">b2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-222"></span><span>    </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="Elara.Core.TypeCheck.html#equalUnderSubst"><span class="hs-identifier hs-var">equalUnderSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154870"><span class="hs-identifier hs-var">a1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154872"><span class="hs-identifier hs-var">a2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="Elara.Core.TypeCheck.html#equalUnderSubst"><span class="hs-identifier hs-var">equalUnderSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154871"><span class="hs-identifier hs-var">b1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154873"><span class="hs-identifier hs-var">b2</span></a></span><span>
</span><span id="line-223"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#equalUnderSubst%27"><span class="hs-identifier hs-var">equalUnderSubst'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#AppTy"><span class="hs-identifier hs-type">Core.AppTy</span></a></span><span> </span><span id="local-6989586621680154876"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154876"><span class="hs-identifier hs-var">a1</span></a></span></span><span> </span><span id="local-6989586621680154877"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154877"><span class="hs-identifier hs-var">b1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#AppTy"><span class="hs-identifier hs-type">Core.AppTy</span></a></span><span> </span><span id="local-6989586621680154878"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154878"><span class="hs-identifier hs-var">a2</span></a></span></span><span> </span><span id="local-6989586621680154879"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154879"><span class="hs-identifier hs-var">b2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-224"></span><span>    </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="Elara.Core.TypeCheck.html#equalUnderSubst"><span class="hs-identifier hs-var">equalUnderSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154876"><span class="hs-identifier hs-var">a1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154878"><span class="hs-identifier hs-var">a2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="Elara.Core.TypeCheck.html#equalUnderSubst"><span class="hs-identifier hs-var">equalUnderSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154877"><span class="hs-identifier hs-var">b1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154879"><span class="hs-identifier hs-var">b2</span></a></span><span>
</span><span id="line-225"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#equalUnderSubst%27"><span class="hs-identifier hs-var">equalUnderSubst'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#ConTy"><span class="hs-identifier hs-type">Core.ConTy</span></a></span><span> </span><span id="local-6989586621680154880"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621680154880"><span class="hs-identifier hs-var">c1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#ConTy"><span class="hs-identifier hs-type">Core.ConTy</span></a></span><span> </span><span id="local-6989586621680154881"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621680154881"><span class="hs-identifier hs-var">c2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621680154880"><span class="hs-identifier hs-var">c1</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621680154881"><span class="hs-identifier hs-var">c2</span></a></span><span>
</span><span id="line-226"></span><span class="hs-comment">-- At this point (after substituting foralls), a type variable should match anything</span><span>
</span><span id="line-227"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#equalUnderSubst%27"><span class="hs-identifier hs-var">equalUnderSubst'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Core.html#TyVarTy"><span class="hs-identifier hs-type">Core.TyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TypeVariable
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-228"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#equalUnderSubst%27"><span class="hs-identifier hs-var">equalUnderSubst'</span></a></span><span> </span><span id="local-6989586621680154882"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154882"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621680154883"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154883"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">--</span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span class="annot"><a href="Elara.Core.TypeCheck.html#generalize"><span class="hs-identifier hs-type">generalize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Elara.Core.html#Type"><span class="hs-identifier hs-type">Core.Type</span></a></span><span>
</span><span id="line-231"></span><span id="generalize"><span class="annot"><span class="annottext">generalize :: Type -&gt; Type
</span><a href="Elara.Core.TypeCheck.html#generalize"><span class="hs-identifier hs-var hs-var">generalize</span></a></span></span><span> </span><span id="local-6989586621680154886"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154886"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680154887"><span class="annot"><span class="annottext">ftv :: Set TypeVariable
</span><a href="#local-6989586621680154887"><span class="hs-identifier hs-var hs-var">ftv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Set TypeVariable
</span><a href="Elara.Core.Analysis.html#freeTypeVars"><span class="hs-identifier hs-var">freeTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154886"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(TypeVariable -&gt; Type -&gt; Type) -&gt; Type -&gt; Set TypeVariable -&gt; Type
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; Set a -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">TypeVariable -&gt; Type -&gt; Type
</span><a href="Elara.Core.html#ForAllTy"><span class="hs-identifier hs-var">Core.ForAllTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621680154886"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Set TypeVariable
</span><a href="#local-6989586621680154887"><span class="hs-identifier hs-var">ftv</span></a></span><span>
</span><span id="line-232"></span></pre></body></html>