<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE QuantifiedConstraints #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Rock.Memo.html"><span class="hs-identifier">Rock.Memo</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Lifted</span></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception.Lifted</span></span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Dependent.HashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">DHashMap</span></span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Dependent.HashMap</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DHashMap</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.GADT.Compare</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">GEq</span></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.GADT.Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">GShow</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Lazy</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashMap</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Hashable</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef.Lifted</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Kind</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Type</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Some</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Typeable</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Effectful</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Eff</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Effect</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">IOE</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">raise</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(:&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Effectful.Concurrent.MVar.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Concurrent</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newEmptyMVar'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">putMVar'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readMVar'</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Effectful.TH</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">makeEffect</span></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Rock.html"><span class="hs-identifier">Rock</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Rock.MemoE.html"><span class="hs-identifier">Rock.MemoE</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Prelude.html"><span class="hs-identifier">Prelude</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">atomicModifyIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newEmptyMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">putMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readMVar</span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="annot"><span class="hs-comment">-- * Implicit memoisation-</span></span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="annot"><span class="hs-comment">-- | Proof that every key permits IO</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">class</span><span> </span><span id="HasIOE"><span class="annot"><a href="Rock.Memo.html#HasIOE"><span class="hs-identifier hs-var">HasIOE</span></a></span></span><span> </span><span id="local-6989586621680040586"><span class="annot"><a href="#local-6989586621680040586"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-30"></span><span>    </span><span id="withIOE"><span class="annot"><a href="Rock.Memo.html#withIOE"><span class="hs-identifier hs-type">withIOE</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621680040588"><span id="local-6989586621680040589"><span class="annot"><a href="#local-6989586621680040586"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040588"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040589"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IOE</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680040588"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680040588"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040589"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680040588"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040589"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-keyword">class</span><span> </span><span id="HasMemoiseE"><span class="annot"><a href="Rock.Memo.html#HasMemoiseE"><span class="hs-identifier hs-var">HasMemoiseE</span></a></span></span><span> </span><span id="local-6989586621680040400"><span class="annot"><a href="#local-6989586621680040400"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-33"></span><span>    </span><span id="withMemoiseE"><span class="annot"><a href="Rock.Memo.html#withMemoiseE"><span class="hs-identifier hs-type">withMemoiseE</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621680040398"><span id="local-6989586621680040399"><span class="annot"><a href="#local-6989586621680040400"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040398"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040399"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Rock.MemoE.html#Memoise"><span class="hs-identifier hs-type">Memoise</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680040398"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Concurrent</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680040398"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680040398"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040399"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680040398"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040399"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="annot"><span class="hs-comment">{- | Remember what @f@ queries have already been performed and their results in
a 'DHashMap', and reuse them if a query is performed again a second time.

The 'DHashMap' should typically not be reused if there has been some change that
might make a query return a different result.
-}</span></span><span>
</span><span id="line-41"></span><span class="annot"><a href="Rock.Memo.html#memoise"><span class="hs-identifier hs-type">memoise</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040382"><span class="annot"><a href="#local-6989586621680040382"><span class="hs-identifier hs-type">f</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040383"><span class="annot"><a href="#local-6989586621680040383"><span class="hs-identifier hs-type">es</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GEq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680040382"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040383"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040385"><span class="annot"><a href="#local-6989586621680040385"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680040386"><span class="annot"><a href="#local-6989586621680040386"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680040382"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040385"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040386"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Rock.Memo.html#HasMemoiseE"><span class="hs-identifier hs-type">HasMemoiseE</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040382"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040382"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040382"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-46"></span><span id="memoise"><span class="annot"><span class="annottext">memoise :: forall (f :: [Effect] -&gt; * -&gt; *).
(forall (es :: [Effect]). GEq (f es),
 forall (es :: [Effect]) a. Hashable (f es a), HasMemoiseE f,
 HasCallStack) =&gt;
Rules f -&gt; Rules f
</span><a href="Rock.Memo.html#memoise"><span class="hs-identifier hs-var hs-var">memoise</span></a></span></span><span> </span><span id="local-6989586621680040598"><span class="annot"><span class="annottext">Rules f
</span><a href="#local-6989586621680040598"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680040599"><span id="local-6989586621680040600"><span id="local-6989586621680040601"><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040601"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680040382"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040599"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040600"><span class="hs-identifier hs-type">a</span></a></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">f es a
-&gt; ((Memoise :&gt; es, Concurrent :&gt; es) =&gt; Eff es a) -&gt; Eff es a
forall (es :: [Effect]) a.
f es a
-&gt; ((Memoise :&gt; es, Concurrent :&gt; es) =&gt; Eff es a) -&gt; Eff es a
forall (f :: [Effect] -&gt; * -&gt; *) (es :: [Effect]) a.
HasMemoiseE f =&gt;
f es a
-&gt; ((Memoise :&gt; es, Concurrent :&gt; es) =&gt; Eff es a) -&gt; Eff es a
</span><a href="Rock.Memo.html#withMemoiseE"><span class="hs-identifier hs-var">withMemoiseE</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040601"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">(((Memoise :&gt; es, Concurrent :&gt; es) =&gt; Eff es a) -&gt; Eff es a)
-&gt; ((Memoise :&gt; es, Concurrent :&gt; es) =&gt; Eff es a) -&gt; Eff es a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-47"></span><span>    </span><span id="local-6989586621680040636"><span class="annot"><a href="#local-6989586621680040636"><span class="hs-identifier hs-var">maybeValueVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HideEffects f a
-&gt; DHashMap (HideEffects f) MVar' -&gt; Maybe (MVar' a)
forall (k :: * -&gt; *) a (v :: * -&gt; *).
(GEq k, Hashable (Some k)) =&gt;
k a -&gt; DHashMap k v -&gt; Maybe (v a)
</span><span class="hs-identifier hs-var">DHashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040601"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DHashMap (HideEffects f) MVar' -&gt; Maybe (MVar' a))
-&gt; Eff es (DHashMap (HideEffects f) MVar')
-&gt; Eff es (Maybe (MVar' a))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Eff es (DHashMap (HideEffects f) MVar')
forall (f :: [Effect] -&gt; * -&gt; *) (es :: [Effect]).
(HasCallStack, Memoise :&gt; es,
 forall (es1 :: [Effect]). GEq (f es1),
 forall (es1 :: [Effect]) a. Hashable (f es1 a)) =&gt;
Eff es (DHashMap (HideEffects f) MVar')
</span><a href="Rock.MemoE.html#getStartedVar"><span class="hs-identifier hs-var">getStartedVar</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680040636"><span class="hs-identifier hs-type">maybeValueVar</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-49"></span><span>        </span><span class="annot"><span class="annottext">Maybe (MVar' a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-50"></span><span>            </span><span id="local-6989586621680040641"><span class="annot"><a href="#local-6989586621680040641"><span class="hs-identifier hs-var">valueVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff es (MVar' a)
forall (es :: [Effect]) a. (Concurrent :&gt; es) =&gt; Eff es (MVar' a)
</span><span class="hs-identifier hs-var">newEmptyMVar'</span></span><span>
</span><span id="line-51"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">join</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Rock.MemoE.html#modifyStartedVar"><span class="hs-identifier hs-type">modifyStartedVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680040643"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar'
</span><a href="#local-6989586621680040643"><span class="hs-identifier hs-var">started</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-52"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Maybe (MVar' a) -&gt; Maybe (MVar' a))
-&gt; HideEffects f a
-&gt; DHashMap (HideEffects f) MVar'
-&gt; (Maybe (MVar' a), DHashMap (HideEffects f) MVar')
forall (k :: * -&gt; *) (v :: * -&gt; *) a.
(GEq k, Hashable (Some k)) =&gt;
(Maybe (v a) -&gt; Maybe (v a))
-&gt; k a -&gt; DHashMap k v -&gt; (Maybe (v a), DHashMap k v)
</span><span class="hs-identifier hs-var">DHashMap.alterLookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar' a -&gt; Maybe (MVar' a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(MVar' a -&gt; Maybe (MVar' a))
-&gt; (Maybe (MVar' a) -&gt; MVar' a)
-&gt; Maybe (MVar' a)
-&gt; Maybe (MVar' a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MVar' a -&gt; Maybe (MVar' a) -&gt; MVar' a
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">MVar' a
</span><a href="#local-6989586621680040641"><span class="hs-identifier hs-var">valueVar</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040601"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar'
</span><a href="#local-6989586621680040643"><span class="hs-identifier hs-var">started</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-53"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (MVar' a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680040647"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar'
</span><a href="#local-6989586621680040647"><span class="hs-identifier hs-var">started'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-54"></span><span>                        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar'
</span><a href="#local-6989586621680040647"><span class="hs-identifier hs-var">started'</span></a></span><span>
</span><span id="line-55"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-56"></span><span>                            </span><span id="local-6989586621680040648"><span class="annot"><a href="#local-6989586621680040648"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">f es a -&gt; Eff es a
Rules f
</span><a href="#local-6989586621680040598"><span class="hs-identifier hs-var">rules</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040601"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-57"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">putMVar'</span></span><span> </span><span class="annot"><a href="#local-6989586621680040641"><span class="hs-identifier hs-type">valueVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040648"><span class="hs-identifier hs-type">value</span></a></span><span>
</span><span id="line-58"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621680040648"><span class="hs-identifier hs-type">value</span></a></span><span>
</span><span id="line-59"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680040649"><span class="annot"><span class="annottext">MVar' a
</span><a href="#local-6989586621680040649"><span class="hs-identifier hs-var">valueVar'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680040650"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar'
</span><a href="#local-6989586621680040650"><span class="hs-identifier hs-var">_started'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-61"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar'
</span><a href="#local-6989586621680040643"><span class="hs-identifier hs-var">started</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MVar' a -&gt; Eff es a
forall (es :: [Effect]) a.
(Concurrent :&gt; es) =&gt;
MVar' a -&gt; Eff es a
</span><span class="hs-identifier hs-var">readMVar'</span></span><span> </span><span class="annot"><span class="annottext">MVar' a
</span><a href="#local-6989586621680040649"><span class="hs-identifier hs-var">valueVar'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680040651"><span class="annot"><span class="annottext">MVar' a
</span><a href="#local-6989586621680040651"><span class="hs-identifier hs-var">valueVar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-63"></span><span>            </span><span class="annot"><span class="annottext">MVar' a -&gt; Eff es a
forall (es :: [Effect]) a.
(Concurrent :&gt; es) =&gt;
MVar' a -&gt; Eff es a
</span><span class="hs-identifier hs-var">readMVar'</span></span><span> </span><span class="annot"><span class="annottext">MVar' a
</span><a href="#local-6989586621680040651"><span class="hs-identifier hs-var">valueVar</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="annot"><span class="hs-comment">-- * Explicit memoisation</span></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">data</span><span> </span><span id="MemoQuery"><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-var">MemoQuery</span></a></span></span><span> </span><span id="local-6989586621680040652"><span class="annot"><a href="#local-6989586621680040652"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621680040653"><span class="annot"><a href="#local-6989586621680040653"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680040654"><span class="annot"><a href="#local-6989586621680040654"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-68"></span><span>    </span><span id="local-6989586621680040567"><span id="local-6989586621680040569"><span id="local-6989586621680040655"><span id="MemoQuery"><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-var">MemoQuery</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680040567"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040655"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040569"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-type">MemoQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040567"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IOE</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621680040655"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680040569"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-comment">-- Don't actually memoise anything</span><span>
</span><span id="line-71"></span><span id="local-6989586621680040452"><span class="annot"><a href="Rock.Memo.html#withoutMemoisation"><span class="hs-identifier hs-type">withoutMemoisation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040452"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-type">MemoQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040452"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-72"></span><span id="withoutMemoisation"><span class="annot"><span class="annottext">withoutMemoisation :: forall (f :: [Effect] -&gt; * -&gt; *). Rules f -&gt; Rules (MemoQuery f)
</span><a href="Rock.Memo.html#withoutMemoisation"><span class="hs-identifier hs-var hs-var">withoutMemoisation</span></a></span></span><span> </span><span id="local-6989586621680040659"><span class="annot"><span class="annottext">Rules f
</span><a href="#local-6989586621680040659"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-type">MemoQuery</span></a></span><span> </span><span id="local-6989586621680040663"><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040663"><span class="hs-identifier hs-var">key</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Eff es a -&gt; Eff (IOE : es) a
forall (e :: Effect) (es :: [Effect]) a. Eff es a -&gt; Eff (e : es) a
</span><span class="hs-identifier hs-var">raise</span></span><span> </span><span class="annot"><span class="annottext">(Eff es a -&gt; Eff (IOE : es) a) -&gt; Eff es a -&gt; Eff (IOE : es) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">f es a -&gt; Eff es a
Rules f
</span><a href="#local-6989586621680040659"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040663"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="annot"><span class="hs-comment">{- | Remember what @f@ queries have already been performed and their results in
a 'DHashMap', and reuse them if a query is performed again a second time.

The 'DHashMap' should typically not be reused if there has been some change that
might make a query return a different result.
-}</span></span><span>
</span><span id="line-80"></span><span class="annot"><a href="Rock.Memo.html#memoiseExplicit"><span class="hs-identifier hs-type">memoiseExplicit</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040462"><span class="annot"><a href="#local-6989586621680040462"><span class="hs-identifier hs-type">f</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040463"><span class="annot"><a href="#local-6989586621680040463"><span class="hs-identifier hs-type">es</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GEq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680040462"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040463"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040464"><span class="annot"><a href="#local-6989586621680040464"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680040465"><span class="annot"><a href="#local-6989586621680040465"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680040462"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040464"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040465"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DHashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040462"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-84"></span><span>    </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040462"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-85"></span><span>    </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-type">MemoQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040462"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span id="memoiseExplicit"><span class="annot"><span class="annottext">memoiseExplicit :: forall (f :: [Effect] -&gt; * -&gt; *).
(forall (es :: [Effect]). GEq (f es),
 forall (es :: [Effect]) a. Hashable (f es a)) =&gt;
IORef (DHashMap (HideEffects f) MVar)
-&gt; Rules f -&gt; Rules (MemoQuery f)
</span><a href="Rock.Memo.html#memoiseExplicit"><span class="hs-identifier hs-var hs-var">memoiseExplicit</span></a></span></span><span> </span><span id="local-6989586621680040668"><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MVar)
</span><a href="#local-6989586621680040668"><span class="hs-identifier hs-var">startedVar</span></a></span></span><span> </span><span id="local-6989586621680040669"><span class="annot"><span class="annottext">Rules f
</span><a href="#local-6989586621680040669"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-type">MemoQuery</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680040699"><span id="local-6989586621680040700"><span id="local-6989586621680040701"><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040701"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680040462"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040699"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040700"><span class="hs-identifier hs-type">a</span></a></span></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-87"></span><span>    </span><span id="local-6989586621680040702"><span class="annot"><a href="#local-6989586621680040702"><span class="hs-identifier hs-var">maybeValueVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HideEffects f a -&gt; DHashMap (HideEffects f) MVar -&gt; Maybe (MVar a)
forall (k :: * -&gt; *) a (v :: * -&gt; *).
(GEq k, Hashable (Some k)) =&gt;
k a -&gt; DHashMap k v -&gt; Maybe (v a)
</span><span class="hs-identifier hs-var">DHashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040701"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DHashMap (HideEffects f) MVar -&gt; Maybe (MVar a))
-&gt; Eff es (DHashMap (HideEffects f) MVar)
-&gt; Eff es (Maybe (MVar a))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MVar)
-&gt; Eff es (DHashMap (HideEffects f) MVar)
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; IORef a -&gt; m a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MVar)
</span><a href="#local-6989586621680040668"><span class="hs-identifier hs-var">startedVar</span></a></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680040702"><span class="hs-identifier hs-type">maybeValueVar</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-89"></span><span>        </span><span class="annot"><span class="annottext">Maybe (MVar a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-90"></span><span>            </span><span id="local-6989586621680040704"><span class="annot"><a href="#local-6989586621680040704"><span class="hs-identifier hs-var">valueVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff es (MVar a)
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; m (MVar a)
</span><span class="hs-identifier hs-var">newEmptyMVar</span></span><span>
</span><span id="line-91"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">join</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">atomicModifyIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621680040668"><span class="hs-identifier hs-type">startedVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680040707"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680040707"><span class="hs-identifier hs-var">started</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-92"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Maybe (MVar a) -&gt; Maybe (MVar a))
-&gt; HideEffects f a
-&gt; DHashMap (HideEffects f) MVar
-&gt; (Maybe (MVar a), DHashMap (HideEffects f) MVar)
forall (k :: * -&gt; *) (v :: * -&gt; *) a.
(GEq k, Hashable (Some k)) =&gt;
(Maybe (v a) -&gt; Maybe (v a))
-&gt; k a -&gt; DHashMap k v -&gt; (Maybe (v a), DHashMap k v)
</span><span class="hs-identifier hs-var">DHashMap.alterLookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar a -&gt; Maybe (MVar a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(MVar a -&gt; Maybe (MVar a))
-&gt; (Maybe (MVar a) -&gt; MVar a) -&gt; Maybe (MVar a) -&gt; Maybe (MVar a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MVar a -&gt; Maybe (MVar a) -&gt; MVar a
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680040704"><span class="hs-identifier hs-var">valueVar</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040701"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680040707"><span class="hs-identifier hs-var">started</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-93"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (MVar a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680040708"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680040708"><span class="hs-identifier hs-var">started'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-94"></span><span>                        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680040708"><span class="hs-identifier hs-var">started'</span></a></span><span>
</span><span id="line-95"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-96"></span><span>                            </span><span id="local-6989586621680040709"><span class="annot"><a href="#local-6989586621680040709"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff es a -&gt; Eff (IOE : es) a
forall (e :: Effect) (es :: [Effect]) a. Eff es a -&gt; Eff (e : es) a
</span><span class="hs-identifier hs-var">raise</span></span><span> </span><span class="annot"><span class="annottext">(Eff es a -&gt; Eff (IOE : es) a) -&gt; Eff es a -&gt; Eff (IOE : es) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">f es a -&gt; Eff es a
Rules f
</span><a href="#local-6989586621680040669"><span class="hs-identifier hs-var">rules</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040701"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-97"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">putMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621680040704"><span class="hs-identifier hs-type">valueVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040709"><span class="hs-identifier hs-type">value</span></a></span><span>
</span><span id="line-98"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621680040709"><span class="hs-identifier hs-type">value</span></a></span><span>
</span><span id="line-99"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680040711"><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680040711"><span class="hs-identifier hs-var">valueVar'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680040712"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680040712"><span class="hs-identifier hs-var">_started'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-101"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680040707"><span class="hs-identifier hs-var">started</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MVar a -&gt; Eff es a
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; MVar a -&gt; m a
</span><span class="hs-identifier hs-var">readMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680040711"><span class="hs-identifier hs-var">valueVar'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680040714"><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680040714"><span class="hs-identifier hs-var">valueVar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-103"></span><span>            </span><span class="annot"><span class="annottext">MVar a -&gt; Eff es a
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; MVar a -&gt; m a
</span><span class="hs-identifier hs-var">readMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680040714"><span class="hs-identifier hs-var">valueVar</span></a></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-keyword">newtype</span><span> </span><span id="Cyclic"><span class="annot"><a href="Rock.Memo.html#Cyclic"><span class="hs-identifier hs-var">Cyclic</span></a></span></span><span> </span><span id="local-6989586621680040559"><span class="annot"><a href="#local-6989586621680040559"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Cyclic"><span class="annot"><a href="Rock.Memo.html#Cyclic"><span class="hs-identifier hs-var">Cyclic</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Some</span></span><span> </span><span class="annot"><a href="#local-6989586621680040559"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680040718"><span id="local-6989586621680040724"><span id="local-6989586621680040728"><span class="annot"><span class="annottext">Int -&gt; Cyclic f -&gt; ShowS
[Cyclic f] -&gt; ShowS
Cyclic f -&gt; String
(Int -&gt; Cyclic f -&gt; ShowS)
-&gt; (Cyclic f -&gt; String) -&gt; ([Cyclic f] -&gt; ShowS) -&gt; Show (Cyclic f)
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
forall k (f :: k -&gt; *). GShow f =&gt; Int -&gt; Cyclic f -&gt; ShowS
forall k (f :: k -&gt; *). GShow f =&gt; [Cyclic f] -&gt; ShowS
forall k (f :: k -&gt; *). GShow f =&gt; Cyclic f -&gt; String
$cshowsPrec :: forall k (f :: k -&gt; *). GShow f =&gt; Int -&gt; Cyclic f -&gt; ShowS
showsPrec :: Int -&gt; Cyclic f -&gt; ShowS
$cshow :: forall k (f :: k -&gt; *). GShow f =&gt; Cyclic f -&gt; String
show :: Cyclic f -&gt; String
$cshowList :: forall k (f :: k -&gt; *). GShow f =&gt; [Cyclic f] -&gt; ShowS
showList :: [Cyclic f] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680040501"><span id="local-6989586621680040740"><span id="local-6989586621680040744"><span id="local-6989586621680040747"><span id="local-6989586621680040750"><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GShow</span></span><span> </span><span class="annot"><a href="#local-6989586621680040501"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621680040501"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#Cyclic"><span class="hs-identifier hs-type">Cyclic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680040501"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span class="hs-keyword">data</span><span> </span><span id="MemoEntry"><span class="annot"><a href="Rock.Memo.html#MemoEntry"><span class="hs-identifier hs-var">MemoEntry</span></a></span></span><span> </span><span id="local-6989586621680040527"><span class="annot"><a href="#local-6989586621680040527"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="Started"><span class="annot"><a href="Rock.Memo.html#Started"><span class="hs-identifier hs-var">Started</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621680040527"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="Done"><span class="annot"><a href="Rock.Memo.html#Done"><span class="hs-identifier hs-var">Done</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621680040527"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span class="annot"><span class="hs-comment">{- | Like 'memoise', but throw @'Cyclic' f@ if a query depends on itself, directly or
indirectly.

The 'HashMap' represents dependencies between threads and should not be
reused between invocations.
-}</span></span><span>
</span><span id="line-120"></span><span class="annot"><a href="Rock.Memo.html#memoiseWithCycleDetection"><span class="hs-identifier hs-type">memoiseWithCycleDetection</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040502"><span class="annot"><a href="#local-6989586621680040502"><span class="hs-identifier hs-type">f</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621680040502"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040503"><span class="annot"><a href="#local-6989586621680040503"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680040504"><span class="annot"><a href="#local-6989586621680040504"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680040502"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040503"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040504"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040505"><span class="annot"><a href="#local-6989586621680040505"><span class="hs-identifier hs-type">es</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GEq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680040502"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040505"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040506"><span class="annot"><a href="#local-6989586621680040506"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680040507"><span class="annot"><a href="#local-6989586621680040507"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680040502"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040506"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040507"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DHashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040502"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Rock.Memo.html#MemoEntry"><span class="hs-identifier hs-type">MemoEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-128"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-129"></span><span>    </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040502"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-130"></span><span>    </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-type">MemoQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040502"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span id="memoiseWithCycleDetection"><span class="annot"><span class="annottext">memoiseWithCycleDetection :: forall (f :: [Effect] -&gt; * -&gt; *).
(Typeable f, forall (es :: [Effect]) a. Show (f es a),
 forall (es :: [Effect]). GEq (f es),
 forall (es :: [Effect]) a. Hashable (f es a)) =&gt;
IORef (DHashMap (HideEffects f) MemoEntry)
-&gt; IORef (HashMap ThreadId ThreadId)
-&gt; Rules f
-&gt; Rules (MemoQuery f)
</span><a href="Rock.Memo.html#memoiseWithCycleDetection"><span class="hs-identifier hs-var hs-var">memoiseWithCycleDetection</span></a></span></span><span> </span><span id="local-6989586621680040766"><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MemoEntry)
</span><a href="#local-6989586621680040766"><span class="hs-identifier hs-var">startedVar</span></a></span></span><span> </span><span id="local-6989586621680040767"><span class="annot"><span class="annottext">IORef (HashMap ThreadId ThreadId)
</span><a href="#local-6989586621680040767"><span class="hs-identifier hs-var">depsVar</span></a></span></span><span> </span><span id="local-6989586621680040768"><span class="annot"><span class="annottext">Rules f
</span><a href="#local-6989586621680040768"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemoQuery f es a -&gt; Eff es a
</span><a href="#local-6989586621680040769"><span class="hs-identifier hs-var">rules'</span></a></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-133"></span><span>    </span><span id="local-6989586621680040769"><span class="annot"><span class="annottext">rules' :: MemoQuery f es a -&gt; Eff es a
</span><a href="#local-6989586621680040769"><span class="hs-identifier hs-var hs-var">rules'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-type">MemoQuery</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680040853"><span id="local-6989586621680040854"><span id="local-6989586621680040855"><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040855"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680040502"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040853"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040854"><span class="hs-identifier hs-type">a</span></a></span></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-134"></span><span>        </span><span id="local-6989586621680040856"><span class="annot"><a href="#local-6989586621680040856"><span class="hs-identifier hs-var">maybeEntry</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HideEffects f a
-&gt; DHashMap (HideEffects f) MemoEntry -&gt; Maybe (MemoEntry a)
forall (k :: * -&gt; *) a (v :: * -&gt; *).
(GEq k, Hashable (Some k)) =&gt;
k a -&gt; DHashMap k v -&gt; Maybe (v a)
</span><span class="hs-identifier hs-var">DHashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040855"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DHashMap (HideEffects f) MemoEntry -&gt; Maybe (MemoEntry a))
-&gt; Eff (IOE : es) (DHashMap (HideEffects f) MemoEntry)
-&gt; Eff (IOE : es) (Maybe (MemoEntry a))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MemoEntry)
-&gt; Eff (IOE : es) (DHashMap (HideEffects f) MemoEntry)
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; IORef a -&gt; m a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MemoEntry)
</span><a href="#local-6989586621680040766"><span class="hs-identifier hs-var">startedVar</span></a></span><span>
</span><span id="line-135"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680040856"><span class="hs-identifier hs-type">maybeEntry</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-136"></span><span>            </span><span class="annot"><span class="annottext">Maybe (MemoEntry a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-137"></span><span>                </span><span id="local-6989586621680040857"><span class="annot"><a href="#local-6989586621680040857"><span class="hs-identifier hs-var">threadId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff (IOE : es) ThreadId
forall (m :: * -&gt; *). MonadBase IO m =&gt; m ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-138"></span><span>                </span><span id="local-6989586621680040859"><span class="annot"><a href="#local-6989586621680040859"><span class="hs-identifier hs-var">valueVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newEmptyMVar</span></span><span>
</span><span id="line-139"></span><span>                </span><span id="local-6989586621680040860"><span class="annot"><a href="#local-6989586621680040860"><span class="hs-identifier hs-var">waitVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newMVar</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-140"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">join</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">atomicModifyIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621680040766"><span class="hs-identifier hs-type">startedVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680040862"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680040862"><span class="hs-identifier hs-var">started</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-141"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Maybe (MemoEntry a) -&gt; Maybe (MemoEntry a))
-&gt; HideEffects f a
-&gt; DHashMap (HideEffects f) MemoEntry
-&gt; (Maybe (MemoEntry a), DHashMap (HideEffects f) MemoEntry)
forall (k :: * -&gt; *) (v :: * -&gt; *) a.
(GEq k, Hashable (Some k)) =&gt;
(Maybe (v a) -&gt; Maybe (v a))
-&gt; k a -&gt; DHashMap k v -&gt; (Maybe (v a), DHashMap k v)
</span><span class="hs-identifier hs-var">DHashMap.alterLookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemoEntry a -&gt; Maybe (MemoEntry a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(MemoEntry a -&gt; Maybe (MemoEntry a))
-&gt; (Maybe (MemoEntry a) -&gt; MemoEntry a)
-&gt; Maybe (MemoEntry a)
-&gt; Maybe (MemoEntry a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MemoEntry a -&gt; Maybe (MemoEntry a) -&gt; MemoEntry a
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId
-&gt; MVar (Maybe a) -&gt; MVar (Maybe [ThreadId]) -&gt; MemoEntry a
forall a.
ThreadId
-&gt; MVar (Maybe a) -&gt; MVar (Maybe [ThreadId]) -&gt; MemoEntry a
</span><a href="Rock.Memo.html#Started"><span class="hs-identifier hs-var">Started</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621680040857"><span class="hs-identifier hs-var">threadId</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe a)
</span><a href="#local-6989586621680040859"><span class="hs-identifier hs-var">valueVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe [ThreadId])
</span><a href="#local-6989586621680040860"><span class="hs-identifier hs-var">waitVar</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040855"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680040862"><span class="hs-identifier hs-var">started</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-142"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (MemoEntry a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680040863"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680040863"><span class="hs-identifier hs-var">started'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-143"></span><span>                            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680040863"><span class="hs-identifier hs-var">started'</span></a></span><span>
</span><span id="line-144"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-145"></span><span>                                    </span><span id="local-6989586621680040864"><span class="annot"><a href="#local-6989586621680040864"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff es a -&gt; Eff (IOE : es) a
forall (e :: Effect) (es :: [Effect]) a. Eff es a -&gt; Eff (e : es) a
</span><span class="hs-identifier hs-var">raise</span></span><span> </span><span class="annot"><span class="annottext">(Eff es a -&gt; Eff (IOE : es) a) -&gt; Eff es a -&gt; Eff (IOE : es) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">f es a -&gt; Eff es a
Rules f
</span><a href="#local-6989586621680040768"><span class="hs-identifier hs-var">rules</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040855"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-146"></span><span>                                    </span><span class="annot"><span class="hs-identifier hs-type">join</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">modifyMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621680040860"><span class="hs-identifier hs-type">waitVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680040866"><span class="annot"><span class="annottext">Maybe [ThreadId]
</span><a href="#local-6989586621680040866"><span class="hs-identifier hs-var">maybeWaitingThreads</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>                                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [ThreadId]
</span><a href="#local-6989586621680040866"><span class="hs-identifier hs-var">maybeWaitingThreads</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-148"></span><span>                                            </span><span class="annot"><span class="annottext">Maybe [ThreadId]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-149"></span><span>                                                </span><span class="annot"><span class="annottext">Text -&gt; Eff (IOE : es) (Maybe [ThreadId], Eff (IOE : es) ())
forall a t. (HasCallStack, IsText t) =&gt; t -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;impossible&quot;</span></span><span>
</span><span id="line-150"></span><span>                                            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680040868"><span class="annot"><span class="annottext">[ThreadId]
</span><a href="#local-6989586621680040868"><span class="hs-identifier hs-var">waitingThreads</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-151"></span><span>                                                </span><span class="annot"><span class="annottext">(Maybe [ThreadId], Eff (IOE : es) ())
-&gt; Eff (IOE : es) (Maybe [ThreadId], Eff (IOE : es) ())
forall a. a -&gt; Eff (IOE : es) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-152"></span><span>                                                    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe [ThreadId]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-153"></span><span>                                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IORef (HashMap ThreadId ThreadId)
-&gt; (HashMap ThreadId ThreadId -&gt; (HashMap ThreadId ThreadId, ()))
-&gt; Eff (IOE : es) ()
forall (m :: * -&gt; *) a b.
MonadBase IO m =&gt;
IORef a -&gt; (a -&gt; (a, b)) -&gt; m b
</span><span class="hs-identifier hs-var">atomicModifyIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (HashMap ThreadId ThreadId)
</span><a href="#local-6989586621680040767"><span class="hs-identifier hs-var">depsVar</span></a></span><span> </span><span class="annot"><span class="annottext">((HashMap ThreadId ThreadId -&gt; (HashMap ThreadId ThreadId, ()))
 -&gt; Eff (IOE : es) ())
-&gt; (HashMap ThreadId ThreadId -&gt; (HashMap ThreadId ThreadId, ()))
-&gt; Eff (IOE : es) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680040869"><span class="annot"><span class="annottext">HashMap ThreadId ThreadId
</span><a href="#local-6989586621680040869"><span class="hs-identifier hs-var">deps</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-154"></span><span>                                                        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(ThreadId
 -&gt; HashMap ThreadId ThreadId -&gt; HashMap ThreadId ThreadId)
-&gt; HashMap ThreadId ThreadId
-&gt; [ThreadId]
-&gt; HashMap ThreadId ThreadId
forall (f :: * -&gt; *) a b.
Foldable f =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; f a -&gt; b
</span><span class="hs-identifier hs-var">flipfoldl'</span></span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; HashMap ThreadId ThreadId -&gt; HashMap ThreadId ThreadId
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HashMap.delete</span></span><span> </span><span class="annot"><span class="annottext">HashMap ThreadId ThreadId
</span><a href="#local-6989586621680040869"><span class="hs-identifier hs-var">deps</span></a></span><span> </span><span class="annot"><span class="annottext">[ThreadId]
</span><a href="#local-6989586621680040868"><span class="hs-identifier hs-var">waitingThreads</span></a></span><span>
</span><span id="line-155"></span><span>                                                        </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>                                                        </span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>                                                    </span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>                                    </span><span class="annot"><span class="hs-identifier hs-type">atomicModifyIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621680040766"><span class="hs-identifier hs-type">startedVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680040872"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680040872"><span class="hs-identifier hs-var">started''</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-159"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HideEffects f a
-&gt; MemoEntry a
-&gt; DHashMap (HideEffects f) MemoEntry
-&gt; DHashMap (HideEffects f) MemoEntry
forall (k :: * -&gt; *) a (v :: * -&gt; *).
(GEq k, Hashable (Some k)) =&gt;
k a -&gt; v a -&gt; DHashMap k v -&gt; DHashMap k v
</span><span class="hs-identifier hs-var">DHashMap.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040855"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; MemoEntry a
forall a. a -&gt; MemoEntry a
</span><a href="Rock.Memo.html#Done"><span class="hs-identifier hs-var">Done</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680040864"><span class="hs-identifier hs-var">value</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680040872"><span class="hs-identifier hs-var">started''</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>                                    </span><span class="annot"><span class="hs-identifier hs-type">putMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621680040859"><span class="hs-identifier hs-type">valueVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621680040864"><span class="hs-identifier hs-type">value</span></a></span><span>
</span><span id="line-161"></span><span>                                    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621680040864"><span class="hs-identifier hs-type">value</span></a></span><span>
</span><span id="line-162"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>                                </span><span class="annot"><span class="annottext">Eff (IOE : es) a
-&gt; (Cyclic (HideEffects f) -&gt; Eff (IOE : es) a) -&gt; Eff (IOE : es) a
forall (m :: * -&gt; *) e a.
(MonadBaseControl IO m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catch`</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680040875"><span class="annot"><span class="annottext">Cyclic (HideEffects f)
</span><a href="#local-6989586621680040875"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Rock.Memo.html#Cyclic"><span class="hs-identifier hs-type">Cyclic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040502"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>                                    </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MemoEntry)
-&gt; (DHashMap (HideEffects f) MemoEntry
    -&gt; (DHashMap (HideEffects f) MemoEntry, ()))
-&gt; Eff (IOE : es) ()
forall (m :: * -&gt; *) a b.
MonadBase IO m =&gt;
IORef a -&gt; (a -&gt; (a, b)) -&gt; m b
</span><span class="hs-identifier hs-var">atomicModifyIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MemoEntry)
</span><a href="#local-6989586621680040766"><span class="hs-identifier hs-var">startedVar</span></a></span><span> </span><span class="annot"><span class="annottext">((DHashMap (HideEffects f) MemoEntry
  -&gt; (DHashMap (HideEffects f) MemoEntry, ()))
 -&gt; Eff (IOE : es) ())
-&gt; (DHashMap (HideEffects f) MemoEntry
    -&gt; (DHashMap (HideEffects f) MemoEntry, ()))
-&gt; Eff (IOE : es) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680040876"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680040876"><span class="hs-identifier hs-var">started''</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-165"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HideEffects f a
-&gt; DHashMap (HideEffects f) MemoEntry
-&gt; DHashMap (HideEffects f) MemoEntry
forall (k :: * -&gt; *) a (v :: * -&gt; *).
(GEq k, Hashable (Some k)) =&gt;
k a -&gt; DHashMap k v -&gt; DHashMap k v
</span><span class="hs-identifier hs-var">DHashMap.delete</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040855"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680040876"><span class="hs-identifier hs-var">started''</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>                                    </span><span class="annot"><span class="annottext">MVar (Maybe a) -&gt; Maybe a -&gt; Eff (IOE : es) ()
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; MVar a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">putMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe a)
</span><a href="#local-6989586621680040859"><span class="hs-identifier hs-var">valueVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-167"></span><span>                                    </span><span class="annot"><span class="annottext">Cyclic (HideEffects f) -&gt; Eff (IOE : es) a
forall (m :: * -&gt; *) e a. (MonadBase IO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">Cyclic (HideEffects f)
</span><a href="#local-6989586621680040875"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-168"></span><span>                            </span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680040879"><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680040879"><span class="hs-identifier hs-var">entry</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680040880"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680040880"><span class="hs-identifier hs-var">_started'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-170"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680040862"><span class="hs-identifier hs-var">started</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MemoEntry a -&gt; Eff (IOE : es) a
</span><a href="#local-6989586621680040881"><span class="hs-identifier hs-var">waitFor</span></a></span><span> </span><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680040879"><span class="hs-identifier hs-var">entry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680040882"><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680040882"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MemoEntry a -&gt; Eff (IOE : es) a
</span><a href="#local-6989586621680040881"><span class="hs-identifier hs-var">waitFor</span></a></span><span> </span><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680040882"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-172"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-173"></span><span>        </span><span id="local-6989586621680040881"><span class="annot"><span class="annottext">waitFor :: MemoEntry a -&gt; Eff (IOE : es) a
</span><a href="#local-6989586621680040881"><span class="hs-identifier hs-var hs-var">waitFor</span></a></span></span><span> </span><span id="local-6989586621680040883"><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680040883"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-174"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680040883"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-175"></span><span>                </span><span class="annot"><a href="Rock.Memo.html#Started"><span class="hs-identifier hs-type">Started</span></a></span><span> </span><span id="local-6989586621680040884"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621680040884"><span class="hs-identifier hs-var">onThread</span></a></span></span><span> </span><span id="local-6989586621680040885"><span class="annot"><span class="annottext">MVar (Maybe a)
</span><a href="#local-6989586621680040885"><span class="hs-identifier hs-var">valueVar</span></a></span></span><span> </span><span id="local-6989586621680040886"><span class="annot"><span class="annottext">MVar (Maybe [ThreadId])
</span><a href="#local-6989586621680040886"><span class="hs-identifier hs-var">waitVar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-176"></span><span>                    </span><span id="local-6989586621680040887"><span class="annot"><a href="#local-6989586621680040887"><span class="hs-identifier hs-var">threadId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff (IOE : es) ThreadId
forall (m :: * -&gt; *). MonadBase IO m =&gt; m ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-177"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">modifyMVar_</span></span><span> </span><span class="annot"><a href="#local-6989586621680040886"><span class="hs-identifier hs-type">waitVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680040889"><span class="annot"><span class="annottext">Maybe [ThreadId]
</span><a href="#local-6989586621680040889"><span class="hs-identifier hs-var">maybeWaitingThreads</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-178"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [ThreadId]
</span><a href="#local-6989586621680040889"><span class="hs-identifier hs-var">maybeWaitingThreads</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-179"></span><span>                            </span><span class="annot"><span class="annottext">Maybe [ThreadId]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-180"></span><span>                                </span><span class="annot"><span class="annottext">Maybe [ThreadId] -&gt; Eff (IOE : es) (Maybe [ThreadId])
forall a. a -&gt; Eff (IOE : es) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe [ThreadId]
</span><a href="#local-6989586621680040889"><span class="hs-identifier hs-var">maybeWaitingThreads</span></a></span><span>
</span><span id="line-181"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680040890"><span class="annot"><span class="annottext">[ThreadId]
</span><a href="#local-6989586621680040890"><span class="hs-identifier hs-var">waitingThreads</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-182"></span><span>                                </span><span class="annot"><span class="annottext">Eff (IOE : es) (Eff (IOE : es) ()) -&gt; Eff (IOE : es) ()
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span> </span><span class="annot"><span class="annottext">(Eff (IOE : es) (Eff (IOE : es) ()) -&gt; Eff (IOE : es) ())
-&gt; Eff (IOE : es) (Eff (IOE : es) ()) -&gt; Eff (IOE : es) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (HashMap ThreadId ThreadId)
-&gt; (HashMap ThreadId ThreadId
    -&gt; (HashMap ThreadId ThreadId, Eff (IOE : es) ()))
-&gt; Eff (IOE : es) (Eff (IOE : es) ())
forall (m :: * -&gt; *) a b.
MonadBase IO m =&gt;
IORef a -&gt; (a -&gt; (a, b)) -&gt; m b
</span><span class="hs-identifier hs-var">atomicModifyIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (HashMap ThreadId ThreadId)
</span><a href="#local-6989586621680040767"><span class="hs-identifier hs-var">depsVar</span></a></span><span> </span><span class="annot"><span class="annottext">((HashMap ThreadId ThreadId
  -&gt; (HashMap ThreadId ThreadId, Eff (IOE : es) ()))
 -&gt; Eff (IOE : es) (Eff (IOE : es) ()))
-&gt; (HashMap ThreadId ThreadId
    -&gt; (HashMap ThreadId ThreadId, Eff (IOE : es) ()))
-&gt; Eff (IOE : es) (Eff (IOE : es) ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680040891"><span class="annot"><span class="annottext">HashMap ThreadId ThreadId
</span><a href="#local-6989586621680040891"><span class="hs-identifier hs-var">deps</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-183"></span><span>                                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680040892"><span class="annot"><span class="annottext">deps' :: HashMap ThreadId ThreadId
</span><a href="#local-6989586621680040892"><span class="hs-identifier hs-var hs-var">deps'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ThreadId
-&gt; ThreadId
-&gt; HashMap ThreadId ThreadId
-&gt; HashMap ThreadId ThreadId
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HashMap.insert</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621680040887"><span class="hs-identifier hs-var">threadId</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621680040884"><span class="hs-identifier hs-var">onThread</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap ThreadId ThreadId
</span><a href="#local-6989586621680040891"><span class="hs-identifier hs-var">deps</span></a></span><span>
</span><span id="line-184"></span><span>                                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; HashMap ThreadId ThreadId -&gt; Bool
forall {t}. Hashable t =&gt; t -&gt; HashMap t t -&gt; Bool
</span><a href="#local-6989586621680040894"><span class="hs-identifier hs-var">detectCycle</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621680040887"><span class="hs-identifier hs-var">threadId</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap ThreadId ThreadId
</span><a href="#local-6989586621680040892"><span class="hs-identifier hs-var">deps'</span></a></span><span>
</span><span id="line-185"></span><span>                                        </span><span class="hs-keyword">then</span><span>
</span><span id="line-186"></span><span>                                            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">HashMap ThreadId ThreadId
</span><a href="#local-6989586621680040891"><span class="hs-identifier hs-var">deps</span></a></span><span>
</span><span id="line-187"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Cyclic (HideEffects f) -&gt; Eff (IOE : es) ()
forall (m :: * -&gt; *) e a. (MonadBase IO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(Cyclic (HideEffects f) -&gt; Eff (IOE : es) ())
-&gt; Cyclic (HideEffects f) -&gt; Eff (IOE : es) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Some (HideEffects f) -&gt; Cyclic (HideEffects f)
forall {k} (f :: k -&gt; *). Some f -&gt; Cyclic f
</span><a href="Rock.Memo.html#Cyclic"><span class="hs-identifier hs-var">Cyclic</span></a></span><span> </span><span class="annot"><span class="annottext">(Some (HideEffects f) -&gt; Cyclic (HideEffects f))
-&gt; Some (HideEffects f) -&gt; Cyclic (HideEffects f)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HideEffects f a -&gt; Some (HideEffects f)
forall {k} (tag :: k -&gt; *) (a :: k). tag a -&gt; Some tag
</span><span class="hs-identifier hs-var">Some</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680040855"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>                                            </span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>                                        </span><span class="hs-keyword">else</span><span>
</span><span id="line-190"></span><span>                                            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">HashMap ThreadId ThreadId
</span><a href="#local-6989586621680040892"><span class="hs-identifier hs-var">deps'</span></a></span><span>
</span><span id="line-191"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Eff (IOE : es) ()
forall (f :: * -&gt; *). Applicative f =&gt; f ()
</span><span class="hs-identifier hs-var">pass</span></span><span>
</span><span id="line-192"></span><span>                                            </span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>                                </span><span class="annot"><span class="annottext">Maybe [ThreadId] -&gt; Eff (IOE : es) (Maybe [ThreadId])
forall a. a -&gt; Eff (IOE : es) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe [ThreadId] -&gt; Eff (IOE : es) (Maybe [ThreadId]))
-&gt; Maybe [ThreadId] -&gt; Eff (IOE : es) (Maybe [ThreadId])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ThreadId] -&gt; Maybe [ThreadId]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">([ThreadId] -&gt; Maybe [ThreadId]) -&gt; [ThreadId] -&gt; Maybe [ThreadId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621680040887"><span class="hs-identifier hs-var">threadId</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; [ThreadId] -&gt; [ThreadId]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ThreadId]
</span><a href="#local-6989586621680040890"><span class="hs-identifier hs-var">waitingThreads</span></a></span><span>
</span><span id="line-194"></span><span>                    </span><span id="local-6989586621680040897"><span class="annot"><a href="#local-6989586621680040897"><span class="hs-identifier hs-var">maybeValue</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621680040885"><span class="hs-identifier hs-type">valueVar</span></a></span><span>
</span><span id="line-195"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680040769"><span class="hs-identifier hs-type">rules'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-type">MemoQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040855"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621680040897"><span class="hs-identifier hs-type">maybeValue</span></a></span><span>
</span><span id="line-196"></span><span>                </span><span class="annot"><a href="Rock.Memo.html#Done"><span class="hs-identifier hs-type">Done</span></a></span><span> </span><span id="local-6989586621680040899"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680040899"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-197"></span><span>                    </span><span class="annot"><span class="annottext">a -&gt; Eff (IOE : es) a
forall a. a -&gt; Eff (IOE : es) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680040899"><span class="hs-identifier hs-var">value</span></a></span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span>    </span><span id="local-6989586621680040894"><span class="annot"><span class="annottext">detectCycle :: t -&gt; HashMap t t -&gt; Bool
</span><a href="#local-6989586621680040894"><span class="hs-identifier hs-var hs-var">detectCycle</span></a></span></span><span> </span><span id="local-6989586621680040907"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680040907"><span class="hs-identifier hs-var">threadId</span></a></span></span><span> </span><span id="local-6989586621680040908"><span class="annot"><span class="annottext">HashMap t t
</span><a href="#local-6989586621680040908"><span class="hs-identifier hs-var">deps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-200"></span><span>        </span><span class="annot"><span class="annottext">t -&gt; Bool
</span><a href="#local-6989586621680040909"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680040907"><span class="hs-identifier hs-var">threadId</span></a></span><span>
</span><span id="line-201"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-202"></span><span>        </span><span id="local-6989586621680040909"><span class="annot"><span class="annottext">go :: t -&gt; Bool
</span><a href="#local-6989586621680040909"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621680040910"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680040910"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-203"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">t -&gt; HashMap t t -&gt; Maybe t
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680040910"><span class="hs-identifier hs-var">tid</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap t t
</span><a href="#local-6989586621680040908"><span class="hs-identifier hs-var">deps</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-204"></span><span>                </span><span class="annot"><span class="annottext">Maybe t
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-205"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680040912"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680040912"><span class="hs-identifier hs-var">dep</span></a></span></span><span>
</span><span id="line-206"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680040912"><span class="hs-identifier hs-var">dep</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680040907"><span class="hs-identifier hs-var">threadId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-207"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">t -&gt; Bool
</span><a href="#local-6989586621680040909"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680040912"><span class="hs-identifier hs-var">dep</span></a></span><span>
</span><span id="line-208"></span></pre></body></html>