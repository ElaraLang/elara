<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE QuantifiedConstraints #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Rock.Memo.html"><span class="hs-identifier">Rock.Memo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#memoise"><span class="hs-identifier">memoise</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Rock.Memo.html#memoiseWithCycleDetection"><span class="hs-identifier">memoiseWithCycleDetection</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Rock.Memo.html#withoutMemoisation"><span class="hs-identifier">withoutMemoisation</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Rock.Memo.html#memoiseExplicit"><span class="hs-identifier">memoiseExplicit</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Lifted</span></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception.Lifted</span></span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Dependent.HashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">DHashMap</span></span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Dependent.HashMap</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DHashMap</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.GADT.Compare</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">GEq</span></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Lazy</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashMap</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Hashable</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef.Lifted</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isSuffixOf</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&lt;|)</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Some</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Typeable</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Effectful</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Eff</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">IOE</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">raise</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(:&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Effectful.Internal.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unEff</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unsafeEff</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unsafeEff_</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Data.Pretty.html"><span class="hs-identifier">Elara.Data.Pretty</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Logging.html"><span class="hs-identifier">Elara.Logging</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Elara.Logging.html#StructuredDebug"><span class="hs-identifier">StructuredDebug</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Elara.Logging.html#logDebugNS"><span class="hs-identifier">logDebugNS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Rock.html"><span class="hs-identifier">Rock</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Show</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unsafe.Coerce</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafeCoerce</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Prelude.html"><span class="hs-identifier">Prelude</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">atomicModifyIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">atomicModifyIORef'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newEmptyMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">putMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readMVar</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="annot"><span class="hs-comment">-- * Implicit memoisation-</span></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="annot"><span class="hs-comment">{- | Remember what @f@ queries have already been performed and their results in
a 'DHashMap', and reuse them if a query is performed again a second time.

The 'DHashMap' should typically not be reused if there has been some change that
might make a query return a different result.
-}</span></span><span>
</span><span id="line-36"></span><span class="annot"><a href="Rock.Memo.html#memoise"><span class="hs-identifier hs-type">memoise</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161302"><span class="annot"><a href="#local-6989586621680161302"><span class="hs-identifier hs-type">f</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161303"><span class="annot"><a href="#local-6989586621680161303"><span class="hs-identifier hs-type">es</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GEq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161302"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161303"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161305"><span class="annot"><a href="#local-6989586621680161305"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680161306"><span class="annot"><a href="#local-6989586621680161306"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161302"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161305"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161306"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DHashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161302"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161302"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161302"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-45"></span><span id="memoise"><span class="annot"><span class="annottext">memoise :: forall (f :: [Effect] -&gt; * -&gt; *).
(forall (es :: [Effect]). GEq (f es),
 forall (es :: [Effect]) a. Hashable (f es a), HasCallStack) =&gt;
IORef (DHashMap (HideEffects f) MVar) -&gt; Rules f -&gt; Rules f
</span><a href="Rock.Memo.html#memoise"><span class="hs-identifier hs-var hs-var">memoise</span></a></span></span><span> </span><span id="local-6989586621680161582"><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MVar)
</span><a href="#local-6989586621680161582"><span class="hs-identifier hs-var">startedVar</span></a></span></span><span> </span><span id="local-6989586621680161583"><span class="annot"><span class="annottext">Rules f
</span><a href="#local-6989586621680161583"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680161584"><span id="local-6989586621680161585"><span id="local-6989586621680161586"><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161586"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680161302"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161584"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161585"><span class="hs-identifier hs-type">a</span></a></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-46"></span><span>    </span><span id="local-6989586621680161587"><span class="annot"><a href="#local-6989586621680161587"><span class="hs-identifier hs-var">maybeValueVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Maybe (MVar a)) -&gt; Eff es (Maybe (MVar a))
forall a (es :: [Effect]). IO a -&gt; Eff es a
</span><span class="hs-identifier hs-var">unsafeEff_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HideEffects f a -&gt; DHashMap (HideEffects f) MVar -&gt; Maybe (MVar a)
forall (k :: * -&gt; *) a (v :: * -&gt; *).
(GEq k, Hashable (Some k)) =&gt;
k a -&gt; DHashMap k v -&gt; Maybe (v a)
</span><span class="hs-identifier hs-var">DHashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161586"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DHashMap (HideEffects f) MVar -&gt; Maybe (MVar a))
-&gt; IO (DHashMap (HideEffects f) MVar) -&gt; IO (Maybe (MVar a))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MVar)
-&gt; IO (DHashMap (HideEffects f) MVar)
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; IORef a -&gt; m a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MVar)
</span><a href="#local-6989586621680161582"><span class="hs-identifier hs-var">startedVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680161587"><span class="hs-identifier hs-type">maybeValueVar</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-48"></span><span>        </span><span class="annot"><span class="annottext">Maybe (MVar a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-49"></span><span>            </span><span id="local-6989586621680161592"><span class="annot"><a href="#local-6989586621680161592"><span class="hs-identifier hs-var">valueVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (MVar a) -&gt; Eff es (MVar a)
forall a (es :: [Effect]). IO a -&gt; Eff es a
</span><span class="hs-identifier hs-var">unsafeEff_</span></span><span> </span><span class="annot"><span class="annottext">IO (MVar a)
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; m (MVar a)
</span><span class="hs-identifier hs-var">newEmptyMVar</span></span><span>
</span><span id="line-50"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">join</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">unsafeEff_</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">atomicModifyIORef'</span></span><span> </span><span class="annot"><a href="#local-6989586621680161582"><span class="hs-identifier hs-type">startedVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680161595"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680161595"><span class="hs-identifier hs-var">started</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-51"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Maybe (MVar a) -&gt; Maybe (MVar a))
-&gt; HideEffects f a
-&gt; DHashMap (HideEffects f) MVar
-&gt; (Maybe (MVar a), DHashMap (HideEffects f) MVar)
forall (k :: * -&gt; *) (v :: * -&gt; *) a.
(GEq k, Hashable (Some k)) =&gt;
(Maybe (v a) -&gt; Maybe (v a))
-&gt; k a -&gt; DHashMap k v -&gt; (Maybe (v a), DHashMap k v)
</span><span class="hs-identifier hs-var">DHashMap.alterLookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar a -&gt; Maybe (MVar a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(MVar a -&gt; Maybe (MVar a))
-&gt; (Maybe (MVar a) -&gt; MVar a) -&gt; Maybe (MVar a) -&gt; Maybe (MVar a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MVar a -&gt; Maybe (MVar a) -&gt; MVar a
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680161592"><span class="hs-identifier hs-var">valueVar</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161586"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680161595"><span class="hs-identifier hs-var">started</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-52"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (MVar a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680161599"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680161599"><span class="hs-identifier hs-var">started'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-53"></span><span>                        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680161599"><span class="hs-identifier hs-var">started'</span></a></span><span>
</span><span id="line-54"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-55"></span><span>                            </span><span id="local-6989586621680161600"><span class="annot"><a href="#local-6989586621680161600"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">f es a -&gt; Eff es a
Rules f
</span><a href="#local-6989586621680161583"><span class="hs-identifier hs-var">rules</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161586"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-56"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">unsafeEff_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">putMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621680161592"><span class="hs-identifier hs-type">valueVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161600"><span class="hs-identifier hs-type">value</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621680161600"><span class="hs-identifier hs-type">value</span></a></span><span>
</span><span id="line-58"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680161602"><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680161602"><span class="hs-identifier hs-var">valueVar'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680161603"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680161603"><span class="hs-identifier hs-var">_started'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-60"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680161595"><span class="hs-identifier hs-var">started</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; Eff es a
forall a (es :: [Effect]). IO a -&gt; Eff es a
</span><span class="hs-identifier hs-var">unsafeEff_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar a -&gt; IO a
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; MVar a -&gt; m a
</span><span class="hs-identifier hs-var">readMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680161602"><span class="hs-identifier hs-var">valueVar'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680161605"><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680161605"><span class="hs-identifier hs-var">valueVar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-62"></span><span>            </span><span class="annot"><span class="annottext">IO a -&gt; Eff es a
forall a (es :: [Effect]). IO a -&gt; Eff es a
</span><span class="hs-identifier hs-var">unsafeEff_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar a -&gt; IO a
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; MVar a -&gt; m a
</span><span class="hs-identifier hs-var">readMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680161605"><span class="hs-identifier hs-var">valueVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="annot"><span class="hs-comment">-- * Explicit memoisation</span></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-keyword">data</span><span> </span><span id="MemoQuery"><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-var">MemoQuery</span></a></span></span><span> </span><span id="local-6989586621680161606"><span class="annot"><a href="#local-6989586621680161606"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621680161607"><span class="annot"><a href="#local-6989586621680161607"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680161608"><span class="annot"><a href="#local-6989586621680161608"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-67"></span><span>    </span><span id="local-6989586621680161609"><span id="local-6989586621680161610"><span id="local-6989586621680161611"><span id="MemoQuery"><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-var">MemoQuery</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Elara.Logging.html#StructuredDebug"><span class="hs-identifier hs-type">StructuredDebug</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680161609"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680161610"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161609"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161611"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-type">MemoQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161610"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IOE</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621680161609"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680161611"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-comment">-- Don't actually memoise anything</span><span>
</span><span id="line-70"></span><span id="local-6989586621680161367"><span class="annot"><a href="Rock.Memo.html#withoutMemoisation"><span class="hs-identifier hs-type">withoutMemoisation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161367"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-type">MemoQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161367"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-71"></span><span id="withoutMemoisation"><span class="annot"><span class="annottext">withoutMemoisation :: forall (f :: [Effect] -&gt; * -&gt; *). Rules f -&gt; Rules (MemoQuery f)
</span><a href="Rock.Memo.html#withoutMemoisation"><span class="hs-identifier hs-var hs-var">withoutMemoisation</span></a></span></span><span> </span><span id="local-6989586621680161615"><span class="annot"><span class="annottext">Rules f
</span><a href="#local-6989586621680161615"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-type">MemoQuery</span></a></span><span> </span><span id="local-6989586621680161621"><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161621"><span class="hs-identifier hs-var">key</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Eff es a -&gt; Eff (IOE : es) a
forall (e :: Effect) (es :: [Effect]) a. Eff es a -&gt; Eff (e : es) a
</span><span class="hs-identifier hs-var">raise</span></span><span> </span><span class="annot"><span class="annottext">(Eff es a -&gt; Eff (IOE : es) a) -&gt; Eff es a -&gt; Eff (IOE : es) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">f es a -&gt; Eff es a
Rules f
</span><a href="#local-6989586621680161615"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161621"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="annot"><span class="hs-comment">{- | Remember what @f@ queries have already been performed and their results in
a 'DHashMap', and reuse them if a query is performed again a second time.

The 'DHashMap' should typically not be reused if there has been some change that
might make a query return a different result.
-}</span></span><span>
</span><span id="line-79"></span><span class="annot"><a href="Rock.Memo.html#memoiseExplicit"><span class="hs-identifier hs-type">memoiseExplicit</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161377"><span class="annot"><a href="#local-6989586621680161377"><span class="hs-identifier hs-type">f</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161378"><span class="annot"><a href="#local-6989586621680161378"><span class="hs-identifier hs-type">es</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GEq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161377"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161378"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161379"><span class="annot"><a href="#local-6989586621680161379"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680161380"><span class="annot"><a href="#local-6989586621680161380"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161377"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161379"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161380"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DHashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161377"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161377"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-84"></span><span>    </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-type">MemoQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161377"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span id="memoiseExplicit"><span class="annot"><span class="annottext">memoiseExplicit :: forall (f :: [Effect] -&gt; * -&gt; *).
(forall (es :: [Effect]). GEq (f es),
 forall (es :: [Effect]) a. Hashable (f es a)) =&gt;
IORef (DHashMap (HideEffects f) MVar)
-&gt; Rules f -&gt; Rules (MemoQuery f)
</span><a href="Rock.Memo.html#memoiseExplicit"><span class="hs-identifier hs-var hs-var">memoiseExplicit</span></a></span></span><span> </span><span id="local-6989586621680161626"><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MVar)
</span><a href="#local-6989586621680161626"><span class="hs-identifier hs-var">startedVar</span></a></span></span><span> </span><span id="local-6989586621680161627"><span class="annot"><span class="annottext">Rules f
</span><a href="#local-6989586621680161627"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#MemoQuery"><span class="hs-identifier hs-type">MemoQuery</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680161660"><span id="local-6989586621680161661"><span id="local-6989586621680161662"><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161662"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680161377"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161660"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161661"><span class="hs-identifier hs-type">a</span></a></span></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-86"></span><span>    </span><span id="local-6989586621680161663"><span class="annot"><a href="#local-6989586621680161663"><span class="hs-identifier hs-var">maybeValueVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HideEffects f a -&gt; DHashMap (HideEffects f) MVar -&gt; Maybe (MVar a)
forall (k :: * -&gt; *) a (v :: * -&gt; *).
(GEq k, Hashable (Some k)) =&gt;
k a -&gt; DHashMap k v -&gt; Maybe (v a)
</span><span class="hs-identifier hs-var">DHashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161662"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DHashMap (HideEffects f) MVar -&gt; Maybe (MVar a))
-&gt; Eff es (DHashMap (HideEffects f) MVar)
-&gt; Eff es (Maybe (MVar a))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MVar)
-&gt; Eff es (DHashMap (HideEffects f) MVar)
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; IORef a -&gt; m a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MVar)
</span><a href="#local-6989586621680161626"><span class="hs-identifier hs-var">startedVar</span></a></span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680161663"><span class="hs-identifier hs-type">maybeValueVar</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-88"></span><span>        </span><span class="annot"><span class="annottext">Maybe (MVar a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-89"></span><span>            </span><span id="local-6989586621680161664"><span class="annot"><a href="#local-6989586621680161664"><span class="hs-identifier hs-var">valueVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff es (MVar a)
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; m (MVar a)
</span><span class="hs-identifier hs-var">newEmptyMVar</span></span><span>
</span><span id="line-90"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">join</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">atomicModifyIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621680161626"><span class="hs-identifier hs-type">startedVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680161666"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680161666"><span class="hs-identifier hs-var">started</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-91"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Maybe (MVar a) -&gt; Maybe (MVar a))
-&gt; HideEffects f a
-&gt; DHashMap (HideEffects f) MVar
-&gt; (Maybe (MVar a), DHashMap (HideEffects f) MVar)
forall (k :: * -&gt; *) (v :: * -&gt; *) a.
(GEq k, Hashable (Some k)) =&gt;
(Maybe (v a) -&gt; Maybe (v a))
-&gt; k a -&gt; DHashMap k v -&gt; (Maybe (v a), DHashMap k v)
</span><span class="hs-identifier hs-var">DHashMap.alterLookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar a -&gt; Maybe (MVar a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(MVar a -&gt; Maybe (MVar a))
-&gt; (Maybe (MVar a) -&gt; MVar a) -&gt; Maybe (MVar a) -&gt; Maybe (MVar a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MVar a -&gt; Maybe (MVar a) -&gt; MVar a
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680161664"><span class="hs-identifier hs-var">valueVar</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161662"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680161666"><span class="hs-identifier hs-var">started</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-92"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (MVar a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680161667"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680161667"><span class="hs-identifier hs-var">started'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-93"></span><span>                        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680161667"><span class="hs-identifier hs-var">started'</span></a></span><span>
</span><span id="line-94"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-95"></span><span>                            </span><span id="local-6989586621680161668"><span class="annot"><a href="#local-6989586621680161668"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff es a -&gt; Eff (IOE : es) a
forall (e :: Effect) (es :: [Effect]) a. Eff es a -&gt; Eff (e : es) a
</span><span class="hs-identifier hs-var">raise</span></span><span> </span><span class="annot"><span class="annottext">(Eff es a -&gt; Eff (IOE : es) a) -&gt; Eff es a -&gt; Eff (IOE : es) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">f es a -&gt; Eff es a
Rules f
</span><a href="#local-6989586621680161627"><span class="hs-identifier hs-var">rules</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161662"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-96"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">putMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621680161664"><span class="hs-identifier hs-type">valueVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161668"><span class="hs-identifier hs-type">value</span></a></span><span>
</span><span id="line-97"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621680161668"><span class="hs-identifier hs-type">value</span></a></span><span>
</span><span id="line-98"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680161669"><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680161669"><span class="hs-identifier hs-var">valueVar'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680161670"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680161670"><span class="hs-identifier hs-var">_started'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-100"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MVar
</span><a href="#local-6989586621680161666"><span class="hs-identifier hs-var">started</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MVar a -&gt; Eff es a
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; MVar a -&gt; m a
</span><span class="hs-identifier hs-var">readMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680161669"><span class="hs-identifier hs-var">valueVar'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680161671"><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680161671"><span class="hs-identifier hs-var">valueVar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-102"></span><span>            </span><span class="annot"><span class="annottext">MVar a -&gt; Eff es a
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; MVar a -&gt; m a
</span><span class="hs-identifier hs-var">readMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621680161671"><span class="hs-identifier hs-var">valueVar</span></a></span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="annot"><span class="hs-comment">-- | Holds the list of keys involved in the cycle, i.e. a call stack of queries</span></span><span>
</span><span id="line-105"></span><span class="hs-keyword">newtype</span><span> </span><span id="Cyclic"><span class="annot"><a href="Rock.Memo.html#Cyclic"><span class="hs-identifier hs-var">Cyclic</span></a></span></span><span> </span><span id="local-6989586621680161480"><span class="annot"><a href="#local-6989586621680161480"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Cyclic"><span class="annot"><a href="Rock.Memo.html#Cyclic"><span class="hs-identifier hs-var">Cyclic</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Some</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161480"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680161401"><span id="local-6989586621680161685"><span id="local-6989586621680161691"><span id="local-6989586621680161696"><span id="local-6989586621680161701"><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621680161401"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161394"><span class="annot"><a href="#local-6989586621680161394"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680161395"><span class="annot"><a href="#local-6989586621680161395"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161401"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161394"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161395"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161396"><span class="annot"><a href="#local-6989586621680161396"><span class="hs-identifier hs-type">es</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GEq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161401"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161396"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#Cyclic"><span class="hs-identifier hs-type">Cyclic</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161401"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680161397"><span id="local-6989586621680161709"><span id="local-6989586621680161715"><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161398"><span class="annot"><a href="#local-6989586621680161398"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680161399"><span class="annot"><a href="#local-6989586621680161399"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161397"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161398"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161399"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161400"><span class="annot"><a href="#local-6989586621680161400"><span class="hs-identifier hs-type">es</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GEq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161397"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161400"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#Cyclic"><span class="hs-identifier hs-type">Cyclic</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161397"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-110"></span><span>    </span><span id="local-6989586621680161781"><span class="annot"><span class="annottext">show :: Cyclic f -&gt; String
</span><a href="#local-6989586621680161781"><span class="hs-identifier hs-var hs-var hs-var">show</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#Cyclic"><span class="hs-identifier hs-type">Cyclic</span></a></span><span> </span><span id="local-6989586621680161783"><span class="annot"><span class="annottext">NonEmpty (Some (HideEffects f))
</span><a href="#local-6989586621680161783"><span class="hs-identifier hs-var">chain</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-111"></span><span>        </span><span class="hs-keyword">let</span><span>
</span><span id="line-112"></span><span>            </span><span id="local-6989586621680161784"><span class="annot"><span class="annottext">traceList :: [Some (HideEffects f)]
</span><a href="#local-6989586621680161784"><span class="hs-identifier hs-var hs-var">traceList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty (Some (HideEffects f)) -&gt; [Some (HideEffects f)]
forall a. NonEmpty a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Some (HideEffects f))
</span><a href="#local-6989586621680161783"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-113"></span><span>            </span><span id="local-6989586621680161786"><span class="annot"><span class="annottext">lastItem :: Some (HideEffects f)
</span><a href="#local-6989586621680161786"><span class="hs-identifier hs-var hs-var">lastItem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty (Some (HideEffects f)) -&gt; Some (HideEffects f)
forall (f :: * -&gt; *) a. IsNonEmpty f a a &quot;last&quot; =&gt; f a -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Some (HideEffects f))
</span><a href="#local-6989586621680161783"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span>            </span><span class="hs-comment">-- find the knot by looking for the first occurrence of the last item in the rest of the chain</span><span>
</span><span id="line-116"></span><span>            </span><span id="local-6989586621680161788"><span class="annot"><span class="annottext">knotIndex :: Maybe Int
</span><a href="#local-6989586621680161788"><span class="hs-identifier hs-var hs-var">knotIndex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Some (HideEffects f) -&gt; Bool)
-&gt; [Some (HideEffects f)]
-&gt; ([Some (HideEffects f)], [Some (HideEffects f)])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">break</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Some (HideEffects f) -&gt; Some (HideEffects f) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Some (HideEffects f)
</span><a href="#local-6989586621680161786"><span class="hs-identifier hs-var">lastItem</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (Some (HideEffects f)) -&gt; [Some (HideEffects f)]
forall (f :: * -&gt; *) a. IsNonEmpty f a [a] &quot;init&quot; =&gt; f a -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Some (HideEffects f))
</span><a href="#local-6989586621680161783"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-117"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Some (HideEffects f)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-comment">-- presumably impossible if there's a cycle</span><span>
</span><span id="line-118"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621680161791"><span class="annot"><span class="annottext">[Some (HideEffects f)]
</span><a href="#local-6989586621680161791"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Some (HideEffects f)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Some (HideEffects f)] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Some (HideEffects f)]
</span><a href="#local-6989586621680161791"><span class="hs-identifier hs-var">prefix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>         </span><span class="hs-keyword">in</span><span>
</span><span id="line-120"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621680161788"><span class="hs-identifier hs-var">knotIndex</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-121"></span><span>                </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-122"></span><span>                    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cyclic dependency detected:\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
forall a. ToString a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">toString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t. IsText t &quot;unlines&quot; =&gt; [t] -&gt; t
</span><span class="hs-identifier hs-var">unlines</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Some (HideEffects f) -&gt; Text) -&gt; [Some (HideEffects f)] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Some (HideEffects f) -&gt; Text
</span><a href="#local-6989586621680161795"><span class="hs-identifier hs-var">formatItem</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;  -&gt; &quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Some (HideEffects f)]
</span><a href="#local-6989586621680161784"><span class="hs-identifier hs-var">traceList</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680161796"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680161796"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-124"></span><span>                    </span><span class="hs-keyword">let</span><span>
</span><span id="line-125"></span><span>                        </span><span class="hs-special">(</span><span id="local-6989586621680161797"><span class="annot"><span class="annottext">[Some (HideEffects f)]
</span><a href="#local-6989586621680161797"><span class="hs-identifier hs-var">stem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680161798"><span class="annot"><span class="annottext">[Some (HideEffects f)]
</span><a href="#local-6989586621680161798"><span class="hs-identifier hs-var">cyclePart</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [Some (HideEffects f)]
-&gt; ([Some (HideEffects f)], [Some (HideEffects f)])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680161796"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (Some (HideEffects f)) -&gt; [Some (HideEffects f)]
forall (f :: * -&gt; *) a. IsNonEmpty f a [a] &quot;init&quot; =&gt; f a -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Some (HideEffects f))
</span><a href="#local-6989586621680161783"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>                     </span><span class="hs-keyword">in</span><span>
</span><span id="line-127"></span><span>                        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cyclic dependency detected:\n&quot;</span></span><span>
</span><span id="line-128"></span><span>                            </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[Some (HideEffects f)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Some (HideEffects f)]
</span><a href="#local-6989586621680161797"><span class="hs-identifier hs-var">stem</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Path to cycle:\n&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>                            </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
forall a. ToString a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">toString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t. IsText t &quot;unlines&quot; =&gt; [t] -&gt; t
</span><span class="hs-identifier hs-var">unlines</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Some (HideEffects f) -&gt; Text) -&gt; [Some (HideEffects f)] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Some (HideEffects f) -&gt; Text
</span><a href="#local-6989586621680161795"><span class="hs-identifier hs-var">formatItem</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;     &quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Some (HideEffects f)]
</span><a href="#local-6989586621680161797"><span class="hs-identifier hs-var">stem</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>                            </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;The Cycle:\n&quot;</span></span><span>
</span><span id="line-131"></span><span>                            </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
forall a. ToString a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">toString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t. IsText t &quot;unlines&quot; =&gt; [t] -&gt; t
</span><span class="hs-identifier hs-var">unlines</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Bool -&gt; Some (HideEffects f) -&gt; Text)
-&gt; [Bool] -&gt; [Some (HideEffects f)] -&gt; [Text]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Some (HideEffects f) -&gt; Text
</span><a href="#local-6989586621680161802"><span class="hs-identifier hs-var">formatCycleItem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [Bool] -&gt; [Bool]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [Bool]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Some (HideEffects f)]
</span><a href="#local-6989586621680161798"><span class="hs-identifier hs-var">cyclePart</span></a></span><span> </span><span class="annot"><span class="annottext">[Some (HideEffects f)]
-&gt; [Some (HideEffects f)] -&gt; [Some (HideEffects f)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Some (HideEffects f)
</span><a href="#local-6989586621680161786"><span class="hs-identifier hs-var">lastItem</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-133"></span><span>        </span><span class="annot"><a href="#local-6989586621680161804"><span class="hs-identifier hs-type">showInner</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161805"><span class="annot"><a href="#local-6989586621680161805"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680161806"><span class="annot"><a href="#local-6989586621680161806"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161397"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161805"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161806"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Some</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161397"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-134"></span><span>        </span><span id="local-6989586621680161804"><span class="annot"><span class="annottext">showInner :: (forall (es :: [Effect]) a. Show (f es a)) =&gt;
Some (HideEffects f) -&gt; String
</span><a href="#local-6989586621680161804"><span class="hs-identifier hs-var hs-var">showInner</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Some</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span id="local-6989586621680161811"><span class="annot"><span class="annottext">f b a
</span><a href="#local-6989586621680161811"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">f b a -&gt; String
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">Prelude.show</span></span><span> </span><span class="annot"><span class="annottext">f b a
</span><a href="#local-6989586621680161811"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>        </span><span class="annot"><a href="#local-6989586621680161813"><span class="hs-identifier hs-type">cleanStr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-137"></span><span>        </span><span id="local-6989586621680161813"><span class="annot"><span class="annottext">cleanStr :: ShowS
</span><a href="#local-6989586621680161813"><span class="hs-identifier hs-var hs-var">cleanStr</span></a></span></span><span> </span><span id="local-6989586621680161814"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680161814"><span class="hs-identifier hs-var">raw</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-138"></span><span>            </span><span class="annot"><span class="annottext">ShowS
forall a. ToString a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">toString</span></span><span>
</span><span id="line-139"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;HideEffects (&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Bool
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; Bool
</span><span class="hs-operator hs-var">`isPrefixOf`</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680161814"><span class="hs-identifier hs-var">raw</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Bool
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; Bool
</span><span class="hs-operator hs-var">`isSuffixOf`</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680161814"><span class="hs-identifier hs-var">raw</span></a></span><span>
</span><span id="line-140"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ShowS
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680161814"><span class="hs-identifier hs-var">raw</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">14</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; ShowS
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">13</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680161814"><span class="hs-identifier hs-var">raw</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680161814"><span class="hs-identifier hs-var">raw</span></a></span><span>
</span><span id="line-142"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span>        </span><span class="annot"><a href="#local-6989586621680161795"><span class="hs-identifier hs-type">formatItem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Some</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161397"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-145"></span><span>        </span><span id="local-6989586621680161795"><span class="annot"><span class="annottext">formatItem :: Text -&gt; Some (HideEffects f) -&gt; Text
</span><a href="#local-6989586621680161795"><span class="hs-identifier hs-var hs-var">formatItem</span></a></span></span><span> </span><span id="local-6989586621680161819"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680161819"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span id="local-6989586621680161820"><span class="annot"><span class="annottext">Some (HideEffects f)
</span><a href="#local-6989586621680161820"><span class="hs-identifier hs-var">item</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-146"></span><span>            </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680161819"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
forall a. ToText a =&gt; a -&gt; Text
</span><span class="hs-identifier hs-var">toText</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShowS
</span><a href="#local-6989586621680161813"><span class="hs-identifier hs-var">cleanStr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Some (HideEffects f) -&gt; String
(forall (es :: [Effect]) a. Show (f es a)) =&gt;
Some (HideEffects f) -&gt; String
</span><a href="#local-6989586621680161804"><span class="hs-identifier hs-var">showInner</span></a></span><span> </span><span class="annot"><span class="annottext">Some (HideEffects f)
</span><a href="#local-6989586621680161820"><span class="hs-identifier hs-var">item</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span>        </span><span class="annot"><a href="#local-6989586621680161802"><span class="hs-identifier hs-type">formatCycleItem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Some</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161397"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-149"></span><span>        </span><span id="local-6989586621680161802"><span class="annot"><span class="annottext">formatCycleItem :: Bool -&gt; Some (HideEffects f) -&gt; Text
</span><a href="#local-6989586621680161802"><span class="hs-identifier hs-var hs-var">formatCycleItem</span></a></span></span><span> </span><span id="local-6989586621680161822"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680161822"><span class="hs-identifier hs-var">isFirst</span></a></span></span><span> </span><span id="local-6989586621680161823"><span class="annot"><span class="annottext">Some (HideEffects f)
</span><a href="#local-6989586621680161823"><span class="hs-identifier hs-var">item</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-150"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680161824"><span class="annot"><span class="annottext">prefix :: Text
</span><a href="#local-6989586621680161824"><span class="hs-identifier hs-var hs-var">prefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680161822"><span class="hs-identifier hs-var">isFirst</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;  &#9484;&gt; &quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;  &#9474;  &quot;</span></span><span>
</span><span id="line-151"></span><span>             </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680161824"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
forall a. ToText a =&gt; a -&gt; Text
</span><span class="hs-identifier hs-var">toText</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShowS
</span><a href="#local-6989586621680161813"><span class="hs-identifier hs-var">cleanStr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Some (HideEffects f) -&gt; String
(forall (es :: [Effect]) a. Show (f es a)) =&gt;
Some (HideEffects f) -&gt; String
</span><a href="#local-6989586621680161804"><span class="hs-identifier hs-var">showInner</span></a></span><span> </span><span class="annot"><span class="annottext">Some (HideEffects f)
</span><a href="#local-6989586621680161823"><span class="hs-identifier hs-var">item</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="hs-keyword">data</span><span> </span><span id="MemoEntry"><span class="annot"><a href="Rock.Memo.html#MemoEntry"><span class="hs-identifier hs-var">MemoEntry</span></a></span></span><span> </span><span id="local-6989586621680161470"><span class="annot"><a href="#local-6989586621680161470"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="Started"><span class="annot"><a href="Rock.Memo.html#Started"><span class="hs-identifier hs-var">Started</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621680161470"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="Done"><span class="annot"><a href="Rock.Memo.html#Done"><span class="hs-identifier hs-var">Done</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621680161470"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span class="annot"><span class="hs-comment">{- | Like 'memoise', but throw @'Cyclic' f@ if a query depends on itself, directly or
indirectly.

The 'HashMap' represents dependencies between threads and should not be
reused between invocations.
-}</span></span><span>
</span><span id="line-163"></span><span class="annot"><a href="Rock.Memo.html#memoiseWithCycleDetection"><span class="hs-identifier hs-type">memoiseWithCycleDetection</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161446"><span class="annot"><a href="#local-6989586621680161446"><span class="hs-identifier hs-type">f</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621680161446"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161447"><span class="annot"><a href="#local-6989586621680161447"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680161448"><span class="annot"><a href="#local-6989586621680161448"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161446"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161447"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161448"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161449"><span class="annot"><a href="#local-6989586621680161449"><span class="hs-identifier hs-type">es</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GEq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161446"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161449"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161450"><span class="annot"><a href="#local-6989586621680161450"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680161451"><span class="annot"><a href="#local-6989586621680161451"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161446"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161450"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161451"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680161827"><span class="annot"><a href="#local-6989586621680161827"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680161828"><span class="annot"><a href="#local-6989586621680161828"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161446"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161827"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161828"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-172"></span><span>    </span><span class="annot"><span class="hs-comment">-- | started queries</span></span><span>
</span><span id="line-173"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DHashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161446"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Rock.Memo.html#MemoEntry"><span class="hs-identifier hs-type">MemoEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-174"></span><span>    </span><span class="annot"><span class="hs-comment">-- | dependencies between threads</span></span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-176"></span><span>    </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161446"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161446"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-178"></span><span id="memoiseWithCycleDetection"><span class="annot"><span class="annottext">memoiseWithCycleDetection :: forall (f :: [Effect] -&gt; * -&gt; *).
(Typeable f, forall (es :: [Effect]) a. Show (f es a),
 forall (es :: [Effect]). GEq (f es),
 forall (es :: [Effect]) a. Hashable (f es a),
 forall (es :: [Effect]) a. Show (f es a), HasCallStack) =&gt;
IORef (DHashMap (HideEffects f) MemoEntry)
-&gt; IORef (HashMap ThreadId ThreadId) -&gt; Rules f -&gt; Rules f
</span><a href="Rock.Memo.html#memoiseWithCycleDetection"><span class="hs-identifier hs-var hs-var">memoiseWithCycleDetection</span></a></span></span><span> </span><span id="local-6989586621680161935"><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MemoEntry)
</span><a href="#local-6989586621680161935"><span class="hs-identifier hs-var">startedVar</span></a></span></span><span> </span><span id="local-6989586621680161936"><span class="annot"><span class="annottext">IORef (HashMap ThreadId ThreadId)
</span><a href="#local-6989586621680161936"><span class="hs-identifier hs-var">depsVar</span></a></span></span><span> </span><span id="local-6989586621680161937"><span class="annot"><span class="annottext">Rules f
</span><a href="#local-6989586621680161937"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">f es a -&gt; Eff es a
</span><a href="#local-6989586621680161938"><span class="hs-identifier hs-var">rules'</span></a></span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-180"></span><span>    </span><span id="local-6989586621680161938"><span class="annot"><span class="annottext">rules' :: f es a -&gt; Eff es a
</span><a href="#local-6989586621680161938"><span class="hs-identifier hs-var hs-var">rules'</span></a></span></span><span> </span><span id="local-6989586621680161939"><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161939"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-181"></span><span>        </span><span class="annot"><span class="annottext">[Text] -&gt; Doc AnsiStyle -&gt; Eff es ()
forall (r :: [Effect]).
(HasCallStack, StructuredDebug :&gt; r) =&gt;
[Text] -&gt; Doc AnsiStyle -&gt; Eff r ()
</span><a href="Elara.Logging.html#logDebugNS"><span class="hs-identifier hs-var">logDebugNS</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Query&quot;</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Doc AnsiStyle -&gt; Eff es ()) -&gt; Doc AnsiStyle -&gt; Eff es ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc AnsiStyle
</span><span class="hs-string">&quot;MemoiseWithCycleDetection: querying &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc AnsiStyle -&gt; Doc AnsiStyle -&gt; Doc AnsiStyle
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Doc AnsiStyle
forall a. Pretty a =&gt; a -&gt; Doc AnsiStyle
</span><a href="Elara.Data.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">Text.Show.show</span></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161939"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>        </span><span id="local-6989586621680161941"><span class="annot"><a href="#local-6989586621680161941"><span class="hs-identifier hs-var">maybeEntry</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HideEffects f a
-&gt; DHashMap (HideEffects f) MemoEntry -&gt; Maybe (MemoEntry a)
forall (k :: * -&gt; *) a (v :: * -&gt; *).
(GEq k, Hashable (Some k)) =&gt;
k a -&gt; DHashMap k v -&gt; Maybe (v a)
</span><span class="hs-identifier hs-var">DHashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161939"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DHashMap (HideEffects f) MemoEntry -&gt; Maybe (MemoEntry a))
-&gt; Eff es (DHashMap (HideEffects f) MemoEntry)
-&gt; Eff es (Maybe (MemoEntry a))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO (DHashMap (HideEffects f) MemoEntry)
-&gt; Eff es (DHashMap (HideEffects f) MemoEntry)
forall a (es :: [Effect]). IO a -&gt; Eff es a
</span><span class="hs-identifier hs-var">unsafeEff_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MemoEntry)
-&gt; IO (DHashMap (HideEffects f) MemoEntry)
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; IORef a -&gt; m a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MemoEntry)
</span><a href="#local-6989586621680161935"><span class="hs-identifier hs-var">startedVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680161941"><span class="hs-identifier hs-type">maybeEntry</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-184"></span><span>            </span><span class="annot"><span class="annottext">Maybe (MemoEntry a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>                </span><span id="local-6989586621680161942"><span class="annot"><a href="#local-6989586621680161942"><span class="hs-identifier hs-var">threadId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId -&gt; Eff es ThreadId
forall a (es :: [Effect]). IO a -&gt; Eff es a
</span><span class="hs-identifier hs-var">unsafeEff_</span></span><span> </span><span class="annot"><span class="annottext">IO ThreadId
forall (m :: * -&gt; *). MonadBase IO m =&gt; m ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-186"></span><span>                </span><span id="local-6989586621680161944"><span class="annot"><a href="#local-6989586621680161944"><span class="hs-identifier hs-var">valueVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unsafeEff_</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">newEmptyMVar</span></span><span>
</span><span id="line-187"></span><span>                </span><span id="local-6989586621680161945"><span class="annot"><a href="#local-6989586621680161945"><span class="hs-identifier hs-var">waitVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unsafeEff_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">newMVar</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">join</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">unsafeEff_</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">atomicModifyIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621680161935"><span class="hs-identifier hs-type">startedVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680161947"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680161947"><span class="hs-identifier hs-var">started</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-189"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Maybe (MemoEntry a) -&gt; Maybe (MemoEntry a))
-&gt; HideEffects f a
-&gt; DHashMap (HideEffects f) MemoEntry
-&gt; (Maybe (MemoEntry a), DHashMap (HideEffects f) MemoEntry)
forall (k :: * -&gt; *) (v :: * -&gt; *) a.
(GEq k, Hashable (Some k)) =&gt;
(Maybe (v a) -&gt; Maybe (v a))
-&gt; k a -&gt; DHashMap k v -&gt; (Maybe (v a), DHashMap k v)
</span><span class="hs-identifier hs-var">DHashMap.alterLookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemoEntry a -&gt; Maybe (MemoEntry a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(MemoEntry a -&gt; Maybe (MemoEntry a))
-&gt; (Maybe (MemoEntry a) -&gt; MemoEntry a)
-&gt; Maybe (MemoEntry a)
-&gt; Maybe (MemoEntry a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MemoEntry a -&gt; Maybe (MemoEntry a) -&gt; MemoEntry a
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId
-&gt; MVar (Maybe a) -&gt; MVar (Maybe [ThreadId]) -&gt; MemoEntry a
forall a.
ThreadId
-&gt; MVar (Maybe a) -&gt; MVar (Maybe [ThreadId]) -&gt; MemoEntry a
</span><a href="Rock.Memo.html#Started"><span class="hs-identifier hs-var">Started</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621680161942"><span class="hs-identifier hs-var">threadId</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe a)
</span><a href="#local-6989586621680161944"><span class="hs-identifier hs-var">valueVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe [ThreadId])
</span><a href="#local-6989586621680161945"><span class="hs-identifier hs-var">waitVar</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161939"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680161947"><span class="hs-identifier hs-var">started</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-190"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (MemoEntry a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680161948"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680161948"><span class="hs-identifier hs-var">started'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-191"></span><span>                            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680161948"><span class="hs-identifier hs-var">started'</span></a></span><span>
</span><span id="line-192"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; MVar (Maybe a) -&gt; MVar (Maybe [ThreadId]) -&gt; Eff es a
</span><a href="#local-6989586621680161949"><span class="hs-identifier hs-var">runNewComputation</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621680161942"><span class="hs-identifier hs-var">threadId</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe a)
</span><a href="#local-6989586621680161944"><span class="hs-identifier hs-var">valueVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe [ThreadId])
</span><a href="#local-6989586621680161945"><span class="hs-identifier hs-var">waitVar</span></a></span><span>
</span><span id="line-193"></span><span>                            </span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680161950"><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680161950"><span class="hs-identifier hs-var">entry</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680161951"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680161951"><span class="hs-identifier hs-var">_started'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-195"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680161947"><span class="hs-identifier hs-var">started</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MemoEntry a -&gt; Eff es a
</span><a href="#local-6989586621680161952"><span class="hs-identifier hs-var">waitFor</span></a></span><span> </span><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680161950"><span class="hs-identifier hs-var">entry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680161953"><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680161953"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MemoEntry a -&gt; Eff es a
</span><a href="#local-6989586621680161952"><span class="hs-identifier hs-var">waitFor</span></a></span><span> </span><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680161953"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-197"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-198"></span><span>        </span><span id="local-6989586621680161949"><span class="annot"><span class="annottext">runNewComputation :: ThreadId -&gt; MVar (Maybe a) -&gt; MVar (Maybe [ThreadId]) -&gt; Eff es a
</span><a href="#local-6989586621680161949"><span class="hs-identifier hs-var hs-var">runNewComputation</span></a></span></span><span> </span><span id="local-6989586621680161954"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621680161954"><span class="hs-identifier hs-var">_threadId</span></a></span></span><span> </span><span id="local-6989586621680161955"><span class="annot"><span class="annottext">MVar (Maybe a)
</span><a href="#local-6989586621680161955"><span class="hs-identifier hs-var">valueVar</span></a></span></span><span> </span><span id="local-6989586621680161956"><span class="annot"><span class="annottext">MVar (Maybe [ThreadId])
</span><a href="#local-6989586621680161956"><span class="hs-identifier hs-var">waitVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-199"></span><span>            </span><span id="local-6989586621680161957"><span class="annot"><a href="#local-6989586621680161957"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-200"></span><span>                </span><span class="annot"><span class="annottext">Eff es a -&gt; (Cyclic f -&gt; Eff es a) -&gt; Eff es a
forall e (es :: [Effect]) a.
Exception e =&gt;
Eff es a -&gt; (e -&gt; Eff es a) -&gt; Eff es a
</span><a href="Rock.Memo.html#unsafeCatch"><span class="hs-identifier hs-var">unsafeCatch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; Eff es a
Rules f
</span><a href="#local-6989586621680161937"><span class="hs-identifier hs-var">rules</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161939"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Cyclic f -&gt; Eff es a) -&gt; Eff es a)
-&gt; (Cyclic f -&gt; Eff es a) -&gt; Eff es a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#Cyclic"><span class="hs-identifier hs-type">Cyclic</span></a></span><span> </span><span id="local-6989586621680161959"><span class="annot"><span class="annottext">NonEmpty (Some (HideEffects f))
</span><a href="#local-6989586621680161959"><span class="hs-identifier hs-var">childTrace</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-201"></span><span>                    </span><span class="annot"><span class="annottext">IO a -&gt; Eff es a
forall a (es :: [Effect]). IO a -&gt; Eff es a
</span><span class="hs-identifier hs-var">unsafeEff_</span></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; Eff es a) -&gt; IO a -&gt; Eff es a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-202"></span><span>                        </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MemoEntry)
-&gt; (DHashMap (HideEffects f) MemoEntry
    -&gt; (DHashMap (HideEffects f) MemoEntry, ()))
-&gt; IO ()
forall (m :: * -&gt; *) a b.
MonadBase IO m =&gt;
IORef a -&gt; (a -&gt; (a, b)) -&gt; m b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MemoEntry)
</span><a href="#local-6989586621680161935"><span class="hs-identifier hs-var">startedVar</span></a></span><span> </span><span class="annot"><span class="annottext">((DHashMap (HideEffects f) MemoEntry
  -&gt; (DHashMap (HideEffects f) MemoEntry, ()))
 -&gt; IO ())
-&gt; (DHashMap (HideEffects f) MemoEntry
    -&gt; (DHashMap (HideEffects f) MemoEntry, ()))
-&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680161960"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680161960"><span class="hs-identifier hs-var">started''</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-203"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HideEffects f a
-&gt; DHashMap (HideEffects f) MemoEntry
-&gt; DHashMap (HideEffects f) MemoEntry
forall (k :: * -&gt; *) a (v :: * -&gt; *).
(GEq k, Hashable (Some k)) =&gt;
k a -&gt; DHashMap k v -&gt; DHashMap k v
</span><span class="hs-identifier hs-var">DHashMap.delete</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161939"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680161960"><span class="hs-identifier hs-var">started''</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>                        </span><span class="annot"><span class="annottext">MVar (Maybe a) -&gt; Maybe a -&gt; IO ()
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; MVar a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">putMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe a)
</span><a href="#local-6989586621680161955"><span class="hs-identifier hs-var">valueVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span>                        </span><span class="annot"><span class="annottext">Cyclic f -&gt; IO a
forall (m :: * -&gt; *) e a. (MonadBase IO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(Cyclic f -&gt; IO a) -&gt; Cyclic f -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Some (HideEffects f)) -&gt; Cyclic f
forall (f :: [Effect] -&gt; * -&gt; *).
NonEmpty (Some (HideEffects f)) -&gt; Cyclic f
</span><a href="Rock.Memo.html#Cyclic"><span class="hs-identifier hs-var">Cyclic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HideEffects f a -&gt; Some (HideEffects f)
forall {k} (tag :: k -&gt; *) (a :: k). tag a -&gt; Some tag
</span><span class="hs-identifier hs-var">Some</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161939"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Some (HideEffects f)
-&gt; NonEmpty (Some (HideEffects f))
-&gt; NonEmpty (Some (HideEffects f))
forall a. a -&gt; NonEmpty a -&gt; NonEmpty a
</span><span class="hs-operator hs-var">&lt;|</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Some (HideEffects f))
</span><a href="#local-6989586621680161959"><span class="hs-identifier hs-var">childTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">unsafeEff_</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-209"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">modifyMVar_</span></span><span> </span><span class="annot"><a href="#local-6989586621680161956"><span class="hs-identifier hs-type">waitVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-210"></span><span>                    </span><span class="annot"><span class="annottext">Maybe [ThreadId]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO (Maybe [ThreadId])
forall a t. (HasCallStack, IsText t) =&gt; t -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;impossible: waitVar empty&quot;</span></span><span>
</span><span id="line-211"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680161965"><span class="annot"><span class="annottext">[ThreadId]
</span><a href="#local-6989586621680161965"><span class="hs-identifier hs-var">waitingThreads</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-212"></span><span>                        </span><span class="annot"><span class="annottext">IORef (HashMap ThreadId ThreadId)
-&gt; (HashMap ThreadId ThreadId -&gt; (HashMap ThreadId ThreadId, ()))
-&gt; IO ()
forall (m :: * -&gt; *) a b.
MonadBase IO m =&gt;
IORef a -&gt; (a -&gt; (a, b)) -&gt; m b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="annot"><span class="annottext">IORef (HashMap ThreadId ThreadId)
</span><a href="#local-6989586621680161936"><span class="hs-identifier hs-var">depsVar</span></a></span><span> </span><span class="annot"><span class="annottext">((HashMap ThreadId ThreadId -&gt; (HashMap ThreadId ThreadId, ()))
 -&gt; IO ())
-&gt; (HashMap ThreadId ThreadId -&gt; (HashMap ThreadId ThreadId, ()))
-&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680161966"><span class="annot"><span class="annottext">HashMap ThreadId ThreadId
</span><a href="#local-6989586621680161966"><span class="hs-identifier hs-var">deps</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-213"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ThreadId
 -&gt; HashMap ThreadId ThreadId -&gt; HashMap ThreadId ThreadId)
-&gt; HashMap ThreadId ThreadId
-&gt; [ThreadId]
-&gt; HashMap ThreadId ThreadId
forall (f :: * -&gt; *) a b.
Foldable f =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; f a -&gt; b
</span><span class="hs-identifier hs-var">flipfoldl'</span></span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; HashMap ThreadId ThreadId -&gt; HashMap ThreadId ThreadId
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HashMap.delete</span></span><span> </span><span class="annot"><span class="annottext">HashMap ThreadId ThreadId
</span><a href="#local-6989586621680161966"><span class="hs-identifier hs-var">deps</span></a></span><span> </span><span class="annot"><span class="annottext">[ThreadId]
</span><a href="#local-6989586621680161965"><span class="hs-identifier hs-var">waitingThreads</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>                        </span><span class="annot"><span class="annottext">Maybe [ThreadId] -&gt; IO (Maybe [ThreadId])
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe [ThreadId]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">atomicModifyIORef'</span></span><span> </span><span class="annot"><a href="#local-6989586621680161935"><span class="hs-identifier hs-type">startedVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680161969"><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680161969"><span class="hs-identifier hs-var">started''</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-217"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HideEffects f a
-&gt; MemoEntry a
-&gt; DHashMap (HideEffects f) MemoEntry
-&gt; DHashMap (HideEffects f) MemoEntry
forall (k :: * -&gt; *) a (v :: * -&gt; *).
(GEq k, Hashable (Some k)) =&gt;
k a -&gt; v a -&gt; DHashMap k v -&gt; DHashMap k v
</span><span class="hs-identifier hs-var">DHashMap.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161939"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; MemoEntry a
forall a. a -&gt; MemoEntry a
</span><a href="Rock.Memo.html#Done"><span class="hs-identifier hs-var">Done</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680161957"><span class="hs-identifier hs-var">value</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680161969"><span class="hs-identifier hs-var">started''</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">putMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621680161955"><span class="hs-identifier hs-type">valueVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621680161957"><span class="hs-identifier hs-type">value</span></a></span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621680161957"><span class="hs-identifier hs-type">value</span></a></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>        </span><span id="local-6989586621680161952"><span class="annot"><span class="annottext">waitFor :: MemoEntry a -&gt; Eff es a
</span><a href="#local-6989586621680161952"><span class="hs-identifier hs-var hs-var">waitFor</span></a></span></span><span> </span><span id="local-6989586621680161971"><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680161971"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680161971"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-225"></span><span>                </span><span class="annot"><a href="Rock.Memo.html#Started"><span class="hs-identifier hs-type">Started</span></a></span><span> </span><span id="local-6989586621680161972"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621680161972"><span class="hs-identifier hs-var">onThread</span></a></span></span><span> </span><span id="local-6989586621680161973"><span class="annot"><span class="annottext">MVar (Maybe a)
</span><a href="#local-6989586621680161973"><span class="hs-identifier hs-var">valueVar</span></a></span></span><span> </span><span id="local-6989586621680161974"><span class="annot"><span class="annottext">MVar (Maybe [ThreadId])
</span><a href="#local-6989586621680161974"><span class="hs-identifier hs-var">waitVar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-226"></span><span>                    </span><span id="local-6989586621680161975"><span class="annot"><a href="#local-6989586621680161975"><span class="hs-identifier hs-var">threadId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId -&gt; Eff es ThreadId
forall a (es :: [Effect]). IO a -&gt; Eff es a
</span><span class="hs-identifier hs-var">unsafeEff_</span></span><span> </span><span class="annot"><span class="annottext">IO ThreadId
forall (m :: * -&gt; *). MonadBase IO m =&gt; m ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-227"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">unsafeEff_</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">modifyMVar_</span></span><span> </span><span class="annot"><a href="#local-6989586621680161974"><span class="hs-identifier hs-type">waitVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680161976"><span class="annot"><span class="annottext">Maybe [ThreadId]
</span><a href="#local-6989586621680161976"><span class="hs-identifier hs-var">maybeWaitingThreads</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-228"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [ThreadId]
</span><a href="#local-6989586621680161976"><span class="hs-identifier hs-var">maybeWaitingThreads</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-229"></span><span>                            </span><span class="annot"><span class="annottext">Maybe [ThreadId]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-230"></span><span>                                </span><span class="annot"><span class="annottext">Maybe [ThreadId] -&gt; IO (Maybe [ThreadId])
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe [ThreadId]
</span><a href="#local-6989586621680161976"><span class="hs-identifier hs-var">maybeWaitingThreads</span></a></span><span>
</span><span id="line-231"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680161977"><span class="annot"><span class="annottext">[ThreadId]
</span><a href="#local-6989586621680161977"><span class="hs-identifier hs-var">waitingThreads</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>                                </span><span class="annot"><span class="annottext">IO (IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span> </span><span class="annot"><span class="annottext">(IO (IO ()) -&gt; IO ()) -&gt; IO (IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (HashMap ThreadId ThreadId)
-&gt; (HashMap ThreadId ThreadId
    -&gt; (HashMap ThreadId ThreadId, IO ()))
-&gt; IO (IO ())
forall (m :: * -&gt; *) a b.
MonadBase IO m =&gt;
IORef a -&gt; (a -&gt; (a, b)) -&gt; m b
</span><span class="hs-identifier hs-var">atomicModifyIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (HashMap ThreadId ThreadId)
</span><a href="#local-6989586621680161936"><span class="hs-identifier hs-var">depsVar</span></a></span><span> </span><span class="annot"><span class="annottext">((HashMap ThreadId ThreadId -&gt; (HashMap ThreadId ThreadId, IO ()))
 -&gt; IO (IO ()))
-&gt; (HashMap ThreadId ThreadId
    -&gt; (HashMap ThreadId ThreadId, IO ()))
-&gt; IO (IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680161978"><span class="annot"><span class="annottext">HashMap ThreadId ThreadId
</span><a href="#local-6989586621680161978"><span class="hs-identifier hs-var">deps</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-233"></span><span>                                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680161979"><span class="annot"><span class="annottext">deps' :: HashMap ThreadId ThreadId
</span><a href="#local-6989586621680161979"><span class="hs-identifier hs-var hs-var">deps'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ThreadId
-&gt; ThreadId
-&gt; HashMap ThreadId ThreadId
-&gt; HashMap ThreadId ThreadId
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HashMap.insert</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621680161975"><span class="hs-identifier hs-var">threadId</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621680161972"><span class="hs-identifier hs-var">onThread</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap ThreadId ThreadId
</span><a href="#local-6989586621680161978"><span class="hs-identifier hs-var">deps</span></a></span><span>
</span><span id="line-234"></span><span>                                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; HashMap ThreadId ThreadId -&gt; Bool
forall {t}. Hashable t =&gt; t -&gt; HashMap t t -&gt; Bool
</span><a href="#local-6989586621680161981"><span class="hs-identifier hs-var">detectCycle</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621680161975"><span class="hs-identifier hs-var">threadId</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap ThreadId ThreadId
</span><a href="#local-6989586621680161979"><span class="hs-identifier hs-var">deps'</span></a></span><span>
</span><span id="line-235"></span><span>                                        </span><span class="hs-keyword">then</span><span>
</span><span id="line-236"></span><span>                                            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">HashMap ThreadId ThreadId
</span><a href="#local-6989586621680161978"><span class="hs-identifier hs-var">deps</span></a></span><span> </span><span class="hs-comment">-- crashing, so don't care about updated deps</span><span>
</span><span id="line-237"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-238"></span><span>                                                </span><span class="hs-comment">-- find the cycle chain</span><span>
</span><span id="line-239"></span><span>                                                </span><span id="local-6989586621680161982"><span class="annot"><a href="#local-6989586621680161982"><span class="hs-identifier hs-var">started</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MemoEntry)
-&gt; IO (DHashMap (HideEffects f) MemoEntry)
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; IORef a -&gt; m a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (DHashMap (HideEffects f) MemoEntry)
</span><a href="#local-6989586621680161935"><span class="hs-identifier hs-var">startedVar</span></a></span><span>
</span><span id="line-240"></span><span>                                                </span><span class="hs-comment">-- find the key corresponding to the 'entry' we are stuck on</span><span>
</span><span id="line-241"></span><span>                                                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680161983"><span class="annot"><a href="#local-6989586621680161983"><span class="hs-identifier hs-var hs-var">targetKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemoEntry a
-&gt; DHashMap (HideEffects f) MemoEntry
-&gt; Maybe (Some (HideEffects f))
forall a.
MemoEntry a
-&gt; DHashMap (HideEffects f) MemoEntry
-&gt; Maybe (Some (HideEffects f))
</span><a href="#local-6989586621680161984"><span class="hs-identifier hs-var">findKeyByEntry</span></a></span><span> </span><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680161971"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">DHashMap (HideEffects f) MemoEntry
</span><a href="#local-6989586621680161982"><span class="hs-identifier hs-var">started</span></a></span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span>                                                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680161983"><span class="hs-identifier hs-type">targetKey</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-244"></span><span>                                                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680161985"><span class="annot"><span class="annottext">Some (HideEffects f)
</span><a href="#local-6989586621680161985"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-245"></span><span>                                                        </span><span class="annot"><span class="annottext">Cyclic f -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadBase IO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(Cyclic f -&gt; IO ()) -&gt; Cyclic f -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Some (HideEffects f)) -&gt; Cyclic f
forall (f :: [Effect] -&gt; * -&gt; *).
NonEmpty (Some (HideEffects f)) -&gt; Cyclic f
</span><a href="Rock.Memo.html#Cyclic"><span class="hs-identifier hs-var">Cyclic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HideEffects f a -&gt; Some (HideEffects f)
forall {k} (tag :: k -&gt; *) (a :: k). tag a -&gt; Some tag
</span><span class="hs-identifier hs-var">Some</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es a -&gt; HideEffects f a
forall (f :: [Effect] -&gt; * -&gt; *) (b :: [Effect]) a.
f b a -&gt; HideEffects f a
</span><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680161939"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Some (HideEffects f)
-&gt; [Some (HideEffects f)] -&gt; NonEmpty (Some (HideEffects f))
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Some (HideEffects f)
</span><a href="#local-6989586621680161985"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>                                                    </span><span class="annot"><span class="annottext">Maybe (Some (HideEffects f))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-247"></span><span>                                                        </span><span class="annot"><span class="annottext">Text -&gt; IO ()
forall a t. (HasCallStack, IsText t) =&gt; t -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Cycle detected but target key disappeared&quot;</span></span><span>
</span><span id="line-248"></span><span>                                            </span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>                                        </span><span class="hs-keyword">else</span><span>
</span><span id="line-250"></span><span>                                            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">HashMap ThreadId ThreadId
</span><a href="#local-6989586621680161979"><span class="hs-identifier hs-var">deps'</span></a></span><span>
</span><span id="line-251"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO ()
forall (f :: * -&gt; *). Applicative f =&gt; f ()
</span><span class="hs-identifier hs-var">pass</span></span><span>
</span><span id="line-252"></span><span>                                            </span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>                                </span><span class="annot"><span class="annottext">Maybe [ThreadId] -&gt; IO (Maybe [ThreadId])
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe [ThreadId] -&gt; IO (Maybe [ThreadId]))
-&gt; Maybe [ThreadId] -&gt; IO (Maybe [ThreadId])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ThreadId] -&gt; Maybe [ThreadId]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">([ThreadId] -&gt; Maybe [ThreadId]) -&gt; [ThreadId] -&gt; Maybe [ThreadId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621680161975"><span class="hs-identifier hs-var">threadId</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; [ThreadId] -&gt; [ThreadId]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ThreadId]
</span><a href="#local-6989586621680161977"><span class="hs-identifier hs-var">waitingThreads</span></a></span><span>
</span><span id="line-254"></span><span>                    </span><span id="local-6989586621680161988"><span class="annot"><a href="#local-6989586621680161988"><span class="hs-identifier hs-var">maybeValue</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unsafeEff_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">readMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621680161973"><span class="hs-identifier hs-type">valueVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161938"><span class="hs-identifier hs-type">rules'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161939"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621680161988"><span class="hs-identifier hs-type">maybeValue</span></a></span><span>
</span><span id="line-256"></span><span>                </span><span class="annot"><a href="Rock.Memo.html#Done"><span class="hs-identifier hs-type">Done</span></a></span><span> </span><span id="local-6989586621680161990"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680161990"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-257"></span><span>                    </span><span class="annot"><span class="annottext">a -&gt; Eff es a
forall a. a -&gt; Eff es a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680161990"><span class="hs-identifier hs-var">value</span></a></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-comment">-- Helper to reverse lookup the key for a specific entry</span><span>
</span><span id="line-260"></span><span>    </span><span id="local-6989586621680161502"><span class="annot"><a href="#local-6989586621680161984"><span class="hs-identifier hs-type">findKeyByEntry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Rock.Memo.html#MemoEntry"><span class="hs-identifier hs-type">MemoEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161502"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DHashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161446"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Rock.Memo.html#MemoEntry"><span class="hs-identifier hs-type">MemoEntry</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Some</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161446"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-261"></span><span>    </span><span id="local-6989586621680161984"><span class="annot"><span class="annottext">findKeyByEntry :: forall a.
MemoEntry a
-&gt; DHashMap (HideEffects f) MemoEntry
-&gt; Maybe (Some (HideEffects f))
</span><a href="#local-6989586621680161984"><span class="hs-identifier hs-var hs-var">findKeyByEntry</span></a></span></span><span> </span><span id="local-6989586621680161991"><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680161991"><span class="hs-identifier hs-var">targetEntry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-262"></span><span>        </span><span class="annot"><span class="annottext">(forall a.
 HideEffects f a
 -&gt; MemoEntry a
 -&gt; Maybe (Some (HideEffects f))
 -&gt; Maybe (Some (HideEffects f)))
-&gt; Maybe (Some (HideEffects f))
-&gt; DHashMap (HideEffects f) MemoEntry
-&gt; Maybe (Some (HideEffects f))
forall (k :: * -&gt; *) (v :: * -&gt; *) b.
(forall a. k a -&gt; v a -&gt; b -&gt; b) -&gt; b -&gt; DHashMap k v -&gt; b
</span><span class="hs-identifier hs-var">DHashMap.foldrWithKey</span></span><span>
</span><span id="line-263"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680161995"><span class="annot"><span class="annottext">HideEffects f a
</span><a href="#local-6989586621680161995"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621680161996"><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680161996"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621680161997"><span class="annot"><span class="annottext">Maybe (Some (HideEffects f))
</span><a href="#local-6989586621680161997"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-264"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680161996"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MemoEntry a
</span><a href="#local-6989586621680161991"><span class="hs-identifier hs-var">targetEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-265"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="Rock.Memo.html#Started"><span class="hs-identifier hs-type">Started</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680161998"><span class="annot"><span class="annottext">MVar (Maybe a)
</span><a href="#local-6989586621680161998"><span class="hs-identifier hs-var">vVar1</span></a></span></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe [ThreadId])
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Rock.Memo.html#Started"><span class="hs-identifier hs-type">Started</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680161999"><span class="annot"><span class="annottext">MVar (Maybe a)
</span><a href="#local-6989586621680161999"><span class="hs-identifier hs-var">vVar2</span></a></span></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe [ThreadId])
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MVar (Maybe a) -&gt; MVar (Maybe a)
forall a b. a -&gt; b
</span><span class="hs-identifier hs-var">unsafeCoerce</span></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe a)
</span><a href="#local-6989586621680161998"><span class="hs-identifier hs-var">vVar1</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe a) -&gt; MVar (Maybe a) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe a)
</span><a href="#local-6989586621680161999"><span class="hs-identifier hs-var">vVar2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Some (HideEffects f) -&gt; Maybe (Some (HideEffects f))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HideEffects f a -&gt; Some (HideEffects f)
forall {k} (tag :: k -&gt; *) (a :: k). tag a -&gt; Some tag
</span><span class="hs-identifier hs-var">Some</span></span><span> </span><span class="annot"><span class="annottext">HideEffects f a
</span><a href="#local-6989586621680161995"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>                    </span><span class="annot"><span class="annottext">(MemoEntry a, MemoEntry a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Some (HideEffects f))
</span><a href="#local-6989586621680161997"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-268"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Some (HideEffects f))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span>    </span><span id="local-6989586621680161981"><span class="annot"><span class="annottext">detectCycle :: t -&gt; HashMap t t -&gt; Bool
</span><a href="#local-6989586621680161981"><span class="hs-identifier hs-var hs-var">detectCycle</span></a></span></span><span> </span><span id="local-6989586621680162007"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680162007"><span class="hs-identifier hs-var">threadId</span></a></span></span><span> </span><span id="local-6989586621680162008"><span class="annot"><span class="annottext">HashMap t t
</span><a href="#local-6989586621680162008"><span class="hs-identifier hs-var">deps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-272"></span><span>        </span><span class="annot"><span class="annottext">t -&gt; Bool
</span><a href="#local-6989586621680162009"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680162007"><span class="hs-identifier hs-var">threadId</span></a></span><span>
</span><span id="line-273"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-274"></span><span>        </span><span id="local-6989586621680162009"><span class="annot"><span class="annottext">go :: t -&gt; Bool
</span><a href="#local-6989586621680162009"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621680162010"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680162010"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-275"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">t -&gt; HashMap t t -&gt; Maybe t
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680162010"><span class="hs-identifier hs-var">tid</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap t t
</span><a href="#local-6989586621680162008"><span class="hs-identifier hs-var">deps</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-276"></span><span>                </span><span class="annot"><span class="annottext">Maybe t
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-277"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680162012"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680162012"><span class="hs-identifier hs-var">dep</span></a></span></span><span>
</span><span id="line-278"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680162012"><span class="hs-identifier hs-var">dep</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680162007"><span class="hs-identifier hs-var">threadId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-279"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">t -&gt; Bool
</span><a href="#local-6989586621680162009"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680162012"><span class="hs-identifier hs-var">dep</span></a></span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span class="annot"><span class="hs-comment">{- | Internal helper to catch exceptions without requiring 'IOE'.
This is safe here because we are building infrastructure that we know runs in IO,
but we don't want to leak that implementation detail to the type signature, as then
every query could perform IO actions.
-}</span></span><span>
</span><span id="line-286"></span><span id="local-6989586621680161471"><span id="local-6989586621680161472"><span id="local-6989586621680161473"><span class="annot"><a href="Rock.Memo.html#unsafeCatch"><span class="hs-identifier hs-type">unsafeCatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="#local-6989586621680161471"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680161472"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161473"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680161471"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680161472"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161473"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680161472"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680161473"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-287"></span><span id="unsafeCatch"><span class="annot"><span class="annottext">unsafeCatch :: forall e (es :: [Effect]) a.
Exception e =&gt;
Eff es a -&gt; (e -&gt; Eff es a) -&gt; Eff es a
</span><a href="Rock.Memo.html#unsafeCatch"><span class="hs-identifier hs-var hs-var">unsafeCatch</span></a></span></span><span> </span><span id="local-6989586621680162016"><span class="annot"><span class="annottext">Eff es a
</span><a href="#local-6989586621680162016"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621680162017"><span class="annot"><span class="annottext">e -&gt; Eff es a
</span><a href="#local-6989586621680162017"><span class="hs-identifier hs-var">handler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env es -&gt; IO a) -&gt; Eff es a
forall (es :: [Effect]) a. (Env es -&gt; IO a) -&gt; Eff es a
</span><span class="hs-identifier hs-var">unsafeEff</span></span><span> </span><span class="annot"><span class="annottext">((Env es -&gt; IO a) -&gt; Eff es a) -&gt; (Env es -&gt; IO a) -&gt; Eff es a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680162018"><span class="annot"><span class="annottext">Env es
</span><a href="#local-6989586621680162018"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-288"></span><span>    </span><span class="annot"><span class="annottext">Eff es a -&gt; Env es -&gt; IO a
forall (es :: [Effect]) a. Eff es a -&gt; Env es -&gt; IO a
</span><span class="hs-identifier hs-var">unEff</span></span><span> </span><span class="annot"><span class="annottext">Eff es a
</span><a href="#local-6989586621680162016"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Env es
</span><a href="#local-6989586621680162018"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; (e -&gt; IO a) -&gt; IO a
forall (m :: * -&gt; *) e a.
(MonadBaseControl IO m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catch`</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680162020"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621680162020"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Eff es a -&gt; Env es -&gt; IO a
forall (es :: [Effect]) a. Eff es a -&gt; Env es -&gt; IO a
</span><span class="hs-identifier hs-var">unEff</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">e -&gt; Eff es a
</span><a href="#local-6989586621680162017"><span class="hs-identifier hs-var">handler</span></a></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621680162020"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Env es
</span><a href="#local-6989586621680162018"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-289"></span></pre></body></html>