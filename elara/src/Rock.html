<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE QuantifiedConstraints #-}</span><span>
</span><span id="line-2"></span><span class="hs-comment">-- Modified version of the Rock (https://hackage.haskell.org/package/rock) library</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- with effectful support added</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- Credit to https://gist.github.com/expipiplus1/cfd5c4fb4a5a40338ccf8642fb3d0f1e for the changes!</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-orphans #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Rock.html"><span class="hs-identifier">Rock</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Dependent.HashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">DHashMap</span></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Dependent.HashMap</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DHashMap</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.GADT.Compare</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">GEq</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">geq</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.GADT.Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">GShow</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">gshowsPrec</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef.Lifted</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Kind</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Type</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Some</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Typeable</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Effectful</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Dispatch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Static</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">DispatchOf</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Eff</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Effect</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">IOE</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Subset</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">inject</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">raise</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(:&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Effectful.Dispatch.Static</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SideEffects</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NoSideEffects</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">StaticRep</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">evalStaticRep</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">getStaticRep</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Effectful.Timeout</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Timeout</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">timeout</span></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Show</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">showChar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">showParen</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">showString</span></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unsafe.Coerce</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafeCoerce</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Prelude.html"><span class="hs-identifier">Prelude</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">atomicModifyIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readIORef</span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="annot"><span class="hs-comment">-- * Types</span></span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="hs-keyword">type</span><span> </span><span id="Rules"><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-var">Rules</span></a></span></span><span> </span><span id="local-6989586621680047589"><span class="annot"><a href="#local-6989586621680047589"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047590"><span class="annot"><a href="#local-6989586621680047590"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621680047591"><span class="annot"><a href="#local-6989586621680047591"><span class="hs-identifier hs-type">es</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680047589"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047591"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047590"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680047591"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047590"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">data</span><span> </span><span id="Rock"><span class="annot"><a href="Rock.html#Rock"><span class="hs-identifier hs-var">Rock</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680047592"><span class="annot"><a href="#local-6989586621680047592"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Effect</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Effect</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="DispatchOf"><span class="annot"><span class="hs-identifier hs-var">DispatchOf</span></span></span><span> </span><span id="local-6989586621680047593"><span class="hs-special">(</span><span class="annot"><a href="Rock.html#Rock"><span class="hs-identifier hs-type">Rock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047593"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Static</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoSideEffects</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">newtype</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="StaticRep"><span class="annot"><span class="hs-identifier hs-var">StaticRep</span></span></span><span> </span><span id="local-6989586621680047390"><span class="hs-special">(</span><span class="annot"><a href="Rock.html#Rock"><span class="hs-identifier hs-type">Rock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047390"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Rock"><span class="annot"><a href="Rock.html#Rock"><span class="hs-identifier hs-var">Rock</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047392"><span class="annot"><a href="#local-6989586621680047392"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621680047391"><span class="annot"><a href="#local-6989586621680047391"><span class="hs-identifier hs-type">es</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680047390"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047391"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047392"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680047391"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047392"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span id="local-6989586621680047366"><span id="local-6989586621680047369"><span id="local-6989586621680047370"><span class="annot"><a href="Rock.html#runRock"><span class="hs-identifier hs-type">runRock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047366"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#Rock"><span class="hs-identifier hs-type">Rock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047366"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621680047369"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680047370"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680047369"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047370"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-35"></span><span id="runRock"><span class="annot"><span class="annottext">runRock :: forall (f :: [Effect] -&gt; * -&gt; *) (es :: [Effect]) a.
Rules f -&gt; Eff (Rock f : es) a -&gt; Eff es a
</span><a href="Rock.html#runRock"><span class="hs-identifier hs-var hs-var">runRock</span></a></span></span><span> </span><span id="local-6989586621680047602"><span class="annot"><span class="annottext">Rules f
</span><a href="#local-6989586621680047602"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticRep (Rock f) -&gt; Eff (Rock f : es) a -&gt; Eff es a
forall (e :: Effect) (sideEffects :: SideEffects) (es :: [Effect])
       a.
(HasCallStack, DispatchOf e ~ 'Static sideEffects,
 MaybeIOE sideEffects es) =&gt;
StaticRep e -&gt; Eff (e : es) a -&gt; Eff es a
</span><span class="hs-identifier hs-var">evalStaticRep</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rules f -&gt; StaticRep (Rock f)
forall (f :: [Effect] -&gt; * -&gt; *).
(forall a (es :: [Effect]). HasCallStack =&gt; f es a -&gt; Eff es a)
-&gt; StaticRep (Rock f)
</span><a href="Rock.html#Rock"><span class="hs-identifier hs-var">Rock</span></a></span><span> </span><span class="annot"><span class="annottext">f es a -&gt; Eff es a
Rules f
</span><a href="#local-6989586621680047602"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span id="local-6989586621680047395"><span id="local-6989586621680047396"><span id="local-6989586621680047398"><span id="local-6989586621680047400"><span class="annot"><a href="Rock.html#fetch"><span class="hs-identifier hs-type">fetch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Subset</span></span><span> </span><span class="annot"><a href="#local-6989586621680047395"><span class="hs-identifier hs-type">xs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047396"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Rock.html#Rock"><span class="hs-identifier hs-type">Rock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047398"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680047396"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680047398"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047395"><span class="hs-identifier hs-type">xs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047400"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680047396"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047400"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-38"></span><span id="fetch"><span class="annot"><span class="annottext">fetch :: forall (xs :: [Effect]) (es :: [Effect]) (f :: [Effect] -&gt; * -&gt; *)
       a.
(Subset xs es, Rock f :&gt; es, HasCallStack) =&gt;
f xs a -&gt; Eff es a
</span><a href="Rock.html#fetch"><span class="hs-identifier hs-var hs-var">fetch</span></a></span></span><span> </span><span id="local-6989586621680047620"><span class="annot"><span class="annottext">f xs a
</span><a href="#local-6989586621680047620"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="Rock.html#Rock"><span class="hs-identifier hs-type">Rock</span></a></span><span> </span><span id="local-6989586621680047621"><span class="annot"><a href="#local-6989586621680047621"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff es (StaticRep (Rock f))
forall (e :: Effect) (sideEffects :: SideEffects) (es :: [Effect]).
(HasCallStack, DispatchOf e ~ 'Static sideEffects, e :&gt; es) =&gt;
Eff es (StaticRep e)
</span><span class="hs-identifier hs-var">getStaticRep</span></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">inject</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680047621"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047620"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="annot"><span class="hs-comment">-- * Running tasks</span></span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-keyword">data</span><span> </span><span id="TimeoutQuery"><span class="annot"><a href="Rock.html#TimeoutQuery"><span class="hs-identifier hs-var">TimeoutQuery</span></a></span></span><span> </span><span id="local-6989586621680047622"><span class="annot"><a href="#local-6989586621680047622"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621680047623"><span class="annot"><a href="#local-6989586621680047623"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680047624"><span class="annot"><a href="#local-6989586621680047624"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-45"></span><span>    </span><span id="local-6989586621680047625"><span id="local-6989586621680047626"><span id="local-6989586621680047627"><span id="TimeoutQuery"><span class="annot"><a href="Rock.html#TimeoutQuery"><span class="hs-identifier hs-var">TimeoutQuery</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680047625"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047626"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047627"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Rock.html#TimeoutQuery"><span class="hs-identifier hs-type">TimeoutQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047625"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Timeout</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621680047626"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621680047627"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span id="local-6989586621680047413"><span class="annot"><a href="Rock.html#timeoutRules"><span class="hs-identifier hs-type">timeoutRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047413"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Rock.html#Rules"><span class="hs-identifier hs-type">Rules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#TimeoutQuery"><span class="hs-identifier hs-type">TimeoutQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047413"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-48"></span><span id="timeoutRules"><span class="annot"><span class="annottext">timeoutRules :: forall (f :: [Effect] -&gt; * -&gt; *). Rules f -&gt; Rules (TimeoutQuery f)
</span><a href="Rock.html#timeoutRules"><span class="hs-identifier hs-var hs-var">timeoutRules</span></a></span></span><span> </span><span id="local-6989586621680047631"><span class="annot"><span class="annottext">Rules f
</span><a href="#local-6989586621680047631"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#TimeoutQuery"><span class="hs-identifier hs-type">TimeoutQuery</span></a></span><span> </span><span id="local-6989586621680047651"><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680047651"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680047652"><span class="annot"><span class="annottext">a :: Eff es a
</span><a href="#local-6989586621680047652"><span class="hs-identifier hs-var hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">f es a -&gt; Eff es a
Rules f
</span><a href="#local-6989586621680047631"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">f es a
</span><a href="#local-6989586621680047651"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; Eff es a -&gt; Eff es (Maybe a)
forall (es :: [Effect]) a.
(Timeout :&gt; es) =&gt;
Int -&gt; Eff es a -&gt; Eff es (Maybe a)
</span><span class="hs-identifier hs-var">timeout</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1000000</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Eff es a -&gt; Eff es a
forall (subEs :: [Effect]) (es :: [Effect]) a.
Subset subEs es =&gt;
Eff subEs a -&gt; Eff es a
</span><span class="hs-identifier hs-var">inject</span></span><span> </span><span class="annot"><span class="annottext">Eff es a
</span><a href="#local-6989586621680047652"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="annot"><span class="hs-comment">-- * Task combinators</span></span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-comment">--</span><span>
</span><span id="line-57"></span><span class="hs-keyword">data</span><span> </span><span id="IOQuery"><span class="annot"><a href="Rock.html#IOQuery"><span class="hs-identifier hs-var">IOQuery</span></a></span></span><span> </span><span id="local-6989586621680047653"><span class="annot"><a href="#local-6989586621680047653"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621680047654"><span class="annot"><a href="#local-6989586621680047654"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680047655"><span class="annot"><a href="#local-6989586621680047655"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-58"></span><span>    </span><span id="local-6989586621680047656"><span id="local-6989586621680047657"><span id="local-6989586621680047658"><span id="IOQuery"><span class="annot"><a href="Rock.html#IOQuery"><span class="hs-identifier hs-var">IOQuery</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680047656"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047657"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047658"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Rock.html#IOQuery"><span class="hs-identifier hs-type">IOQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047656"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IOE</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621680047657"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680047658"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="annot"><span class="hs-comment">-- | Track the query dependencies of a 'Task' in a 'DHashMap'.</span></span><span>
</span><span id="line-61"></span><span class="annot"><a href="Rock.html#track"><span class="hs-identifier hs-type">track</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047443"><span class="annot"><a href="#local-6989586621680047443"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621680047442"><span class="annot"><a href="#local-6989586621680047442"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680047437"><span class="annot"><a href="#local-6989586621680047437"><span class="hs-identifier hs-type">k</span></a></span></span><span> </span><span id="local-6989586621680047446"><span class="annot"><a href="#local-6989586621680047446"><span class="hs-identifier hs-type">g</span></a></span></span><span> </span><span id="local-6989586621680047447"><span class="annot"><a href="#local-6989586621680047447"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GEq</span></span><span> </span><span class="annot"><a href="#local-6989586621680047437"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Some</span></span><span> </span><span class="annot"><a href="#local-6989586621680047437"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IOE</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680047442"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Rock.html#Rock"><span class="hs-identifier hs-type">Rock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047443"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680047442"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047444"><span class="annot"><a href="#local-6989586621680047444"><span class="hs-identifier hs-type">es'</span></a></span></span><span> </span><span id="local-6989586621680047445"><span class="annot"><a href="#local-6989586621680047445"><span class="hs-identifier hs-type">a'</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621680047443"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047444"><span class="hs-identifier hs-type">es'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047445"><span class="hs-identifier hs-type">a'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680047445"><span class="hs-identifier hs-type">a'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680047437"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047445"><span class="hs-identifier hs-type">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680047446"><span class="hs-identifier hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047445"><span class="hs-identifier hs-type">a'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680047442"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047447"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-66"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680047442"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680047447"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DHashMap</span></span><span> </span><span class="annot"><a href="#local-6989586621680047437"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047446"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span id="track"><span class="annot"><span class="annottext">track :: forall (f :: [Effect] -&gt; * -&gt; *) (es :: [Effect]) (k :: * -&gt; *)
       (g :: * -&gt; *) a.
(GEq k, Hashable (Some k), IOE :&gt; es, Rock f :&gt; es) =&gt;
(forall (es' :: [Effect]) a'. f es' a' -&gt; a' -&gt; (k a', g a'))
-&gt; Eff es a -&gt; Eff es (a, DHashMap k g)
</span><a href="Rock.html#track"><span class="hs-identifier hs-var hs-var">track</span></a></span></span><span> </span><span id="local-6989586621680047669"><span class="annot"><span class="annottext">forall (es' :: [Effect]) a'. f es' a' -&gt; a' -&gt; (k a', g a')
</span><a href="#local-6989586621680047669"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall (es' :: [Effect]) a'.
 f es' a' -&gt; a' -&gt; Eff es' (k a', g a'))
-&gt; Eff es a -&gt; Eff es (a, DHashMap k g)
forall (f :: [Effect] -&gt; * -&gt; *) (es :: [Effect]) (k :: * -&gt; *)
       (g :: * -&gt; *) a.
(GEq k, Hashable (Some k), IOE :&gt; es, Rock f :&gt; es) =&gt;
(forall (es' :: [Effect]) a'.
 f es' a' -&gt; a' -&gt; Eff es' (k a', g a'))
-&gt; Eff es a -&gt; Eff es (a, DHashMap k g)
</span><a href="Rock.html#trackM"><span class="hs-identifier hs-var">trackM</span></a></span><span> </span><span class="annot"><span class="annottext">((forall (es' :: [Effect]) a'.
  f es' a' -&gt; a' -&gt; Eff es' (k a', g a'))
 -&gt; Eff es a -&gt; Eff es (a, DHashMap k g))
-&gt; (forall (es' :: [Effect]) a'.
    f es' a' -&gt; a' -&gt; Eff es' (k a', g a'))
-&gt; Eff es a
-&gt; Eff es (a, DHashMap k g)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680047673"><span class="annot"><span class="annottext">f es' a'
</span><a href="#local-6989586621680047673"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621680047674"><span class="annot"><span class="annottext">a'
</span><a href="#local-6989586621680047674"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(k a', g a') -&gt; Eff es' (k a', g a')
forall a. a -&gt; Eff es' a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f es' a' -&gt; a' -&gt; (k a', g a')
forall (es' :: [Effect]) a'. f es' a' -&gt; a' -&gt; (k a', g a')
</span><a href="#local-6989586621680047669"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">f es' a'
</span><a href="#local-6989586621680047673"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">a'
</span><a href="#local-6989586621680047674"><span class="hs-identifier hs-var">value</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="annot"><a href="Rock.html#trackM"><span class="hs-identifier hs-type">trackM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047458"><span class="annot"><a href="#local-6989586621680047458"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621680047457"><span class="annot"><a href="#local-6989586621680047457"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680047456"><span class="annot"><a href="#local-6989586621680047456"><span class="hs-identifier hs-type">k</span></a></span></span><span> </span><span id="local-6989586621680047459"><span class="annot"><a href="#local-6989586621680047459"><span class="hs-identifier hs-type">g</span></a></span></span><span> </span><span id="local-6989586621680047460"><span class="annot"><a href="#local-6989586621680047460"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GEq</span></span><span> </span><span class="annot"><a href="#local-6989586621680047456"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Some</span></span><span> </span><span class="annot"><a href="#local-6989586621680047456"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IOE</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680047457"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Rock.html#Rock"><span class="hs-identifier hs-type">Rock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047458"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680047457"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047453"><span class="annot"><a href="#local-6989586621680047453"><span class="hs-identifier hs-type">es'</span></a></span></span><span> </span><span id="local-6989586621680047454"><span class="annot"><a href="#local-6989586621680047454"><span class="hs-identifier hs-type">a'</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621680047458"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047453"><span class="hs-identifier hs-type">es'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047454"><span class="hs-identifier hs-type">a'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680047454"><span class="hs-identifier hs-type">a'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680047453"><span class="hs-identifier hs-type">es'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680047456"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047454"><span class="hs-identifier hs-type">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680047459"><span class="hs-identifier hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047454"><span class="hs-identifier hs-type">a'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680047457"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047460"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680047457"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680047460"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DHashMap</span></span><span> </span><span class="annot"><a href="#local-6989586621680047456"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047459"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span id="trackM"><span class="annot"><span class="annottext">trackM :: forall (f :: [Effect] -&gt; * -&gt; *) (es :: [Effect]) (k :: * -&gt; *)
       (g :: * -&gt; *) a.
(GEq k, Hashable (Some k), IOE :&gt; es, Rock f :&gt; es) =&gt;
(forall (es' :: [Effect]) a'.
 f es' a' -&gt; a' -&gt; Eff es' (k a', g a'))
-&gt; Eff es a -&gt; Eff es (a, DHashMap k g)
</span><a href="Rock.html#trackM"><span class="hs-identifier hs-var hs-var">trackM</span></a></span></span><span> </span><span id="local-6989586621680047689"><span class="annot"><span class="annottext">forall (es' :: [Effect]) a'. f es' a' -&gt; a' -&gt; Eff es' (k a', g a')
</span><a href="#local-6989586621680047689"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621680047690"><span class="annot"><span class="annottext">Eff es a
</span><a href="#local-6989586621680047690"><span class="hs-identifier hs-var">task</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-76"></span><span>    </span><span id="local-6989586621680047691"><span class="annot"><a href="#local-6989586621680047691"><span class="hs-identifier hs-var">depsVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DHashMap k g -&gt; Eff es (IORef (DHashMap k g))
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; a -&gt; m (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">DHashMap k g
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-78"></span><span>        </span><span class="annot"><a href="#local-6989586621680047693"><span class="hs-identifier hs-type">record'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-79"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047484"><span class="annot"><a href="#local-6989586621680047484"><span class="hs-identifier hs-type">a'</span></a></span></span><span> </span><span id="local-6989586621680047483"><span class="annot"><a href="#local-6989586621680047483"><span class="hs-identifier hs-type">es'</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621680047458"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047483"><span class="hs-identifier hs-type">es'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047484"><span class="hs-identifier hs-type">a'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680047483"><span class="hs-identifier hs-type">es'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047484"><span class="hs-identifier hs-type">a'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-80"></span><span>              </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047486"><span class="annot"><a href="#local-6989586621680047486"><span class="hs-identifier hs-type">a'</span></a></span></span><span> </span><span id="local-6989586621680047485"><span class="annot"><a href="#local-6989586621680047485"><span class="hs-identifier hs-type">es'</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#IOQuery"><span class="hs-identifier hs-type">IOQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047458"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680047485"><span class="hs-identifier hs-type">es'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047486"><span class="hs-identifier hs-type">a'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680047485"><span class="hs-identifier hs-type">es'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047486"><span class="hs-identifier hs-type">a'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>        </span><span id="local-6989586621680047693"><span class="annot"><a href="#local-6989586621680047693"><span class="hs-identifier hs-var hs-var">record'</span></a></span></span><span> </span><span id="local-6989586621680047694"><span class="annot"><span class="annottext">forall a' (es' :: [Effect]). f es' a' -&gt; Eff es' a'
</span><a href="#local-6989586621680047694"><span class="hs-identifier hs-var">fetch'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#IOQuery"><span class="hs-identifier hs-type">IOQuery</span></a></span><span> </span><span id="local-6989586621680047707"><span class="annot"><span class="annottext">f es a'
</span><a href="#local-6989586621680047707"><span class="hs-identifier hs-var">key</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-83"></span><span>            </span><span id="local-6989586621680047708"><span class="annot"><a href="#local-6989586621680047708"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff es a' -&gt; Eff (IOE : es) a'
forall (es :: [Effect]) a (e :: Effect). Eff es a -&gt; Eff (e : es) a
</span><span class="hs-identifier hs-var">raise</span></span><span> </span><span class="annot"><span class="annottext">(Eff es a' -&gt; Eff (IOE : es) a') -&gt; Eff es a' -&gt; Eff (IOE : es) a'
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">f es a' -&gt; Eff es a'
forall a' (es' :: [Effect]). f es' a' -&gt; Eff es' a'
</span><a href="#local-6989586621680047694"><span class="hs-identifier hs-var">fetch'</span></a></span><span> </span><span class="annot"><span class="annottext">f es a'
</span><a href="#local-6989586621680047707"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-84"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621680047709"><span class="annot"><a href="#local-6989586621680047709"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680047710"><span class="annot"><a href="#local-6989586621680047710"><span class="hs-identifier hs-var">g</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">raise</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621680047689"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047707"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047708"><span class="hs-identifier hs-type">value</span></a></span><span>
</span><span id="line-85"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">atomicModifyIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621680047691"><span class="hs-identifier hs-type">depsVar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DHashMap.insert</span></span><span> </span><span class="annot"><a href="#local-6989586621680047709"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047710"><span class="hs-identifier hs-type">g</span></a></span><span>
</span><span id="line-86"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621680047708"><span class="hs-identifier hs-type">value</span></a></span><span>
</span><span id="line-87"></span><span>    </span><span id="local-6989586621680047714"><span class="annot"><a href="#local-6989586621680047714"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Rock.html#transRock"><span class="hs-identifier hs-type">transRock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047693"><span class="hs-identifier hs-type">record'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">raise</span></span><span> </span><span class="annot"><a href="#local-6989586621680047690"><span class="hs-identifier hs-type">task</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>    </span><span id="local-6989586621680047716"><span class="annot"><a href="#local-6989586621680047716"><span class="hs-identifier hs-var">deps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621680047691"><span class="hs-identifier hs-type">depsVar</span></a></span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680047714"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680047716"><span class="hs-identifier hs-type">deps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="annot"><a href="Rock.html#transRock"><span class="hs-identifier hs-type">transRock</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047503"><span class="annot"><a href="#local-6989586621680047503"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621680047507"><span class="annot"><a href="#local-6989586621680047507"><span class="hs-identifier hs-type">g</span></a></span></span><span> </span><span id="local-6989586621680047504"><span class="annot"><a href="#local-6989586621680047504"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680047510"><span class="annot"><a href="#local-6989586621680047510"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-93"></span><span>    </span><span class="annot"><a href="Rock.html#Rock"><span class="hs-identifier hs-type">Rock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047503"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680047504"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047506"><span class="annot"><a href="#local-6989586621680047506"><span class="hs-identifier hs-type">a'</span></a></span></span><span> </span><span id="local-6989586621680047505"><span class="annot"><a href="#local-6989586621680047505"><span class="hs-identifier hs-type">es'</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621680047503"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047505"><span class="hs-identifier hs-type">es'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047506"><span class="hs-identifier hs-type">a'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680047505"><span class="hs-identifier hs-type">es'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047506"><span class="hs-identifier hs-type">a'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-95"></span><span>      </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047509"><span class="annot"><a href="#local-6989586621680047509"><span class="hs-identifier hs-type">a'</span></a></span></span><span> </span><span id="local-6989586621680047508"><span class="annot"><a href="#local-6989586621680047508"><span class="hs-identifier hs-type">es'</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621680047507"><span class="hs-identifier hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047508"><span class="hs-identifier hs-type">es'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047509"><span class="hs-identifier hs-type">a'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680047508"><span class="hs-identifier hs-type">es'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047509"><span class="hs-identifier hs-type">a'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#Rock"><span class="hs-identifier hs-type">Rock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047507"><span class="hs-identifier hs-type">g</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621680047504"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680047510"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680047504"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047510"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-99"></span><span id="transRock"><span class="annot"><span class="annottext">transRock :: forall (f :: [Effect] -&gt; * -&gt; *) (g :: [Effect] -&gt; * -&gt; *)
       (es :: [Effect]) a.
(Rock f :&gt; es) =&gt;
((forall a' (es' :: [Effect]). f es' a' -&gt; Eff es' a')
 -&gt; forall a' (es' :: [Effect]). g es' a' -&gt; Eff es' a')
-&gt; Eff (Rock g : es) a -&gt; Eff es a
</span><a href="Rock.html#transRock"><span class="hs-identifier hs-var hs-var">transRock</span></a></span></span><span> </span><span id="local-6989586621680047731"><span class="annot"><span class="annottext">(forall a' (es' :: [Effect]). f es' a' -&gt; Eff es' a')
-&gt; forall a' (es' :: [Effect]). g es' a' -&gt; Eff es' a'
</span><a href="#local-6989586621680047731"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621680047732"><span class="annot"><span class="annottext">Eff (Rock g : es) a
</span><a href="#local-6989586621680047732"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-100"></span><span>    </span><span class="annot"><a href="Rock.html#Rock"><span class="hs-identifier hs-type">Rock</span></a></span><span> </span><span id="local-6989586621680047733"><span class="annot"><a href="#local-6989586621680047733"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (e :: Effect) (sideEffects :: SideEffects) (es :: [Effect]).
(HasCallStack, DispatchOf e ~ 'Static sideEffects, e :&gt; es) =&gt;
Eff es (StaticRep e)
</span><span class="hs-identifier hs-var">getStaticRep</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#Rock"><span class="hs-identifier hs-type">Rock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047503"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">evalStaticRep</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#Rock"><span class="hs-identifier hs-type">Rock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680047731"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047733"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680047732"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="annot"><span class="hs-comment">-- * Utils</span></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="annot"><span class="hs-comment">{- | A GADT for forgetting the effects required for each key
The GEq and Eq instances will unsafeCoerce away information on the Effects,
please don't rely on it.

This is used for using query keys as map keps
-}</span></span><span>
</span><span id="line-111"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Effect</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span>
</span><span id="line-112"></span><span class="hs-keyword">data</span><span> </span><span id="HideEffects"><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span></span><span> </span><span id="local-6989586621680047737"><span class="annot"><a href="#local-6989586621680047737"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621680047738"><span class="annot"><a href="#local-6989586621680047738"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-113"></span><span>    </span><span id="HideEffects"><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-var">HideEffects</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047740"><span class="annot"><a href="#local-6989586621680047740"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621680047741"><span class="annot"><a href="#local-6989586621680047741"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621680047742"><span class="annot"><a href="#local-6989586621680047742"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621680047740"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047741"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047742"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047740"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047742"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680047530"><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047528"><span class="annot"><a href="#local-6989586621680047528"><span class="hs-identifier hs-type">es</span></a></span></span><span> </span><span id="local-6989586621680047529"><span class="annot"><a href="#local-6989586621680047529"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680047530"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047528"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047529"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GShow</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047530"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-116"></span><span>    </span><span id="local-6989586621680047747"><span class="annot"><span class="annottext">gshowsPrec :: forall a. Int -&gt; HideEffects f a -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var">gshowsPrec</span></span></span><span> </span><span id="local-6989586621680047748"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680047748"><span class="hs-identifier hs-var">prec</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span id="local-6989586621680047754"><span class="annot"><span class="annottext">f b a
</span><a href="#local-6989586621680047754"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-117"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; ShowS -&gt; ShowS
</span><span class="hs-identifier hs-var">showParen</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680047748"><span class="hs-identifier hs-var">prec</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ShowS
</span><span class="hs-identifier hs-var">showString</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;HideEffects&quot;</span></span><span> </span><span class="annot"><span class="annottext">ShowS -&gt; ShowS -&gt; ShowS
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; ShowS
</span><span class="hs-identifier hs-var">showChar</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">' '</span></span><span> </span><span class="annot"><span class="annottext">ShowS -&gt; ShowS -&gt; ShowS
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; f b a -&gt; ShowS
forall a. Show a =&gt; Int -&gt; a -&gt; ShowS
</span><span class="hs-identifier hs-var">showsPrec</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">11</span></span><span> </span><span class="annot"><span class="annottext">f b a
</span><a href="#local-6989586621680047754"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680047543"><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047542"><span class="annot"><a href="#local-6989586621680047542"><span class="hs-identifier hs-type">es</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GEq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680047543"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047542"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GEq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047543"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-120"></span><span>    </span><span id="local-6989586621680047761"><span class="annot"><span class="annottext">geq :: forall a b. HideEffects f a -&gt; HideEffects f b -&gt; Maybe (a :~: b)
</span><span class="hs-identifier hs-var hs-var hs-var">geq</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680047762"><span id="local-6989586621680047763"><span id="local-6989586621680047764"><span class="annot"><span class="annottext">f b a
</span><a href="#local-6989586621680047764"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680047543"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047762"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047763"><span class="hs-identifier hs-type">a</span></a></span></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680047766"><span id="local-6989586621680047767"><span id="local-6989586621680047768"><span class="annot"><span class="annottext">f b b
</span><a href="#local-6989586621680047768"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680047543"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047766"><span class="hs-identifier hs-type">fs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047767"><span class="hs-identifier hs-type">b</span></a></span></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-121"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">f b a -&gt; f b b -&gt; Maybe (a :~: b)
forall a b. f b a -&gt; f b b -&gt; Maybe (a :~: b)
forall k (f :: k -&gt; *) (a :: k) (b :: k).
GEq f =&gt;
f a -&gt; f b -&gt; Maybe (a :~: b)
</span><span class="hs-identifier hs-var">geq</span></span><span> </span><span class="annot"><span class="annottext">f b a
</span><a href="#local-6989586621680047764"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f b b -&gt; f b b
forall a b. a -&gt; b
</span><span class="hs-identifier hs-var">unsafeCoerce</span></span><span> </span><span class="annot"><span class="annottext">f b b
</span><a href="#local-6989586621680047768"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680047543"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047762"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047767"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-122"></span><span>            </span><span class="annot"><span class="annottext">Maybe (a :~: b)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (a :~: b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-123"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">a :~: b
</span><span class="hs-identifier hs-var">Refl</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(a :~: b) -&gt; Maybe (a :~: b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a :~: a
a :~: b
forall {k} (a :: k). a :~: a
</span><span class="hs-identifier hs-var">Refl</span></span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680047557"><span id="local-6989586621680047558"><span id="local-6989586621680047774"><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047555"><span class="annot"><a href="#local-6989586621680047555"><span class="hs-identifier hs-type">es</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680047557"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047555"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047558"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047557"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047558"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-126"></span><span>    </span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span id="local-6989586621680047781"><span class="annot"><span class="annottext">f b a
</span><a href="#local-6989586621680047781"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680047782"><span class="annot"><span class="annottext">== :: HideEffects f a -&gt; HideEffects f a -&gt; Bool
</span><span class="hs-operator hs-var hs-var hs-var">==</span></span></span><span> </span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span id="local-6989586621680047784"><span class="annot"><span class="annottext">f b a
</span><a href="#local-6989586621680047784"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">f b a
</span><a href="#local-6989586621680047781"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">f b a -&gt; f b a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">f b a -&gt; f b a
forall a b. a -&gt; b
</span><span class="hs-identifier hs-var">unsafeCoerce</span></span><span> </span><span class="annot"><span class="annottext">f b a
</span><a href="#local-6989586621680047784"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680047564"><span id="local-6989586621680047565"><span id="local-6989586621680047791"><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047563"><span class="annot"><a href="#local-6989586621680047563"><span class="hs-identifier hs-type">es</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680047564"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047563"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047565"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047564"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047565"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-129"></span><span>    </span><span id="local-6989586621680047796"><span class="annot"><span class="annottext">hashWithSalt :: Int -&gt; HideEffects f a -&gt; Int
</span><a href="#local-6989586621680047796"><span class="hs-identifier hs-var hs-var hs-var">hashWithSalt</span></a></span></span><span> </span><span id="local-6989586621680047798"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680047798"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rock.html#HideEffects"><span class="hs-identifier hs-type">HideEffects</span></a></span><span> </span><span id="local-6989586621680047800"><span class="annot"><span class="annottext">f b a
</span><a href="#local-6989586621680047800"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; f b a -&gt; Int
forall a. Hashable a =&gt; Int -&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">hashWithSalt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680047798"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f b a
</span><a href="#local-6989586621680047800"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680047573"><span id="local-6989586621680047808"><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680047569"><span class="annot"><a href="#local-6989586621680047569"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680047573"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680047569"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GEq</span></span><span> </span><span class="annot"><a href="#local-6989586621680047573"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Some</span></span><span> </span><span class="annot"><a href="#local-6989586621680047573"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-132"></span><span>    </span><span id="local-6989586621680047812"><span class="annot"><span class="annottext">hashWithSalt :: Int -&gt; Some f -&gt; Int
</span><span class="hs-identifier hs-var hs-var hs-var">hashWithSalt</span></span></span><span> </span><span id="local-6989586621680047813"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680047813"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Some</span></span><span> </span><span id="local-6989586621680047816"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621680047816"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; f a -&gt; Int
forall a. Hashable a =&gt; Int -&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">hashWithSalt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680047813"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621680047816"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-133"></span></pre></body></html>