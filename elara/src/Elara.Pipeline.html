<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE PolyKinds #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="annot"><span class="hs-comment">{- | Each stage of AST processing can be interpreted as part of an overall pipeline of effects in the 'Sem' monad.
This acts as the entrypoint to the stage, bringing each stage into a common abstraction
-}</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Elara.Pipeline.html"><span class="hs-identifier">Elara.Pipeline</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Colog.Core</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">LogAction</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.IO</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Effectful</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Eff</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">IOE</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(:&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Effectful.Colog</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Log</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">runLogAction</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Elara.Data.Pretty.html"><span class="hs-identifier">Elara.Data.Pretty</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Print.html"><span class="hs-identifier">Print</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Print.html#printPretty"><span class="hs-identifier">printPretty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO</span></span><span> </span><span class="hs-keyword">qualified</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-comment">-- Create a co-log LogAction that prints to stdout and appends to a log file.</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- Returns an IO action that constructs the LogAction so callers (e.g. `Main`) can</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- pass it into `runLogAction` from `Effectful.Colog`.</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- An Effectful interpreter for the `Log (Doc AnsiStyle)` effect which</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- writes prettified, annotated output to stdout and appends an unannotated</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- textual form to `elara.log`.</span><span>
</span><span id="line-25"></span><span id="local-6989586621680149622"><span id="local-6989586621680149627"><span class="annot"><a href="Elara.Pipeline.html#runLogToStdoutAndFile"><span class="hs-identifier hs-type">runLogToStdoutAndFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IOE</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680149622"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Log</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Doc</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnsiStyle</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621680149622"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680149627"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680149622"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680149627"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-26"></span><span id="runLogToStdoutAndFile"><span class="annot"><span class="annottext">runLogToStdoutAndFile :: forall (es :: [Effect]) a.
(IOE :&gt; es) =&gt;
Eff (Log (Doc AnsiStyle) : es) a -&gt; Eff es a
</span><a href="Elara.Pipeline.html#runLogToStdoutAndFile"><span class="hs-identifier hs-var hs-var">runLogToStdoutAndFile</span></a></span></span><span> </span><span id="local-6989586621680149686"><span class="annot"><span class="annottext">Eff (Log (Doc AnsiStyle) : es) a
</span><a href="#local-6989586621680149686"><span class="hs-identifier hs-var">eff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-comment">-- reset log file</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; Eff es ()
forall a. IO a -&gt; Eff es a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Eff es ()) -&gt; IO () -&gt; Eff es ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Text -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; FilePath -&gt; Text -&gt; m ()
</span><span class="hs-identifier hs-var">writeFileText</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;elara.log&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-29"></span><span>    </span><span id="local-6989586621680149689"><span class="annot"><a href="#local-6989586621680149689"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Handle -&gt; Eff es Handle
forall a. IO a -&gt; Eff es a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Handle -&gt; Eff es Handle) -&gt; IO Handle -&gt; Eff es Handle
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IOMode -&gt; IO Handle
</span><span class="hs-identifier hs-var">System.IO.openFile</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;elara.log&quot;</span></span><span> </span><span class="annot"><span class="annottext">IOMode
</span><span class="hs-identifier hs-var">WriteMode</span></span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">hSetBuffering</span></span><span> </span><span class="annot"><a href="#local-6989586621680149689"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">System.IO.LineBuffering</span></span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680149694"><span class="annot"><a href="#local-6989586621680149694"><span class="hs-identifier hs-var hs-var">la</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-32"></span><span>            </span><span class="annot"><span class="annottext">(Doc AnsiStyle -&gt; Eff es ()) -&gt; LogAction (Eff es) (Doc AnsiStyle)
forall (m :: * -&gt; *) msg. (msg -&gt; m ()) -&gt; LogAction m msg
</span><span class="hs-identifier hs-var">LogAction</span></span><span>
</span><span id="line-33"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680149696"><span class="annot"><span class="annottext">Doc AnsiStyle
</span><a href="#local-6989586621680149696"><span class="hs-identifier hs-var">doc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-34"></span><span>                    </span><span class="annot"><span class="annottext">IO () -&gt; Eff es ()
forall a. IO a -&gt; Eff es a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Eff es ()) -&gt; IO () -&gt; Eff es ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc AnsiStyle -&gt; IO ()
forall a (m :: * -&gt; *). (Pretty a, MonadIO m) =&gt; a -&gt; m ()
</span><a href="Print.html#printPretty"><span class="hs-identifier hs-var">printPretty</span></a></span><span> </span><span class="annot"><span class="annottext">Doc AnsiStyle
</span><a href="#local-6989586621680149696"><span class="hs-identifier hs-var">doc</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; Text -&gt; IO ()
</span><span class="hs-identifier hs-var">Text.hPutStrLn</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621680149689"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Doc AnsiStyle -&gt; Text
forall a. Pretty a =&gt; a -&gt; Text
</span><a href="Elara.Data.Pretty.html#prettyToUnannotatedText"><span class="hs-identifier hs-var">prettyToUnannotatedText</span></a></span><span> </span><span class="annot"><span class="annottext">Doc AnsiStyle
</span><a href="#local-6989586621680149696"><span class="hs-identifier hs-var">doc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">runLogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621680149694"><span class="hs-identifier hs-type">la</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680149686"><span class="hs-identifier hs-type">eff</span></a></span><span>
</span><span id="line-37"></span></pre></body></html>